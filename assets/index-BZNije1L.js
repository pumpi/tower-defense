var Nt=Object.defineProperty;var Vt=(i,t,e)=>t in i?Nt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var H=(i,t,e)=>Vt(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();let Y=null;const F={init:i=>{Y=i},sortEntity:i=>[...i].sort((t,e)=>t.zIndex-e.zIndex||t.y-e.y),createImage:(i,t=[])=>{const e=new Image;return e.src=i,e.sprites=t,e},drawSprite:(i,t,e,s,r,n)=>{let o=i.sprites[t];Y.ctx.drawImage(i,o.x,o.y,r,n,e-o.w/2,s-o.h/2,o.w,o.h)},drawAnimatedSprite:(i,t,e,s,r,n,o)=>{let a=i.sprites[t];Y.ctx.drawImage(i,a.frames[parseInt(e)],a.y,n,o,s-a.w/2,r-a.h/2,a.w,a.h)},playAudio:i=>{if(Y.stat("soundEnabled")){const t=new Audio(i);t.volume=.3,t.play().catch(()=>{})}}},Gt="/tower-defense/assets/laser-DtsNZ3_M.png",zt="data:audio/mpeg;base64,//OEZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAQAAALKAACAgICAgIUFBQUFBQ1NTU1NTVQUFBQUFBgYGBgYGBgd3d3d3d3iIiIiIiImpqampqarKysrKysrL29vb29vc3Nzc3Nzd3d3d3d3evr6+vr6+v7+/v7+/v9/f39/f3///////8AAAA5TEFNRTMuOTlyAm4AAAAALhcAABRGJAQ4TgAARgAACyjcZAMBAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAKAAAAAAA0gBQAAAABBy//OERAMJxhMTf8CcARKELhyngVAACBAIBGIAHIAGAoAH1pVkhv9r/9/+/0//+Y399re3///6MQ//+2/40IENv/////6f7q7qTG4o///////wkGhY8blyBY4SGQwmUIAGEAAAAce//////////5mg8b//M2///+uSZ3///4qEhJZnYzf/////+yz7EhUbiLCp///7N///gWCILHiLJiQsRCwqEgti4WAQCpOqB0B2CICEBjBS0HI5HA4HAzmPO7kB//O0ZBUcsdttj8PQgRoa+t8fgjoidigsGQP5BETcuIm/pvLiDoHv6ajTTTTTy4tNjM3dnrdI0TdaaDTTvukTBOEMJxhyzMrkaGRxOYXMDZHGNNBkFm7oMwlMiY8Dlk0TyJfOjoHgkCPHGLPHe4Awwdp8QEf01M2ggbrcmDQniirSEIQsrAYDjoRE9iUgbEAKBBrkmFpgrgNjgARMEhxogbvQpoIbJnjctuf1HC9/gFKAMoiA1B4BQwBhCADRwG24GIJAbzQB6lAH4RAZs2H4BuwMidAzIEDAgRQQdJ2Y3Q2udOs/4hB4B5CJCHCGBm/WQgEAQZAyKEGz3G3YOblCx57meagkEj0ZP7HzJZz1OIGDjGAIFoSALF99DOyun607P8wxl/s21m1P1PJjhB1PH/1fn+lf+7oyNcyYr1e6TFv4kmiUNCJh/A/Y5O+/0XeH//OkZAIWwMVvfu1wAQ0owuMRymAAhb9/CAAgaimc2Cfl8sbZ0Giwa9DWS3xEtNaTUAFQKFxmVZrTYCLveFBhnmxthxpbYmOMclEx+DTAwaCAKYNF5mM2jrOMTXE9uPz79DNrO4x6LTRgcNNj8zcSjMJrM7GozOGTQotMtBUzeiBwCl2ENgoFRGDDBYEMHiYwWCzFAPqO9SynCajNI1qBpTGZbhKpTZyy3S0tnHLLL8u///lulltLS2QWBoGqwaK4mDv89//1ChCYkACTSYmcAf/9Uqep7oAoAwBUBsC8ac04Wo0R+4PgHwQBMGgVhQLyaSUI/MiQeSPUkyTOoOq1rMJJVwp7Fe5yYpaaXI8K8MLFxE9HTGJr4aApQxMaLIrK//N0ZCIPeKNY92zDkg2AUtLeA8QSQDJhONEbkEwA12VVmBKXSmDG2QStLXrKqa8eZNme1aC5zYNYayZtONfPr1AgfAi24EbBxqjWAgkDgc2oCFCmnjgnB0XvQFE4b3Ee99ZF3qh4OnXHmiv+hv+0IVUMa05LZKLvJMn+XNYjhmF9FjHIvl9PYTET4ceImz3E2rgX/kw8n/AbFlr2M/9P+x/p//+qhBAC//OUZAMQ1RtNF2WCXg4oMr5eBhgGxACWy+rbaWv8LAKCA4AtQTTEGZnFgKliWKwS1i0TmVz9ZqtXN0aeaXXWzel8nL3cymdM06ZpVtHEIAHwZCCYE76rXWlvfVbVpc8yg7vyEUWE1ixB5gooGxUOJR/8vUoUpSlKWrXBPBY86hodCS9S2oZ6nEzOkKHg0zDUIenqA6xY9ktArQCjzjklAApUbzGdp7JHHFpnEIwEeeRO8sPGBnpe+Tn2CYJ52SlTqgaug+h9B9AMioVDLfIw12rqwAGOSQEGbl+WCCBhigAWIicnuHFmHevAqOhsImz+//N0ZB4MoNVRO2DDOg6I8ppewERUCgoTwtvBkGACSfMlOesAQFY3Sju5nUjl/mR/Yaw117apZ2HrP/scSz2+z9whVQqDQ4OiFeRLDwndrcFQ13JlioKr1u/9NpXUgW52yRD/Aa3ACmBNVZLIHKtCEEtZhOss38h/zOGAje6oRGIEWRY/1u6R3/9/5R6kUlyjbsKu1f/0VTgAAbSoy2XiMlcH8JrVx1dn//OEZBEQUK82O2smHg2hZrZeakTGALJn+hmSRa3nN77jT5Z0bN0N2TBBLLVTT7SVBXViTvQ9S3q2UAiD68Jw7HAwMRgBJORUDBTJd/3ja3/93kpMGNkiGVplQVcEwmLHkLcSEvFDRFpVQVUwWArtgNQVUHR508DX5YGndwieJTpU6RER78FaCwLrRJsP+AsyAdjpuvf/73OsD6MShYmRInUv//XqUpW/7shf9gZIEKcK7//6n+kcWkdS9buPDIC1//OEZAMOvUseBnRipo3BGjwQ0YRUQqB5hGmZr3GxrKGJjQQ5iIDwQDbs7jaqjE0cXQWM/W2VO2oDAj/O0oE/UHqZP3AmETjU7hT37FrG4+ywyxotjrNGU3EUCIzi5symG2at/Y6hgQMSGsM885aStY3KwNzLX63QwZ0LUtWthhSlIb//6kSGGrDHYGNaKMr1MO6Eha4KOHScmo1TZJTkWc1EGSEmVOwdnmdgwEBAT/oqM/09SoKB1+aCgl//W14I//N0ZAEKqIsUG3UjRg3QghgI5swIrJNxnJgoPhyFrB4syJlsAJgYE5g8C6YLBonBytzrPwzYS+ChMmzk60ZJrSCx9CgEylrS/nr+pVc1KdPaiZ6lOvYv/b6bP//0dzPT6K/9f19lLtOGysSMEC04edz4yo0ZNAwgTAbBXhhWsEzAocdTEtfP6o1FkpET4a+qz30f//R/VR///9P6NH//uqpMLfBQFZgT//N0ZAcLjB0IGXusAgsIKhAA5gAEF4GcaouejAUYmh6YgA+klKF3hONg5ND4HXA1Pg8F1ok6LWOsa0h3rMaNK+NySVEZ5tjGb1QudJVK91rb2gZ6x1S5FjV12ta3j6A7PJ9Z5LyCWcUUwaKgAwcRjpgaAZEMoffndk6SmLvr+hWr6On7F/qV7E7P9/r/u1+ncx9uv0/+mjAQPjMLdD4cuQp3MFEM2BLy//N0ZBELIBsEAHdJAg1IHhWK0wIAJjsQAwTuiKkQEsBiwkCYTO4pfU+qFUJe/RyWzbvIKQ5rmKoYSbLvS6kXtKLpHstMpxJFWNo65BusmpceNidUxeQiRpHX2pHIAngbj3tNzqNsYBcRYDYhrX1139dPv6/ra2nt9tn1erd8JWXu7OiNf9nuyjNqiN+t9O5f/VRVAGvAAzIuHk5xnakBx1+RcQLBB9jF//NkZBUHZBEMum8iABIYGggAy8YAc1v0r4/M6uz9Hp7NUf0+jf9ze1VlvYuGnWT/e7rdYtO3+ggiqaUsQ5EZWHNeMla+ijpPJehh9q3W1QAaYYoPoFkN3rmBzr6KW3LewYzOWvkNVNDAvaOFBDkgZqkNr0i456dqYu/FkWGp8GeBRX6lGIk85KLIoEFKgmmo//N0ZAwJiHkCAW8DAA8AOgwMwEYARBaOb5hwZBr4CEEyCSLQy/q51nKqft3L8EBXJCQVjB4S0FQEs80RT1bXnVuuhq6Gklr5KItGu+z/p//3/Xnf+0IzEpAwb/hCSnNzMICAnCxoESAfMoEdMq4rhNyFH6nrUBTyuwrKvh3Gd318r6Kv1W6Oe066Xf//orur+pUwUKVMQU1FMy45OS41VVVVVVVVVVVV//MUZBYAMAMkAARDAIBAAjQAEMABVVVV//MUZBYAAAB+AAAAAAAAAAAAAAAAVVVV",g={playersLive:10,coins:280,game:{soundEnabled:!0,showNormalDamage:!0},towers:{laser:{label:"Laser Turm",costs:80,color:"#ffff03",size:20,fireRange:110,damage:{from:3,to:4},coolDownTime:.6,baseCritRate:5,baseCritDamage:1.5,images:F.createImage(Gt,[{x:0,y:0,w:80,h:80},{x:0,y:160,w:80,h:80},{x:0,y:320,w:80,h:80},{x:0,y:480,w:80,h:80},{x:0,y:640,w:80,h:80},{x:0,y:800,w:80,h:80}]),audio:zt,upgrades:[{cost:70,fireRange:120,damage:{from:6,to:8},color:"#2CE85B",critRate:2,critDamage:.1},{cost:180,fireRange:130,damage:{from:10,to:14},color:"#2CE8B9",critRate:3,critDamage:.2},{cost:250,fireRange:140,damage:{from:18,to:25},color:"#2A62DB",critRate:5,critDamage:.2}]},gravity:{label:"Schwerkraft Generator",costs:100,color:"#9C27B0",size:20,fireRange:140,slowEffect:.5,upgrades:[{cost:80,fireRange:160,slowEffect:.6,color:"#7B1FA2"},{cost:150,fireRange:180,slowEffect:.7,color:"#6A1B9A"},{cost:220,fireRange:200,slowEffect:.8,color:"#4A148C"}]},flamethrower:{label:"Flammenwerfer",costs:120,color:"#FF6600",size:20,fireRange:100,coneAngle:60,damage:{from:2,to:4},dotDamage:{from:1,to:2},dotDuration:3,dotTickRate:.5,dotType:"burning",coolDownTime:.8,baseCritRate:0,baseCritDamage:1,upgrades:[{cost:100,fireRange:110,coneAngle:70,damage:{from:3,to:5},dotDamage:{from:2,to:3},dotDuration:3.5,color:"#FF5500",critRate:0,critDamage:0},{cost:200,fireRange:120,coneAngle:80,damage:{from:5,to:8},dotDamage:{from:3,to:5},dotDuration:4,color:"#FF4400",critRate:0,critDamage:0},{cost:300,fireRange:130,coneAngle:90,damage:{from:7,to:12},dotDamage:{from:5,to:7},dotDuration:5,color:"#FF0000",critRate:0,critDamage:0}]},tesla:{label:"Tesla Turm",costs:120,color:"#00FFFF",size:20,fireRange:120,damage:{from:12,to:17},coolDownTime:4.2,baseCritRate:5,baseCritDamage:1.8,maxChains:3,chainRange:80,chainDamageMultipliers:[1,.7,.5,.3],upgrades:[{cost:100,fireRange:120,damage:{from:15,to:19},chainRange:90,color:"#00CCCC",critRate:3,critDamage:.2},{cost:140,fireRange:150,damage:{from:18,to:23},chainRange:90,color:"#0099CC",critRate:4,critDamage:.3},{cost:200,fireRange:175,damage:{from:22,to:30},chainRange:100,color:"#0066CC",critRate:5,critDamage:.4}]},plasma:{label:"Plasma Kanone",costs:150,color:"#00ff48",size:20,minRange:80,fireRange:200,explosionRadius:80,projectileSpeed:180,arcHeight:80,damage:{from:15,to:20},coolDownTime:6,baseCritRate:3,baseCritDamage:1.5,upgrades:[{cost:140,fireRange:240,explosionRadius:90,damage:{from:18,to:25},color:"#2aa127",critRate:2,critDamage:.2},{cost:220,fireRange:280,explosionRadius:100,damage:{from:22,to:28},color:"#21871e",critRate:3,critDamage:.2},{cost:320,fireRange:310,explosionRadius:110,damage:{from:26,to:38},color:"#064e03",critRate:5,critDamage:.3}]}},mapGrid:80,leveling:{wavesPerLevel:10,healthFactor:1.4,speedFactor:1.05,rewardFactor:1.2,waveGeneration:{minThreat:30,maxThreat:180,threatFactor:1.2}},enemyTypes:{wisp:{graphic:"wisp",baseHealth:45,baseSpeed:50,baseReward:5,baseCritResistance:5,levelFactors:{health:1.6,speed:1.1,critResistanceFactor:1.1}},bug:{graphic:"bug",baseHealth:35,baseSpeed:90,baseReward:4,baseCritResistance:2,levelFactors:{health:1.5,speed:1.2,critResistanceFactor:1.1}},slime:{color:"#8A2BE2",baseHealth:200,baseSpeed:30,baseReward:10,baseCritResistance:0,levelFactors:{health:1.8,speed:1,critResistanceFactor:1.05}},scout:{color:"#FFD700",baseHealth:22,baseSpeed:160,baseReward:3,baseCritResistance:10,levelFactors:{health:1.3,speed:1.05,critResistanceFactor:1.2}},boss:{graphic:"wisp",color:"black",baseHealth:900,baseSpeed:40,baseReward:100,baseCritResistance:50,levelFactors:{health:2.5,speed:1.1,critResistanceFactor:1.4}}},waveFragments:{line_of_wisps:{threat:25,details:{enemyType:"wisp",count:8,spacing:2,countFactor:1.3}},lone_slime:{threat:20,details:{enemyType:"slime",count:1,spacing:2,countFactor:1.1}},rush_of_bugs:{threat:30,details:{enemyType:"bug",count:7,spacing:2.5,countFactor:1.4}},pair_of_slimes:{threat:35,details:{enemyType:"slime",count:2,spacing:3,countFactor:1.3}},scout_rush:{threat:35,details:{enemyType:"scout",count:10,spacing:2,countFactor:2.5}},mixed_pair:{threat:60,details:[{enemyType:"wisp",count:8,spacing:2,countFactor:1.8},{enemyType:"bug",count:8,spacing:3,countFactor:1.8}]}},fillUpFragments:{fill_up_wisps:{threat:4,details:{enemyType:"wisp",count:2,spacing:2,countFactor:1.3}},fill_up_bugs:{threat:5,details:{enemyType:"bug",count:2,spacing:2.5,countFactor:1.3}},fill_up_scouts:{threat:6,details:{enemyType:"scout",count:3,spacing:3,countFactor:1.8}}},bossWaveTemplate:[{enemyType:"boss",count:1,spacing:0}]};class Kt{constructor(t){this.game=t,this.panel=null}init(){this.panel=document.createElement("div"),this.panel.style.position="absolute",this.panel.style.top="10px",this.panel.style.right="10px",this.panel.style.width="300px",this.panel.style.maxHeight="90vh",this.panel.style.overflowY="auto",this.panel.style.background="rgba(0,0,0,0.75)",this.panel.style.color="white",this.panel.style.padding="10px",this.panel.style.fontFamily="monospace",this.panel.style.fontSize="12px",this.panel.style.zIndex="1000",document.body.appendChild(this.panel),this.game.on("update",()=>this.update())}update(){if(!this.panel)return;const t=Object.values(this.game.mapEntities.list).filter(a=>a.type==="tower"),e=this.game.enemies.enemiesList,s=t.map(a=>`<li>LvL ${a.level+1} ${a.bullet} (${a.stats.kills} kills, ${a.stats.crits} crits)</li>`).join(""),r=e.map(a=>`<li>LvL ${a.level} ${a.enemyType} | HP: ${Math.round(a.health)}/${Math.round(a.maxHealth)}</li>`).join(""),o=(this.game.lastWaveTemplate||[]).map(a=>`<li>${a.name} - ${a.count}x Lvl ${a.level} ${a.enemyType} (${a.threat})</li>`).join("");this.panel.innerHTML=`
            <h3>Debug Info</h3>
            <p><strong>Game Mode:</strong> ${this.game.stat("mode")||"normal"}</p>
            <p><strong>Wave:</strong> ${this.game.stat("wave")}</p>
            <p><strong>Game Level:</strong> ${Math.floor(((this.game.waveCounter||1)-1)/g.leveling.wavesPerLevel)+1}</p>
            <p><strong>Wave Threat:</strong> ${Math.round(this.game.lastWaveCurrentThreat||0)} / ${Math.round(this.game.lastWaveMaxThreat||0)}</p>
            <hr>
            <h4>Towers (${t.length})</h4>
            <ul>${s||"<li>None</li>"}</ul>
            <hr>
            <h4>Enemies (${e.length})</h4>
            <ul>${r||"<li>None</li>"}</ul>
            <hr>
            <h4>Last Wave Composition</h4>
            <ul>${o||"<li>N/A</li>"}</ul>
        `}}const Ut="/tower-defense/assets/backlayer-CBCCWrSs.png",jt="/tower-defense/assets/frontlayer-BiJAsHOn.png";class Qt{constructor(t,e){this.game=t,this.mapEntities=e,this.waypoints=[{x:0,y:120},{x:120,y:120},{x:120,y:360},{x:360,y:360},{x:360,y:200},{x:520,y:200},{x:520,y:520},{x:680,y:520},{x:680,y:280},{x:800,y:280},{x:920,y:280},{x:920,y:200},{x:1200,y:200}],this.images={background:F.createImage(Ut),frontLayer:F.createImage(jt)},this.game.on("update",()=>this.update()),this.game.on("beforeDraw",()=>this.beforeDraw()),this.game.on("afterDraw",()=>this.afterDraw())}update(){}beforeDraw(){this.game.ctx.drawImage(this.images.background,0,0,this.game.canvas.width,this.game.canvas.height),this.grid(g.mapGrid)}afterDraw(){this.game.ctx.drawImage(this.images.frontLayer,0,0,this.game.canvas.width,this.game.canvas.height)}isValidTowerPlace(t,e){const s=this.distanceToPath(t,e);return s<=g.mapGrid/2||this.isTowerAtPosition(t,e)?!1:s<=Math.sqrt(2)*g.mapGrid}distanceToPath(t,e){return this.getClosestPointOnPath(t,e).distance}getClosestPointOnPath(t,e){let s=1/0,r=null;for(let n=0;n<this.waypoints.length-1;n++){const o=this.waypoints[n].x,a=this.waypoints[n].y,l=this.waypoints[n+1].x,c=this.waypoints[n+1].y,d=l-o,h=c-a,u=d*d+h*h;let b=((t-o)*d+(e-a)*h)/u;b=Math.max(0,Math.min(1,b));const p=o+b*d,m=a+b*h,w=this.game.distance(t,e,p,m);w<s&&(s=w,r={x:p,y:m})}return{x:(r==null?void 0:r.x)??this.waypoints[0].x,y:(r==null?void 0:r.y)??this.waypoints[0].y,distance:s}}isTowerAtPosition(t,e){for(let s in this.mapEntities.list){let r=this.mapEntities.list[s];if(r.type==="tower"&&r.x===t&&r.y===e)return!0}return!1}grid(t){this.game.ctx.beginPath(),this.game.ctx.strokeStyle="#ffffff22",this.game.ctx.lineWidth=1;for(let e=t;e<this.game.canvas.height;e+=t)this.game.ctx.moveTo(0,e),this.game.ctx.lineTo(this.game.canvas.width,e);for(let e=t;e<this.game.canvas.width;e+=t)this.game.ctx.moveTo(e,0),this.game.ctx.lineTo(e,this.game.canvas.height);this.game.ctx.stroke()}}class Yt{constructor(t){this.game=t,this.list={},this.idCounter=0,this.game.on("update",e=>this.update(e)),this.game.on("beforeDraw",()=>this.draw())}add(t){const e=++this.idCounter;return t.id=e,this.list[e]=t,t}remove(t){this.list[t]&&delete this.list[t]}update(t){const e=Object.keys(this.list);for(const s of e){const r=this.list[s];r&&r.update(t)}}draw(){for(const t in this.list)this.game.drawList.push(this.list[t])}}class Wt{constructor(t){this.game=t,this.x=0,this.y=0,this.clicked=!1,this.game.canvas.addEventListener("mousemove",e=>this.onMove(e)),this.game.canvas.addEventListener("click",e=>this.onClick(e)),this.game.canvas.addEventListener("touchstart",e=>this.onTouchStart(e),{passive:!1}),this.game.canvas.addEventListener("touchmove",e=>this.onTouchMove(e),{passive:!1})}update(){this.clicked=!1}onMove(t){this.updatePosition(t.clientX,t.clientY)}onClick(){this.clicked=!0}onTouchStart(t){if(t.preventDefault(),this.clicked=!0,t.touches.length>0){const e=t.touches[0];this.updatePosition(e.clientX,e.clientY)}}onTouchMove(t){if(t.preventDefault(),t.touches.length>0){const e=t.touches[0];this.updatePosition(e.clientX,e.clientY)}}updatePosition(t,e){const s=this.game.canvas.getBoundingClientRect(),r=this.game.canvas.width/s.width,n=this.game.canvas.height/s.height;this.x=(t-s.left)*r,this.y=(e-s.top)*n}isMouseOver(t,e,s){return Math.round(Math.sqrt(Math.pow(this.x-t,2)+Math.pow(this.y-e,2)))<=s}}class K{constructor(t,e,s,r,n){this.game=t,this.type="entity",this.x=e,this.y=s,this.r=r,this.color=n,this.zIndex=0}update(t){}draw(){this.game.drawer.circle(this.x,this.y,this.r,this.color,!0)}remove(){this.game.mapEntities.remove(this.id)}}class qt extends K{constructor(t,e){super(e,0,0,0,"transparent"),this.target=t,this.type="healthbar",this.zIndex=15}update(){if(this.target.deleted){this.game.mapEntities.remove(this.id);return}this.x=this.target.x,this.y=this.target.y}draw(){const t=this.target.health/this.target.maxHealth;if(t<1){const e={x:this.x-this.target.r,y:this.y-this.target.r-8,width:this.target.r*2,height:4};this.game.ctx.fillStyle="black",this.game.ctx.fillRect(e.x,e.y,e.width,e.height),this.game.ctx.fillStyle="green",this.game.ctx.fillRect(e.x,e.y,e.width*t,e.height)}}}class Zt extends K{constructor(t,e,s,r,n,o){super(o,e,s,0,"transparent"),this.text=t,this.damageType=r,this.isCrit=r==="crit",this.floatDirection=n||-1,this.type="damagenumber",this.zIndex=20,this.lifetime=1,this.opacity=1,this.verticalSpeed=30}update(t){if(this.lifetime-=t,this.lifetime<=0){this.game.mapEntities.remove(this.id);return}this.y+=this.verticalSpeed*this.floatDirection*t,this.opacity=this.lifetime}draw(){const t=this.game.ctx;t.save();let e,s;switch(this.damageType){case"crit":e="bold 18px sans-serif",s=`rgba(255, 0, 0, ${this.opacity})`;break;case"dot":e="italic 14px sans-serif",s=`rgba(255, 140, 0, ${this.opacity})`;break;default:e="normal 14px sans-serif",s=`rgba(255, 255, 255, ${this.opacity})`;break}t.font=e,t.textAlign="center",t.strokeStyle=`rgba(0, 0, 0, ${this.opacity})`,t.lineWidth=3,t.strokeText(this.text,this.x,this.y),t.fillStyle=s,t.fillText(this.text,this.x,this.y),t.restore()}}class Jt extends K{constructor(t,e,s,r){var b,p,m,w;const n=g.enemyTypes[t];if(!n){console.error(`Enemy type "${t}" not found in settings.enemyTypes`);return}const o=n.color||"red";super(r.game,0,0,10,o),this.enemiesController=r,this.type="enemy",this.enemyType=t;const a=e>0?e-1:0,l=((b=n.levelFactors)==null?void 0:b.health)??g.leveling.healthFactor,c=((p=n.levelFactors)==null?void 0:p.speed)??g.leveling.speedFactor,d=((m=n.levelFactors)==null?void 0:m.reward)??g.leveling.rewardFactor,h=((w=n.levelFactors)==null?void 0:w.critResistanceFactor)??1.1;this.health=n.baseHealth*Math.pow(l,a),this.maxHealth=this.health,this.speed=n.baseSpeed*Math.pow(c,a),this.reward=Math.round(n.baseReward*Math.pow(d,a)),this.critResistance=n.baseCritResistance*Math.pow(h,a),this.graphicType=n.graphic,this.level=e,this.wave=s;const u=Math.round(Math.random()*40)-10;this.waypointIndex=0,this.waypoint={},this.shift=u,this.velocity={x:0,y:0},this.direction=0,this.frame=0,this.deleted=!1,this.zIndex=5,this.enemiesController.mapEntities.add(this),this.enemiesController.mapEntities.add(new qt(this,this.enemiesController.game)),this.nextWaypoint()}nextWaypoint(){const t=this.enemiesController.map;this.waypoint.x||(this.waypoint={...t.waypoints[this.waypointIndex]},this.waypoint.x+=this.shift,this.waypoint.y+=this.shift,this.x=this.waypoint.x,this.y=this.waypoint.y);let e=this.waypoint.x,s=this.waypoint.y;return this.waypointIndex++,t.waypoints[this.waypointIndex]?(this.waypoint={...t.waypoints[this.waypointIndex]},this.waypoint.x+=this.shift,this.waypoint.y+=this.shift,this.velocity.x=this.x<this.waypoint.x?this.speed:-this.speed,e===this.waypoint.x&&(this.velocity.x=0),this.velocity.y=this.y<this.waypoint.y?this.speed:-this.speed,s===this.waypoint.y&&(this.velocity.y=0),this.velocity.y<0?this.direction=0:this.velocity.x>0?this.direction=1:this.velocity.y>0?this.direction=2:this.velocity.x<0&&(this.direction=3),!0):(this.done(),!1)}waypointReached(){return this.velocity.x>0&&this.x>=this.waypoint.x||this.velocity.x<0&&this.x<=this.waypoint.x||this.velocity.y>0&&this.y>=this.waypoint.y||this.velocity.y<0&&this.y<=this.waypoint.y}update(t){if(this.deleted)return;let e=1;if(this.slowedBy&&this.slowedBy.size>0&&(e=Math.min(...this.slowedBy.values())),this.dotEffects&&this.dotEffects.size>0){const s=[];this.dotEffects.forEach((r,n)=>{if(r.tickCounter+=t,r.remainingTime-=t,r.tickCounter>=r.tickRate){const o=Math.floor(Math.random()*(r.damage.to-r.damage.from+1))+r.damage.from;this.damage(o,"dot"),r.source&&(r.source.stats.dmg+=o,this.deleted&&r.source.stats.kills++),r.tickCounter=0}r.remainingTime<=0&&s.push(n)}),s.forEach(r=>this.dotEffects.delete(r))}if(this.waypointReached()?this.nextWaypoint():(this.x+=this.velocity.x*t*e,this.y+=this.velocity.y*t*e),this.graphicType){const s=this.enemiesController.images[this.graphicType].sprites[this.direction];s.frames&&(this.frame=(this.frame+6*t*e)%s.frames.length)}}draw(){this.graphicType?F.drawAnimatedSprite(this.enemiesController.images[this.graphicType],this.direction,this.frame,Math.round(this.x),Math.round(this.y),40,40):this.enemiesController.game.drawer.circle(this.x,this.y,this.r,this.color,!0)}damage(t,e="normal"){if(!this.deleted){if(e!=="normal"||this.enemiesController.game.stat("showNormalDamage")){const s=this.velocity.y<0?1:-1;this.enemiesController.mapEntities.add(new Zt(t,this.x,this.y-this.r,e,s,this.enemiesController.game))}this.health-=t,this.health<=0&&this.die()}}die(){this.deleted||(this.health=0,this.deleted=!0,this.game.stat("coins",this.game.stat("coins")+this.reward,!0),this.enemiesController.remove(this))}done(){if(this.deleted)return;this.deleted=!0;let t=this.game.stat("live")-1;t<=0?this.game.setGameOver():this.game.stat("live",t,!0),this.enemiesController.remove(this)}}const Xt="/tower-defense/assets/wisp-DEJtt0a3.png",te="/tower-defense/assets/bug-C3HbAPzA.png";class ee{constructor(t,e,s){this.game=t,this.map=e,this.mapEntities=s,this.images={wisp:F.createImage(Xt,[{x:0,y:0,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:40,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:80,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:120,w:20,h:20,frames:[0,40,80,120,160,200]}]),bug:F.createImage(te,[{x:0,y:0,w:20,h:20,frames:[0]},{x:40,y:0,w:20,h:20,frames:[40]},{x:80,y:0,w:20,h:20,frames:[80]},{x:120,y:0,w:20,h:20,frames:[120]}])},this.enemiesList=[]}create(t,e,s){const r=new Jt(t,e,s,this);return this.enemiesList.push(r),r}remove(t){if(!t)return;const e=this.enemiesList.indexOf(t);e>-1&&this.enemiesList.splice(e,1),this.mapEntities.remove(t.id)}}class U extends K{constructor(t,e,s,r){const n=g.towers[s];super(r.game,t,e,n.size,n.color),this.towersController=r,this.type="tower",this.towerType=s,this.fireRange=n.fireRange,this.damage=n.damage,this.cooldownTime=n.coolDownTime,this.level=0,this.audio=n.audio,this.critRate=n.baseCritRate,this.critDamage=n.baseCritDamage,this.stats={shoots:0,dmg:0,kills:0,crits:0},this.cooldownCounter=0,this.targetEnemy=null,this.targetingPriority=["most-advanced"],this.towersController.mapEntities.add(this)}upgrade(){const t=this.towersController.game,e=t.stat("coins"),s=g.towers[this.towerType].upgrades[this.level];s&&e>=s.cost&&(t.stat("coins",e-s.cost,!0),this.damage=s.damage,this.fireRange=s.fireRange,this.critRate+=s.critRate,this.critDamage+=s.critDamage,this.level++,this.color=s.color,t.modal.close())}update(t){const{game:e,mouse:s}=this.towersController;this.cooldownCounter+=t,this.targetEnemy&&(e.distance(this.x,this.y,this.targetEnemy.x,this.targetEnemy.y)>=this.fireRange+this.targetEnemy.r||this.targetEnemy.health<=0)&&(this.targetEnemy=null),this.targetEnemy||(this.targetEnemy=this.findTargetEnemy()),this.targetEnemy&&this.cooldownCounter>=this.cooldownTime&&(this.shoot(this.targetEnemy),this.cooldownCounter=0),this.zIndex=s.isMouseOver(this.x,this.y,this.r)?20:10,e.stat("mode")!=="dropTower"&&s.clicked&&s.isMouseOver(this.x,this.y,this.r)&&this.openOptions()}getEnemiesInRange(){const{game:t,enemies:e}=this.towersController;return e.enemiesList.filter(s=>t.distance(this.x,this.y,s.x,s.y)<=this.fireRange+s.r)}compareByStrategy(t,e,s){const{game:r}=this.towersController;switch(s){case"most-advanced":if(e.waypointIndex!==t.waypointIndex)return e.waypointIndex-t.waypointIndex;const n=t.waypoint?r.distance(t.x,t.y,t.waypoint.x,t.waypoint.y):1/0,o=e.waypoint?r.distance(e.x,e.y,e.waypoint.x,e.waypoint.y):1/0;return n-o;case"least-health":return t.health-e.health;case"most-health":return e.health-t.health;case"fastest":return e.speed-t.speed;case"slowest":return t.speed-e.speed;case"closest":const a=r.distance(this.x,this.y,t.x,t.y),l=r.distance(this.x,this.y,e.x,e.y);return a-l;case"prioritize-boss":const c=t.enemyType==="boss",d=e.enemyType==="boss";return c&&!d?-1:!c&&d?1:0;case"prioritize-normal":const h=t.enemyType!=="boss",u=e.enemyType!=="boss";return h&&!u?-1:!h&&u?1:0;default:return 0}}findTargetEnemy(){const t=this.getEnemiesInRange();return t.length===0?null:t.length===1?t[0]:[...t].sort((s,r)=>{for(const n of this.targetingPriority){const o=this.compareByStrategy(s,r,n);if(o!==0)return o}return 0})[0]}getStatsHTML(){return`
            <h4>Current Stats (Level ${this.level+1})</h4>
            <table class="tower-stats">
                <tr><td>Schaden:</td><td>${this.damage.from} - ${this.damage.to}</td></tr>
                <tr><td>Reichweite:</td><td>${this.fireRange}</td></tr>
                <tr><td>Feuerrate:</td><td>${this.cooldownTime}s</td></tr>
                <tr><td>Crit Chance:</td><td>${this.critRate.toFixed(0)}%</td></tr>
                <tr><td>Crit Schaden:</td><td>${this.critDamage*100}%</td></tr>
            </table>
        `}getLifetimeStatsHTML(){return`
            <h4>Lifetime Stats</h4>
            <table class="tower-stats">
                <tr><td>Schüsse:</td><td>${this.stats.shoots}</td></tr>
                <tr><td>Crits:</td><td>${this.stats.crits} (${((this.stats.crits/this.stats.shoots||0)*100).toFixed(2)}%)</td></tr>
                <tr><td>Kills:</td><td>${this.stats.kills}</td></tr>
                <tr><td>Schaden:</td><td>${this.stats.dmg}</td></tr>
            </table>
        `}getTargetingPriorityHTML(){return`
            <h4>Zielpriorität</h4>
            <p style="font-size: 12px; margin-bottom: 8px;">Wähle mehrere Strategien. Bei Gleichstand wird die nächste Strategie als Tiebreaker verwendet.</p>
            <select id="tower-targeting-priority" multiple autocomplete="off">
                <option value="most-advanced">Am weitesten fortgeschritten</option>
                <option value="least-health">Wenigsten Leben</option>
                <option value="most-health">Meisten Leben</option>
                <option value="fastest">Am schnellsten</option>
                <option value="slowest">Am langsamsten</option>
                <option value="closest">Am nächsten</option>
                <option value="prioritize-boss">Bosse bevorzugen</option>
                <option value="prioritize-normal">Normale Gegner bevorzugen</option>
            </select>
        `}getUpgradeHTML(){const t=g.towers[this.towerType].upgrades[this.level];return t?`
                <h4>Upgrade auf Level ${this.level+2}</h4>
                <table class="tower-stats">
                    <tr><td>Kosten:</td><td>${t.cost} Coins</td></tr>
                    <tr><td>Schaden:</td><td>${t.damage.from} - ${t.damage.to}</td></tr>
                    <tr><td>Reichweite:</td><td>${t.fireRange}</td></tr>
                    <tr><td>Crit Chance:</td><td>+${t.critRate}%</td></tr>
                    <tr><td>Crit Schaden:</td><td>+${t.critDamage*100}%</td></tr>
                </table>
                <button id="tower-buy-upgrade-btn" class="btn btn-buy" data-required-coins="${t.cost}">Upgrade Kaufen</button>
            `:"<h4>Max Level</h4>"}setupTargetingPriorityUI(){const t=new window.TomSelect("#tower-targeting-priority",{plugins:["drag_drop","remove_button"],persist:!1,maxItems:null,items:this.targetingPriority,onItemAdd:()=>{this.targetingPriority=t.items},onItemRemove:()=>{this.targetingPriority=t.items},onDropdownClose:()=>{this.targetingPriority=t.items}});this.towersController.game.modal.onClose(()=>{t.destroy()})}setupUpgradeUI(){const t=document.getElementById("tower-buy-upgrade-btn");t&&(t.onclick=()=>this.upgrade())}openOptions(){const t=`
            <div id="tower-stats-container">
                ${this.getStatsHTML()}
                ${this.getLifetimeStatsHTML()}
                ${this.getTargetingPriorityHTML()}
            </div>
            <div id="tower-upgrade-container">
                ${this.getUpgradeHTML()}
            </div>
        `,e=this.towersController.game;e.modal.open("Tower Options",t,e),this.setupTargetingPriorityUI(),this.setupUpgradeUI()}calculateDamage(t){let e=Math.floor(Math.random()*(this.damage.to-this.damage.from+1))+this.damage.from,s="normal";const r=(this.critRate-t.critResistance)/100,n=Math.max(.05,Math.min(r,.75));return Math.random()<n&&(e*=this.critDamage,this.stats.crits++,s="crit"),e=Math.round(e),{damage:e,damageType:s}}shoot(t){throw new Error("shoot() must be implemented by subclass")}draw(){var r;const{game:t,mouse:e}=this.towersController,s=g.towers[this.towerType];e.isMouseOver(this.x,this.y,this.r)&&t.stat("mode")!=="dropTower"&&t.drawer.circle(this.x,this.y,this.fireRange,"rgba(255, 102, 0, 0.2)",!0),(r=s.images)!=null&&r.complete?F.drawSprite(s.images,this.level,this.x,this.y-20,160,160):t.drawer.circle(this.x,this.y,this.r,this.color,!0),this.drawShootingEffect()}drawShootingEffect(){throw new Error("drawShootingEffect() must be implemented by subclass")}}class se extends U{constructor(t,e,s){super(t,e,"laser",s),this.shootingAt=null}shoot(t){const{damage:e,damageType:s}=this.calculateDamage(t);this.stats.shoots++,this.stats.dmg+=e,t.damage(e,s),t.deleted&&this.stats.kills++,F.playAudio(this.audio),this.shootingAt=t,setTimeout(()=>{this.shootingAt=null},100)}drawShootingEffect(){const{game:t}=this.towersController;this.shootingAt&&(t.ctx.save(),t.ctx.beginPath(),t.ctx.strokeStyle=this.color,t.ctx.lineWidth=2,t.ctx.moveTo(this.x,this.y-50),t.ctx.lineTo(this.shootingAt.x,this.shootingAt.y),t.ctx.stroke(),t.ctx.restore())}}class ie extends U{constructor(t,e,s){super(t,e,"gravity",s),this.slowEffect=g.towers.gravity.slowEffect,this.affectedEnemies=new Set}update(t){const{game:e,mouse:s}=this.towersController,r=this.getEnemiesInRange();r.forEach(n=>{n.slowedBy||(n.slowedBy=new Map),n.slowedBy.set(this.id,this.slowEffect),this.affectedEnemies.add(n)}),this.affectedEnemies.forEach(n=>{r.includes(n)||(n.slowedBy&&n.slowedBy.delete(this.id),this.affectedEnemies.delete(n))}),this.zIndex=s.isMouseOver(this.x,this.y,this.r)?20:10,e.stat("mode")!=="dropTower"&&s.clicked&&s.isMouseOver(this.x,this.y,this.r)&&this.openOptions()}shoot(t){}upgrade(){const t=this.towersController.game,e=t.stat("coins"),s=g.towers[this.towerType].upgrades[this.level];s&&e>=s.cost&&(t.stat("coins",e-s.cost,!0),this.slowEffect=s.slowEffect,this.fireRange=s.fireRange,this.level++,this.color=s.color,t.modal.close())}getStatsHTML(){return`
            <h4>Current Stats (Level ${this.level+1})</h4>
            <table class="tower-stats">
                <tr><td>Slow Effect:</td><td>-${Math.round((1-this.slowEffect)*100)}%</td></tr>
                <tr><td>Reichweite:</td><td>${this.fireRange}</td></tr>
            </table>
        `}getTargetingPriorityHTML(){return""}setupTargetingPriorityUI(){}getLifetimeStatsHTML(){return""}getUpgradeHTML(){const t=g.towers[this.towerType].upgrades[this.level];return t?`
                <h4>Upgrade auf Level ${this.level+2}</h4>
                <table class="tower-stats">
                    <tr><td>Kosten:</td><td>${t.cost} Coins</td></tr>
                    <tr><td>Slow Effect:</td><td>-${Math.round(t.slowEffect*100)}%</td></tr>
                    <tr><td>Reichweite:</td><td>${t.fireRange}</td></tr>
                </table>
                <button id="tower-buy-upgrade-btn" class="btn btn-buy">Upgrade Kaufen</button>
            `:"<h4>Max Level</h4>"}drawShootingEffect(){const{game:t}=this.towersController;t.ctx.save(),t.ctx.strokeStyle=this.color,t.ctx.lineWidth=1,t.ctx.globalAlpha=.3,this.affectedEnemies.forEach(e=>{t.ctx.beginPath(),t.ctx.moveTo(this.x,this.y),t.ctx.lineTo(e.x,e.y),t.ctx.stroke()}),t.ctx.restore()}}class re extends U{constructor(t,e,s){super(t,e,"flamethrower",s);const r=g.towers.flamethrower;this.coneAngle=r.coneAngle,this.dotDamage=r.dotDamage,this.dotDuration=r.dotDuration,this.dotTickRate=r.dotTickRate,this.dotType=r.dotType,this.isShooting=!1,this.shootingAngle=0,this.flameAnimationProgress=0}upgrade(){const t=this.towersController.game,e=t.stat("coins"),s=g.towers[this.towerType].upgrades[this.level];s&&e>=s.cost&&(t.stat("coins",e-s.cost,!0),this.damage=s.damage,this.fireRange=s.fireRange,this.coneAngle=s.coneAngle,this.dotDamage=s.dotDamage,this.dotDuration=s.dotDuration,this.level++,this.color=s.color,t.modal.close())}isEnemyInCone(t){const{game:e}=this.towersController;if(e.distance(this.x,this.y,t.x,t.y)>this.fireRange+t.r)return!1;let n=Math.atan2(t.y-this.y,t.x-this.x)-this.shootingAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;const o=this.coneAngle*Math.PI/180/2;return Math.abs(n)<=o}getEnemiesInCone(){return this.towersController.enemies.enemiesList.filter(t=>t.health>0&&this.isEnemyInCone(t))}shoot(t){if(!this.targetEnemy)return;const e=this.getEnemiesInCone();e.length!==0&&(e.forEach(s=>{const{damage:r,damageType:n}=this.calculateDamage(s);this.stats.shoots++,this.stats.dmg+=r,s.damage(r,n),s.deleted&&this.stats.kills++,s.dotEffects||(s.dotEffects=new Map),s.dotEffects.set(this.id,{type:this.dotType,damage:this.dotDamage,duration:this.dotDuration,tickRate:this.dotTickRate,tickCounter:0,remainingTime:this.dotDuration,source:this})}),this.isShooting=!0)}getStatsHTML(){return`
            <h4>Current Stats (Level ${this.level+1})</h4>
            <table class="tower-stats">
                <tr><td>Schaden:</td><td>${this.damage.from} - ${this.damage.to}</td></tr>
                <tr><td>DoT Schaden:</td><td>${this.dotDamage.from} - ${this.dotDamage.to} / ${this.dotTickRate}s</td></tr>
                <tr><td>DoT Dauer:</td><td>${this.dotDuration}s</td></tr>
                <tr><td>Reichweite:</td><td>${this.fireRange}</td></tr>
                <tr><td>Kegelwinkel:</td><td>${this.coneAngle}°</td></tr>
                <tr><td>Feuerrate:</td><td>${this.cooldownTime}s</td></tr>
            </table>
        `}drawShootingEffect(){const{game:t}=this.towersController;if(this.targetEnemy&&(this.shootingAngle=Math.atan2(this.targetEnemy.y-this.y,this.targetEnemy.x-this.x)),this.isShooting||this.flameAnimationProgress>0){const e=this.coneAngle*Math.PI/180/2,s=this.fireRange,n=this.getEnemiesInCone().length>0;if(n?this.flameAnimationProgress=Math.min(1,this.flameAnimationProgress+.05):(this.flameAnimationProgress=Math.max(0,this.flameAnimationProgress-.08),this.flameAnimationProgress===0&&(this.isShooting=!1)),this.flameAnimationProgress===0)return;t.ctx.save();let o=0;this.flameAnimationProgress>=.9&&n&&(o=(Math.random()-.5)*.08);const a=s*(this.flameAnimationProgress+o),l=t.ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,a);l.addColorStop(0,"rgba(255, 255, 200, 0.9)"),l.addColorStop(.2,"rgba(255, 200, 100, 0.8)"),l.addColorStop(.5,"rgba(255, 100, 0, 0.7)"),l.addColorStop(.8,"rgba(200, 50, 0, 0.5)"),l.addColorStop(1,"rgba(100, 20, 0, 0)"),t.ctx.fillStyle=l,t.ctx.beginPath(),t.ctx.moveTo(this.x,this.y),t.ctx.arc(this.x,this.y,a,this.shootingAngle-e,this.shootingAngle+e),t.ctx.closePath(),t.ctx.fill(),t.ctx.restore()}}}class ne extends K{constructor(t,e,s,r,n,o){super(t,e,s,o.size||5,o.color||"#00BFFF"),this.type="projectile",this.targetX=r,this.targetY=n,this.speed=o.speed||200,this.arcHeight=o.arcHeight||50,this.explosionRadius=o.explosionRadius||80,this.damage=o.damage,this.source=o.source,this.onHit=o.onHit,this.startX=e,this.startY=s;const a=r-e,l=n-s;this.distance=Math.sqrt(a*a+l*l),this.duration=this.distance/this.speed,this.elapsed=0,this.zIndex=15,t.mapEntities.add(this)}update(t){this.elapsed+=t;const e=Math.min(this.elapsed/this.duration,1);if(e>=1){this.explode();return}this.x=this.startX+(this.targetX-this.startX)*e,this.y=this.startY+(this.targetY-this.startY)*e;const s=Math.sin(e*Math.PI);this.y-=s*this.arcHeight}explode(){this.onHit&&this.onHit(this.targetX,this.targetY,this.explosionRadius),this.game.mapEntities.remove(this.id)}draw(){const t=this.game.ctx;t.save();const e=t.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r);e.addColorStop(0,"rgba(200, 220, 255, 1)"),e.addColorStop(.5,this.color),e.addColorStop(1,"rgba(0, 100, 200, 0)"),t.fillStyle=e,t.beginPath(),t.arc(this.x,this.y,this.r,0,Math.PI*2),t.fill(),t.restore()}}class oe extends U{constructor(t,e,s){super(t,e,"plasma",s);const r=g.towers.plasma;this.minRange=r.minRange,this.explosionRadius=r.explosionRadius,this.projectileSpeed=r.projectileSpeed,this.arcHeight=r.arcHeight,this.activeExplosions=[]}upgrade(){const t=this.towersController.game,e=t.stat("coins"),s=g.towers[this.towerType].upgrades[this.level];s&&e>=s.cost&&(t.stat("coins",e-s.cost,!0),this.damage=s.damage,this.fireRange=s.fireRange,this.explosionRadius=s.explosionRadius,this.critRate+=s.critRate,this.critDamage+=s.critDamage,this.level++,this.color=s.color,t.modal.close())}getEnemiesInRange(){const{game:t,enemies:e}=this.towersController;return e.enemiesList.filter(s=>{const r=t.distance(this.x,this.y,s.x,s.y);return r>=this.minRange&&r<=this.fireRange+s.r})}calculatePredictedTarget(t){const{game:e}=this.towersController,r=e.distance(this.x,this.y,t.x,t.y)/this.projectileSpeed;let n=t.x+t.velocity.x*r,o=t.y+t.velocity.y*r;const l=Math.sqrt(t.velocity.x**2+t.velocity.y**2)*.15,c=(Math.random()-.5)*2*l*r,d=(Math.random()-.5)*2*l*r;return n+=c,o+=d,{x:n,y:o}}shoot(t){if(!t)return;const e=this.calculatePredictedTarget(t);new ne(this.towersController.game,this.x,this.y,e.x,e.y,{size:8,color:this.color,speed:this.projectileSpeed,arcHeight:this.arcHeight,explosionRadius:this.explosionRadius,damage:this.damage,source:this,onHit:(s,r,n)=>this.onProjectileHit(s,r,n)}),this.stats.shoots++}onProjectileHit(t,e,s){const{game:r,enemies:n}=this.towersController;n.enemiesList.filter(a=>a.health<=0?!1:r.distance(t,e,a.x,a.y)<=s).forEach(a=>{const{damage:l,damageType:c}=this.calculateDamage(a);this.stats.dmg+=l,a.damage(l,c),a.deleted&&this.stats.kills++}),this.activeExplosions.push({x:t,y:e,radius:s,progress:0,duration:.5})}update(t){super.update(t),this.activeExplosions=this.activeExplosions.filter(e=>(e.progress+=t/e.duration,e.progress<1))}getStatsHTML(){return`
            <h4>Current Stats (Level ${this.level+1})</h4>
            <table class="tower-stats">
                <tr><td>Schaden:</td><td>${this.damage.from} - ${this.damage.to}</td></tr>
                <tr><td>Reichweite:</td><td>${this.minRange} - ${this.fireRange}</td></tr>
                <tr><td>Explosionsradius:</td><td>${this.explosionRadius}</td></tr>
                <tr><td>Feuerrate:</td><td>${this.cooldownTime}s</td></tr>
                <tr><td>Crit Chance:</td><td>${this.critRate.toFixed(0)}%</td></tr>
                <tr><td>Crit Schaden:</td><td>${this.critDamage*100}%</td></tr>
            </table>
        `}getUpgradeHTML(){const t=g.towers[this.towerType].upgrades[this.level];return t?`
                <h4>Upgrade auf Level ${this.level+2}</h4>
                <table class="tower-stats">
                    <tr><td>Kosten:</td><td>${t.cost} Coins</td></tr>
                    <tr><td>Schaden:</td><td>${t.damage.from} - ${t.damage.to}</td></tr>
                    <tr><td>Max Reichweite:</td><td>${t.fireRange}</td></tr>
                    <tr><td>Explosionsradius:</td><td>${t.explosionRadius}</td></tr>
                    <tr><td>Crit Chance:</td><td>+${t.critRate}%</td></tr>
                    <tr><td>Crit Schaden:</td><td>+${t.critDamage*100}%</td></tr>
                </table>
                <button id="tower-buy-upgrade-btn" class="btn btn-buy" data-required-coins="${t.cost}">Upgrade Kaufen</button>
            `:"<h4>Max Level</h4>"}drawShootingEffect(){const{game:t}=this.towersController;this.activeExplosions.forEach(e=>{const s=t.ctx;s.save();const r=e.radius*(.5+e.progress*.5),n=1-e.progress,o=s.createRadialGradient(e.x,e.y,r*.5,e.x,e.y,r);if(o.addColorStop(0,"rgba(200, 220, 255, 0)"),o.addColorStop(.5,`rgba(100, 150, 255, ${n*.6})`),o.addColorStop(1,"rgba(0, 100, 200, 0)"),s.fillStyle=o,s.beginPath(),s.arc(e.x,e.y,r,0,Math.PI*2),s.fill(),e.progress<.3){const a=(1-e.progress/.3)*.8,l=s.createRadialGradient(e.x,e.y,0,e.x,e.y,r*.4);l.addColorStop(0,`rgba(255, 255, 255, ${a})`),l.addColorStop(1,"rgba(150, 200, 255, 0)"),s.fillStyle=l,s.beginPath(),s.arc(e.x,e.y,r*.4,0,Math.PI*2),s.fill()}s.restore()})}draw(){var r;const{game:t,mouse:e}=this.towersController,s=g.towers.plasma;e.isMouseOver(this.x,this.y,this.r)&&t.stat("mode")!=="dropTower"&&t.drawer.donut(this.x,this.y,this.fireRange,this.minRange,"rgba(255, 102, 0, 0.2)"),(r=s.images)!=null&&r.complete?require("../../helpers.js").default.drawSprite(s.images,this.level,this.x,this.y-20,160,160):t.drawer.circle(this.x,this.y,this.r,this.color,!0),this.drawShootingEffect()}}class ae extends U{constructor(t,e,s){super(t,e,"tesla",s);const r=g.towers.tesla;this.maxChains=r.maxChains,this.chainRange=r.chainRange,this.chainDamageMultipliers=r.chainDamageMultipliers,this.activeLightning=[]}upgrade(){const t=this.towersController.game,e=t.stat("coins"),s=g.towers[this.towerType].upgrades[this.level];s&&e>=s.cost&&(t.stat("coins",e-s.cost,!0),this.damage=s.damage,this.fireRange=s.fireRange,this.chainRange=s.chainRange,this.critRate+=s.critRate,this.critDamage+=s.critDamage,this.level++,this.color=s.color,t.modal.close())}shoot(t){if(!t)return;const e=new Set,s=[];this.hitTarget(t,e,0,s,{x:this.x,y:this.y}),this.findMultipleChainTargets(t,e,2).forEach(n=>{this.hitTarget(n,e,1,s,{x:t.x,y:t.y}),this.findMultipleChainTargets(n,e,3).forEach(a=>{this.hitTarget(a,e,2,s,{x:n.x,y:n.y})})}),this.activeLightning.push({segments:s,progress:0,duration:.3})}hitTarget(t,e,s,r,n){if(e.has(t)){console.warn("Enemy already hit, skipping to prevent double-hit");return}e.add(t),r&&n&&r.push({from:n,to:{x:t.x,y:t.y}});const o=this.chainDamageMultipliers[s]||0,{damage:a,damageType:l}=this.calculateDamage(t),c=Math.round(a*o);this.stats.shoots++,this.stats.dmg+=c,t.damage(c,l),t.deleted&&this.stats.kills++}findMultipleChainTargets(t,e,s){const{game:r,enemies:n}=this.towersController,o=n.enemiesList.filter(a=>e.has(a)||a.health<=0?!1:r.distance(t.x,t.y,a.x,a.y)<=this.chainRange);return o.length===0?[]:(o.sort((a,l)=>{const c=r.distance(t.x,t.y,a.x,a.y),d=r.distance(t.x,t.y,l.x,l.y);return c-d}),o.slice(0,s))}update(t){super.update(t),this.activeLightning=this.activeLightning.filter(e=>(e.progress+=t/e.duration,e.progress<1))}getStatsHTML(){return`
            <h4>Current Stats (Level ${this.level+1})</h4>
            <table class="tower-stats">
                <tr><td>Schaden:</td><td>${this.damage.from} - ${this.damage.to}</td></tr>
                <tr><td>Reichweite:</td><td>${this.fireRange}</td></tr>
                <tr><td>Kettenreichweite:</td><td>${this.chainRange}</td></tr>
                <tr><td>Max Ketten:</td><td>${this.maxChains}</td></tr>
                <tr><td>Schadensreduktion:</td><td>${this.chainDamageMultipliers.map(t=>Math.round(t*100)+"%").join(" → ")}</td></tr>
                <tr><td>Feuerrate:</td><td>${this.cooldownTime}s</td></tr>
                <tr><td>Crit Chance:</td><td>${this.critRate.toFixed(0)}%</td></tr>
                <tr><td>Crit Schaden:</td><td>${this.critDamage*100}%</td></tr>
            </table>
        `}getUpgradeHTML(){const t=g.towers[this.towerType].upgrades[this.level];return t?`
                <h4>Upgrade auf Level ${this.level+2}</h4>
                <table class="tower-stats">
                    <tr><td>Kosten:</td><td>${t.cost} Coins</td></tr>
                    <tr><td>Schaden:</td><td>${t.damage.from} - ${t.damage.to}</td></tr>
                    <tr><td>Reichweite:</td><td>${t.fireRange}</td></tr>
                    <tr><td>Kettenreichweite:</td><td>${t.chainRange}</td></tr>
                    <tr><td>Crit Chance:</td><td>+${t.critRate}%</td></tr>
                    <tr><td>Crit Schaden:</td><td>+${t.critDamage*100}%</td></tr>
                </table>
                <button id="tower-buy-upgrade-btn btn-buy" class="btn" data-required-coins="${t.cost}">Upgrade Kaufen</button>
            `:"<h4>Max Level</h4>"}drawShootingEffect(){const{game:t}=this.towersController;this.activeLightning.forEach(e=>{const s=t.ctx;s.save();const r=1-e.progress;e.segments.forEach(n=>{this.drawLightningBolt(s,n.from.x,n.from.y,n.to.x,n.to.y,r)}),s.restore()})}drawLightningBolt(t,e,s,r,n,o){const a=r-e,l=n-s,c=Math.sqrt(a*a+l*l),d=Math.max(2,Math.floor(c/20)),h=12,u=a/c,p=-(l/c),m=u,w=[{x:e,y:s}];for(let v=1;v<d;v++){const f=v/d,E=e+a*f,M=s+l*f,k=(Math.random()-.5)*2*h,D=E+p*k,y=M+m*k;w.push({x:D,y})}w.push({x:r,y:n}),t.strokeStyle=`rgba(0, 255, 255, ${o})`,t.lineWidth=3,t.shadowBlur=10,t.shadowColor=`rgba(0, 255, 255, ${o*.8})`,t.beginPath(),t.moveTo(w[0].x,w[0].y);for(let v=1;v<w.length;v++)t.lineTo(w[v].x,w[v].y);t.stroke(),t.strokeStyle=`rgba(255, 255, 255, ${o*.9})`,t.lineWidth=1.5,t.shadowBlur=5,t.shadowColor=`rgba(255, 255, 255, ${o*.6})`,t.beginPath(),t.moveTo(e,s);for(let v=1;v<d;v++){const f=v/d,E=e+a*f,M=s+l*f,k=(Math.random()-.5)*2*h*.7,D=E+p*k,y=M+m*k;t.lineTo(D,y)}t.lineTo(r,n),t.stroke(),t.shadowBlur=0}}class le{constructor(t,e,s,r,n){this.game=t,this.map=e,this.mouse=s,this.mapEntities=r,this.enemies=n,this.game.on("update",()=>this.update()),this.game.on("beforeDraw",()=>this.draw())}update(){const t=this.gridPosition(),e=this.game.stat("selectedTowerType");this.game.stat("mode")==="dropTower"&&this.map.isValidTowerPlace(t.x,t.y)&&this.mouse.clicked&&(this.game.stat("mode",""),this.game.stat("coins",this.game.stat("coins")-g.towers[e].costs,!0),this.create(t.x,t.y,e))}draw(){var t,e;if(this.game.stat("mode")==="dropTower"){const s=this.gridPosition(),r=this.game.stat("selectedTowerType"),n=this.map.isValidTowerPlace(s.x,s.y),o=this.map.isTowerAtPosition(s.x,s.y),a=g.towers[r];n?(a.minRange?this.game.drawer.donut(s.x,s.y,a.fireRange,a.minRange,"rgba(0,0,255,0.2)"):this.game.drawer.circle(s.x,s.y,a.fireRange,"rgba(0,0,255,0.2)",!0),(t=a.images)!=null&&t.complete?F.drawSprite(a.images,0,s.x,s.y-20,160,160):this.game.drawer.circle(s.x,s.y,a.size,a.color,!0)):o||((e=a.images)!=null&&e.complete?(this.game.ctx.save(),this.game.ctx.filter="grayscale(100%)",F.drawSprite(a.images,0,s.x,s.y-20,160,160),this.game.ctx.restore()):this.game.drawer.circle(s.x,s.y,a.size,"#666",!0))}}create(t,e,s){switch(s){case"laser":return new se(t,e,this);case"gravity":return new ie(t,e,this);case"flamethrower":return new re(t,e,this);case"plasma":return new oe(t,e,this);case"tesla":return new ae(t,e,this);default:throw new Error(`Unknown tower type: ${s}`)}}gridPosition(){const t=Math.floor(this.mouse.x/g.mapGrid)*g.mapGrid+g.mapGrid/2,e=Math.floor(this.mouse.y/g.mapGrid)*g.mapGrid+g.mapGrid/2;return{x:t,y:e}}}const ce="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%3e%3cpath%20fill='%23ffffff'%20d='m2.344%2015.271l2%203.46a1%201%200%200%200%201.366.365l1.396-.806c.58.457%201.221.832%201.895%201.112V21a1%201%200%200%200%201%201h4a1%201%200%200%200%201-1v-1.598a8%208%200%200%200%201.895-1.112l1.396.806c.477.275%201.091.11%201.366-.365l2-3.46a1.004%201.004%200%200%200-.365-1.366l-1.372-.793a7.7%207.7%200%200%200-.002-2.224l1.372-.793c.476-.275.641-.89.365-1.366l-2-3.46a1%201%200%200%200-1.366-.365l-1.396.806A8%208%200%200%200%2015%204.598V3a1%201%200%200%200-1-1h-4a1%201%200%200%200-1%201v1.598A8%208%200%200%200%207.105%205.71L5.71%204.904a1%201%200%200%200-1.366.365l-2%203.46a1.004%201.004%200%200%200%20.365%201.366l1.372.793a7.7%207.7%200%200%200%200%202.224l-1.372.793c-.476.275-.641.89-.365%201.366M12%208c2.206%200%204%201.794%204%204s-1.794%204-4%204s-4-1.794-4-4s1.794-4%204-4'/%3e%3c/svg%3e";class de{constructor(t=null){this.game=t,this.containerElement=null,this.modalElement=null,this.titleElement=null,this.contentElement=null,this.closeButton=null,this.isOpen=!1,this.cleanupCallbacks=[],this.init()}init(){var t,e,s,r,n;if(this.containerElement=document.querySelector(".modal"),this.modalElement=(t=this.containerElement)==null?void 0:t.querySelector(".modal-content"),this.titleElement=(e=this.modalElement)==null?void 0:e.querySelector(".modal-title"),this.contentElement=(s=this.modalElement)==null?void 0:s.querySelector(".modal-body"),this.closeButton=(r=this.modalElement)==null?void 0:r.querySelector(".modal-close"),!this.containerElement||!this.modalElement){console.error("Modal elements not found in DOM");return}(n=this.closeButton)==null||n.addEventListener("click",()=>this.close()),document.addEventListener("keydown",o=>{o.key==="Escape"&&this.isOpen&&this.close()}),this.handleOutsideClick=this.handleOutsideClick.bind(this)}handleOutsideClick(t){t.target.closest(".modal-content")||(t.stopPropagation(),this.close())}open(t,e){this.containerElement&&(this.isOpen||(this.setTitle(t),this.setContent(e),this.preventBodyScroll(),this.containerElement.classList.add("is--open"),this.isOpen=!0,requestAnimationFrame(()=>{document.addEventListener("click",this.handleOutsideClick)}),this.game&&this.setupCoinBasedButtons()))}setupCoinBasedButtons(){var s;const t=(s=this.contentElement)==null?void 0:s.querySelectorAll("[data-required-coins]");if(!t||t.length===0)return;const e=()=>{const r=this.game.stat("coins");t.forEach(n=>{const o=parseInt(n.getAttribute("data-required-coins"),10);n.disabled=r<o;const a=n.getAttribute("data-disable-parent");if(a){const l=n.closest(a);l&&(r<o?l.classList.add("disabled"):l.classList.remove("disabled"))}})};e(),this.game.on("stat:coins",e),this.onClose(()=>{this.game.off("stat:coins",e)})}preventBodyScroll(){const t=window.innerWidth-document.documentElement.clientWidth;t>0&&(document.body.style.paddingRight=`${t}px`),document.body.style.overflow="hidden"}restoreBodyScroll(){document.body.style.overflow="",document.body.style.paddingRight=""}close(){this.containerElement&&(this.containerElement.classList.remove("is--open"),this.isOpen=!1,this.restoreBodyScroll(),document.removeEventListener("click",this.handleOutsideClick),this.cleanupCallbacks.forEach(t=>t()),this.cleanupCallbacks=[],this.setContent(""))}onClose(t){typeof t=="function"&&this.cleanupCallbacks.push(t)}setTitle(t){this.titleElement&&(this.titleElement.innerHTML=t)}setContent(t){this.contentElement&&(typeof t=="string"?this.contentElement.innerHTML=t:t instanceof HTMLElement&&(this.contentElement.innerHTML="",this.contentElement.appendChild(t)))}}class he{constructor(t){this.ctx=t}circle(t,e,s,r,n=!0){this.ctx.beginPath(),this.ctx.arc(t,e,s,0,2*Math.PI),n===!0?(this.ctx.fillStyle=r,this.ctx.fill()):(this.ctx.strokeStyle=r,this.ctx.stroke())}donut(t,e,s,r,n){this.ctx.save(),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(t,e,s,0,Math.PI*2,!1),this.ctx.arc(t,e,r,0,Math.PI*2,!0),this.ctx.fill(),this.ctx.restore()}}const ue="/tower-defense/assets/coin-DvQxkcR6.svg";class pe{constructor(){F.init(this),this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.drawer=new he(this.ctx),this.drawList=[],this.stats={},this._outputCache={},this.waveCounter=0,this.gameOver=!1,this.eventsList={},this.lastFrameTime=0,this.lastWaveTemplate=[],this.isPaused=!1,this.spawnQueue=[],this.optionsIconImage=new Image,this.optionsIconImage.src=ce,this.optionsIconPos={x:this.canvas.width-40,y:10,width:30,height:30},this.mapEntities=new Yt(this),this.map=new Qt(this,this.mapEntities),this.mouse=new Wt(this),this.enemies=new ee(this,this.map,this.mapEntities),this.towers=new le(this,this.map,this.mouse,this.mapEntities,this.enemies),this.debug=new Kt(this),this.modal=new de(this),this.stat("soundEnabled",g.game.soundEnabled),this.stat("showNormalDamage",g.game.showNormalDamage),this.loadSettings(),document.addEventListener("click",t=>{if(this.gameOver){this.resetGame();return}t.target.matches("#buy-tower")&&(t.preventDefault(),this.openTowerShopModal()),t.target.matches("#next-wave")&&(t.preventDefault(),this.nextWave())},!1),this.canvas.addEventListener("click",t=>{const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,r=t.clientY-e.top;s>=this.optionsIconPos.x&&s<=this.optionsIconPos.x+this.optionsIconPos.width&&r>=this.optionsIconPos.y&&r<=this.optionsIconPos.y+this.optionsIconPos.height&&this.openSettingsModal()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.stat("mode")==="dropTower"&&this.stat("mode","")}),document.addEventListener("visibilitychange",()=>{document.hidden?this.isPaused=!0:(this.isPaused=!1,this.lastFrameTime=performance.now())}),this.output("#towerCosts",g.towers.laser.costs),this.output("#app-version","v0.0.2alpha"),this.resetGame(),window.requestAnimationFrame(this.draw.bind(this))}loadSettings(){const t=JSON.parse(localStorage.getItem("gameSettings"))||{};this.stat("soundEnabled",t.soundEnabled??g.game.soundEnabled),this.stat("showNormalDamage",t.showNormalDamage??g.game.showNormalDamage)}saveSettings(){const t={soundEnabled:this.stat("soundEnabled"),showNormalDamage:this.stat("showNormalDamage")};localStorage.setItem("gameSettings",JSON.stringify(t))}openSettingsModal(){const t=`
            <div>
                <label>
                    <input type="checkbox" id="setting-sound-enabled" ${this.stat("soundEnabled")?"checked":""}>
                    Sound aktivieren
                </label>
            </div>
            <div>
                <label>
                    <input type="checkbox" id="setting-show-normal-damage" ${this.stat("showNormalDamage")?"checked":""}>
                    Normale Schadenszahlen anzeigen (Crits immer anzeigen)
                </label>
            </div>
        `;this.modal.open("Settings",t),document.getElementById("setting-sound-enabled").addEventListener("change",e=>{this.stat("soundEnabled",e.target.checked),this.saveSettings()}),document.getElementById("setting-show-normal-damage").addEventListener("change",e=>{this.stat("showNormalDamage",e.target.checked),this.saveSettings()})}openTowerShopModal(){const t=this.stat("coins"),e=Object.keys(g.towers);let s='<div class="tower-shop">';e.forEach(r=>{const n=g.towers[r],a=t>=n.costs?"":"disabled",l=`tower-preview-${r}`;let c=`
                <div>Reichweite: ${n.fireRange}</div>
            `;n.minRange&&(c=`<div>Reichweite: ${n.minRange}-${n.fireRange}</div>`),n.slowEffect&&(c+=`<div>Slow: -${Math.round((1-n.slowEffect)*100)}%</div>`),n.damage&&(c+=`
                    <div>Schaden: ${n.damage.from}-${n.damage.to}</div>
                    <div>Feuerrate: ${n.coolDownTime}s</div>
                `),n.dotType&&(c+=`
                    <h5>Schaden über Zeit</h5>
                    <div>Schaden: ${n.dotDamage.from}-${n.dotDamage.to} (${n.dotType})</div>
                    <div>Dauer: ${n.dotDuration}s</div>
                `),n.maxChains&&(c+=`
                    <h5>Ketten Effekt</h5>
                    <div>Kettenreichweite: ${n.chainRange}</div>
                    <div>Max Ketten: ${n.maxChains}</div>
                `),s+=`
                <div class="tower-shop-item ${a}">
                    <canvas id="${l}" width="80" height="80"></canvas>
                    
                    <div class="tower-shop-info">
                        <h4>${n.label}</h4>
                        ${c}
                    </div>
                    
                    <div class="tower-shop-buy-container">
                        <div class="tower-shop-item-price">
                            <img src="${ue}" alt="Coins" title="Coins">
                            ${n.costs}
                        </div>
                        
                        <button class="btn btn-buy" data-tower-type="${r}" data-required-coins="${n.costs}" data-disable-parent=".tower-shop-item">
                            Kaufen
                        </button>
                    </div>
                </div>
            `}),s+="</div>",this.modal.open("Turm kaufen",s,this),e.forEach(r=>{var o;const n=document.getElementById(`tower-preview-${r}`);if(n){const a=n.getContext("2d"),l=g.towers[r];if(a.clearRect(0,0,80,80),(o=l.images)!=null&&o.complete){const c=l.images.sprites[0];a.drawImage(l.images,c.x,c.y,c.w*2,c.h*2,0,0,80,80)}else a.beginPath(),a.arc(40,40,20,0,2*Math.PI),a.fillStyle=l.color,a.fill()}}),document.querySelectorAll(".modal .btn-buy[data-tower-type]").forEach(r=>{r.addEventListener("click",n=>{const o=n.target.getAttribute("data-tower-type");this.buyTower(o),this.modal.close()})})}resetGame(){this.gameOver=!1,this.waveCounter=0,this.mapEntities.list={},this.enemies.enemiesList=[],this.spawnQueue=[],this.stat("live",g.playersLive,!0),this.stat("coins",g.coins,!0),this.stat("wave",0,!0),this.stat("mode","")}buyTower(t){this.stat("mode")!=="dropTower"&&this.stat("coins")>=g.towers[t].costs&&(this.stat("mode","dropTower"),this.stat("selectedTowerType",t))}update(t){if(this.gameOver){this.mouse.update();return}this.processSpawnQueue(t),this.trigger("update",t),this.mouse.update()}draw(t){t||(t=0);const e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,window.requestAnimationFrame(this.draw.bind(this)),this.isPaused||this.update(e),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.trigger("beforeDraw"),this.drawList=F.sortEntity(this.drawList);for(const s of this.drawList)s.draw();this.drawList=[],this.trigger("afterDraw"),this.optionsIconImage.complete&&this.ctx.drawImage(this.optionsIconImage,this.optionsIconPos.x,this.optionsIconPos.y,this.optionsIconPos.width,this.optionsIconPos.height),this.gameOver&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.font="48px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("Game Over",this.canvas.width/2,this.canvas.height/2-40),this.ctx.font="24px sans-serif",this.ctx.fillText("Klicken zum Neustarten",this.canvas.width/2,this.canvas.height/2+20))}setGameOver(){this.gameOver=!0}stat(t,e,s){if(e===void 0)return this.stats[t]||!1;const r=this.stats[t];return this.stats[t]=e,s!==void 0&&this.output(`#${t}`,e),r!==e&&this.trigger(`stat:${t}`,e),this}output(t,e){this._outputCache[t]||(this._outputCache[t]=document.querySelectorAll(t)),this._outputCache[t]&&this._outputCache[t].forEach(s=>{s.innerHTML=e})}distance(t,e,s,r){let n=t-s,o=e-r;return Math.sqrt(n*n+o*o)}intersectRect(t,e){return!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)}nextWave(){if(Object.keys(this.mapEntities.list).length===0)return this;if(this.enemies.enemiesList.length>0)return this;this.waveCounter++,this.stat("wave",this.waveCounter,!0);const t=Math.floor((this.waveCounter-1)/g.leveling.wavesPerLevel)+1,e=this.isBossWave()?this.generateBossWave(t):this.generateNormalWave(t);return this.lastWaveTemplate=e,this.spawnEnemiesFromTemplate(e),this}isBossWave(){return this.waveCounter>0&&this.waveCounter%g.leveling.wavesPerLevel===0}generateBossWave(t){return g.bossWaveTemplate.map(e=>({...e,level:t}))}generateNormalWave(t){const e=(this.waveCounter-1)%g.leveling.wavesPerLevel,s=Math.pow(e/(g.leveling.wavesPerLevel-1),1.7),{minThreat:r,maxThreat:n,threatFactor:o}=g.leveling.waveGeneration,a=Math.pow(o,t-1),l=r*a,c=n*a,d=l+(c-l)*s;let h=[],u=this.collectFragments(g.waveFragments,d,0,t,h);return u=this.collectFragments(g.fillUpFragments,d,u,t,h),this.lastWaveMaxThreat=d,this.lastWaveCurrentThreat=u,h}collectFragments(t,e,s,r,n){let o=0;const a=Object.keys(t);for(;o<100;){const l=a.filter(u=>t[u].threat<=e-s);if(l.length===0)break;const c=l[Math.floor(Math.random()*l.length)],d=t[c];let h=d.details;Array.isArray(h)||(h=[h]),h.forEach(u=>{n.push({...u,name:c,level:r,count:u.count+(r-1)*(u.countFactor||0),threat:d.threat})}),s+=d.threat,o++}return s}spawnEnemiesFromTemplate(t){let e=0;const s=20;t.forEach(r=>{var h;const n=g.enemyTypes[r.enemyType],o=((h=n.levelFactors)==null?void 0:h.speed)??g.leveling.speedFactor,a=r.level>0?r.level-1:0,l=n.baseSpeed*Math.pow(o,a),d=(r.spacing||1)*s/l;for(let u=0;u<Math.round(r.count);u++)this.spawnQueue.push({enemyType:r.enemyType,level:r.level,wave:this.waveCounter,timeUntilSpawn:e+u*d});e+=r.count*d})}processSpawnQueue(t){for(let e=this.spawnQueue.length-1;e>=0;e--)if(this.spawnQueue[e].timeUntilSpawn-=t,this.spawnQueue[e].timeUntilSpawn<=0){const s=this.spawnQueue[e];this.enemies.create(s.enemyType,s.level,s.wave),this.spawnQueue.splice(e,1)}}on(t,e){return this.eventsList[t]||(this.eventsList[t]=[]),this.eventsList[t].push(e),this}off(t,e){if(!this.eventsList[t])return this;if(e){const s=this.eventsList[t].indexOf(e);s!==-1&&this.eventsList[t].splice(s,1)}else delete this.eventsList[t];return this}trigger(t,e){if(!this.eventsList[t])return this;for(let s=0;s<this.eventsList[t].length;s++)this.eventsList[t][s](e);return this}}function rt(i,t){i.split(/\s+/).forEach(e=>{t(e)})}class fe{constructor(){this._events={}}on(t,e){rt(t,s=>{const r=this._events[s]||[];r.push(e),this._events[s]=r})}off(t,e){var s=arguments.length;if(s===0){this._events={};return}rt(t,r=>{if(s===1){delete this._events[r];return}const n=this._events[r];n!==void 0&&(n.splice(n.indexOf(e),1),this._events[r]=n)})}trigger(t,...e){var s=this;rt(t,r=>{const n=s._events[r];n!==void 0&&n.forEach(o=>{o.apply(s,e)})})}}function ge(i){return i.plugins={},class extends i{constructor(){super(...arguments),this.plugins={names:[],settings:{},requested:{},loaded:{}}}static define(t,e){i.plugins[t]={name:t,fn:e}}initializePlugins(t){var e,s;const r=this,n=[];if(Array.isArray(t))t.forEach(o=>{typeof o=="string"?n.push(o):(r.plugins.settings[o.name]=o.options,n.push(o.name))});else if(t)for(e in t)t.hasOwnProperty(e)&&(r.plugins.settings[e]=t[e],n.push(e));for(;s=n.shift();)r.require(s)}loadPlugin(t){var e=this,s=e.plugins,r=i.plugins[t];if(!i.plugins.hasOwnProperty(t))throw new Error('Unable to find "'+t+'" plugin');s.requested[t]=!0,s.loaded[t]=r.fn.apply(e,[e.plugins.settings[t]||{}]),s.names.push(t)}require(t){var e=this,s=e.plugins;if(!e.plugins.loaded.hasOwnProperty(t)){if(s.requested[t])throw new Error('Plugin has circular dependency ("'+t+'")');e.loadPlugin(t)}return s.loaded[t]}}}const it=i=>(i=i.filter(Boolean),i.length<2?i[0]||"":ve(i)==1?"["+i.join("")+"]":"(?:"+i.join("|")+")"),Mt=i=>{if(!me(i))return i.join("");let t="",e=0;const s=()=>{e>1&&(t+="{"+e+"}")};return i.forEach((r,n)=>{if(r===i[n-1]){e++;return}s(),t+=r,e=1}),s(),t},Rt=i=>{let t=Array.from(i);return it(t)},me=i=>new Set(i).size!==i.length,z=i=>(i+"").replace(/([\$\(\)\*\+\.\?\[\]\^\{\|\}\\])/gu,"\\$1"),ve=i=>i.reduce((t,e)=>Math.max(t,we(e)),0),we=i=>Array.from(i).length,Ft=i=>{if(i.length===1)return[[i]];let t=[];const e=i.substring(1);return Ft(e).forEach(function(r){let n=r.slice(0);n[0]=i.charAt(0)+n[0],t.push(n),n=r.slice(0),n.unshift(i.charAt(0)),t.push(n)}),t},ye=[[0,65535]],xe="[̀-ͯ·ʾʼ]";let tt,$t;const be=3,ut={},pt={"/":"⁄∕",0:"߀",a:"ⱥɐɑ",aa:"ꜳ",ae:"æǽǣ",ao:"ꜵ",au:"ꜷ",av:"ꜹꜻ",ay:"ꜽ",b:"ƀɓƃ",c:"ꜿƈȼↄ",d:"đɗɖᴅƌꮷԁɦ",e:"ɛǝᴇɇ",f:"ꝼƒ",g:"ǥɠꞡᵹꝿɢ",h:"ħⱨⱶɥ",i:"ɨı",j:"ɉȷ",k:"ƙⱪꝁꝃꝅꞣ",l:"łƚɫⱡꝉꝇꞁɭ",m:"ɱɯϻ",n:"ꞥƞɲꞑᴎлԉ",o:"øǿɔɵꝋꝍᴑ",oe:"œ",oi:"ƣ",oo:"ꝏ",ou:"ȣ",p:"ƥᵽꝑꝓꝕρ",q:"ꝗꝙɋ",r:"ɍɽꝛꞧꞃ",s:"ßȿꞩꞅʂ",t:"ŧƭʈⱦꞇ",th:"þ",tz:"ꜩ",u:"ʉ",v:"ʋꝟʌ",vy:"ꝡ",w:"ⱳ",y:"ƴɏỿ",z:"ƶȥɀⱬꝣ",hv:"ƕ"};for(let i in pt){let t=pt[i]||"";for(let e=0;e<t.length;e++){let s=t.substring(e,e+1);ut[s]=i}}const Ae=new RegExp(Object.keys(ut).join("|")+"|"+xe,"gu"),Ce=i=>{tt===void 0&&(tt=Oe(ye))},ft=(i,t="NFKD")=>i.normalize(t),et=i=>Array.from(i).reduce((t,e)=>t+Ee(e),""),Ee=i=>(i=ft(i).toLowerCase().replace(Ae,t=>ut[t]||""),ft(i,"NFC"));function*Se(i){for(const[t,e]of i)for(let s=t;s<=e;s++){let r=String.fromCharCode(s),n=et(r);n!=r.toLowerCase()&&(n.length>be||n.length!=0&&(yield{folded:n,composed:r,code_point:s}))}}const Te=i=>{const t={},e=(s,r)=>{const n=t[s]||new Set,o=new RegExp("^"+Rt(n)+"$","iu");r.match(o)||(n.add(z(r)),t[s]=n)};for(let s of Se(i))e(s.folded,s.folded),e(s.folded,s.composed);return t},Oe=i=>{const t=Te(i),e={};let s=[];for(let n in t){let o=t[n];o&&(e[n]=Rt(o)),n.length>1&&s.push(z(n))}s.sort((n,o)=>o.length-n.length);const r=it(s);return $t=new RegExp("^"+r,"u"),e},_e=(i,t=1)=>{let e=0;return i=i.map(s=>(tt[s]&&(e+=s.length),tt[s]||s)),e>=t?Mt(i):""},Ie=(i,t=1)=>(t=Math.max(t,i.length-1),it(Ft(i).map(e=>_e(e,t)))),gt=(i,t=!0)=>{let e=i.length>1?1:0;return it(i.map(s=>{let r=[];const n=t?s.length():s.length()-1;for(let o=0;o<n;o++)r.push(Ie(s.substrs[o]||"",e));return Mt(r)}))},Le=(i,t)=>{for(const e of t){if(e.start!=i.start||e.end!=i.end||e.substrs.join("")!==i.substrs.join(""))continue;let s=i.parts;const r=o=>{for(const a of s){if(a.start===o.start&&a.substr===o.substr)return!1;if(!(o.length==1||a.length==1)&&(o.start<a.start&&o.end>a.start||a.start<o.start&&a.end>o.start))return!0}return!1};if(!(e.parts.filter(r).length>0))return!0}return!1};class st{constructor(){H(this,"parts");H(this,"substrs");H(this,"start");H(this,"end");this.parts=[],this.substrs=[],this.start=0,this.end=0}add(t){t&&(this.parts.push(t),this.substrs.push(t.substr),this.start=Math.min(t.start,this.start),this.end=Math.max(t.end,this.end))}last(){return this.parts[this.parts.length-1]}length(){return this.parts.length}clone(t,e){let s=new st,r=JSON.parse(JSON.stringify(this.parts)),n=r.pop();for(const l of r)s.add(l);let o=e.substr.substring(0,t-n.start),a=o.length;return s.add({start:n.start,end:n.start+a,length:a,substr:o}),s}}const Me=i=>{Ce(),i=et(i);let t="",e=[new st];for(let s=0;s<i.length;s++){let n=i.substring(s).match($t);const o=i.substring(s,s+1),a=n?n[0]:null;let l=[],c=new Set;for(const d of e){const h=d.last();if(!h||h.length==1||h.end<=s)if(a){const u=a.length;d.add({start:s,end:s+u,length:u,substr:a}),c.add("1")}else d.add({start:s,end:s+1,length:1,substr:o}),c.add("2");else if(a){let u=d.clone(s,h);const b=a.length;u.add({start:s,end:s+b,length:b,substr:a}),l.push(u)}else c.add("3")}if(l.length>0){l=l.sort((d,h)=>d.length()-h.length());for(let d of l)Le(d,e)||e.push(d);continue}if(s>0&&c.size==1&&!c.has("3")){t+=gt(e,!1);let d=new st;const h=e[0];h&&d.add(h.last()),e=[d]}}return t+=gt(e,!0),t},Re=(i,t)=>{if(i)return i[t]},Fe=(i,t)=>{if(i){for(var e,s=t.split(".");(e=s.shift())&&(i=i[e]););return i}},nt=(i,t,e)=>{var s,r;return!i||(i=i+"",t.regex==null)||(r=i.search(t.regex),r===-1)?0:(s=t.string.length/i.length,r===0&&(s+=.5),s*e)},ot=(i,t)=>{var e=i[t];if(typeof e=="function")return e;e&&!Array.isArray(e)&&(i[t]=[e])},W=(i,t)=>{if(Array.isArray(i))i.forEach(t);else for(var e in i)i.hasOwnProperty(e)&&t(i[e],e)},$e=(i,t)=>typeof i=="number"&&typeof t=="number"?i>t?1:i<t?-1:0:(i=et(i+"").toLowerCase(),t=et(t+"").toLowerCase(),i>t?1:t>i?-1:0);class ke{constructor(t,e){H(this,"items");H(this,"settings");this.items=t,this.settings=e||{diacritics:!0}}tokenize(t,e,s){if(!t||!t.length)return[];const r=[],n=t.split(/\s+/);var o;return s&&(o=new RegExp("^("+Object.keys(s).map(z).join("|")+"):(.*)$")),n.forEach(a=>{let l,c=null,d=null;o&&(l=a.match(o))&&(c=l[1],a=l[2]),a.length>0&&(this.settings.diacritics?d=Me(a)||null:d=z(a),d&&e&&(d="\\b"+d)),r.push({string:a,regex:d?new RegExp(d,"iu"):null,field:c})}),r}getScoreFunction(t,e){var s=this.prepareSearch(t,e);return this._getScoreFunction(s)}_getScoreFunction(t){const e=t.tokens,s=e.length;if(!s)return function(){return 0};const r=t.options.fields,n=t.weights,o=r.length,a=t.getAttrFn;if(!o)return function(){return 1};const l=function(){return o===1?function(c,d){const h=r[0].field;return nt(a(d,h),c,n[h]||1)}:function(c,d){var h=0;if(c.field){const u=a(d,c.field);!c.regex&&u?h+=1/o:h+=nt(u,c,1)}else W(n,(u,b)=>{h+=nt(a(d,b),c,u)});return h/o}}();return s===1?function(c){return l(e[0],c)}:t.options.conjunction==="and"?function(c){var d,h=0;for(let u of e){if(d=l(u,c),d<=0)return 0;h+=d}return h/s}:function(c){var d=0;return W(e,h=>{d+=l(h,c)}),d/s}}getSortFunction(t,e){var s=this.prepareSearch(t,e);return this._getSortFunction(s)}_getSortFunction(t){var e,s=[];const r=this,n=t.options,o=!t.query&&n.sort_empty?n.sort_empty:n.sort;if(typeof o=="function")return o.bind(this);const a=function(c,d){return c==="$score"?d.score:t.getAttrFn(r.items[d.id],c)};if(o)for(let c of o)(t.query||c.field!=="$score")&&s.push(c);if(t.query){e=!0;for(let c of s)if(c.field==="$score"){e=!1;break}e&&s.unshift({field:"$score",direction:"desc"})}else s=s.filter(c=>c.field!=="$score");return s.length?function(c,d){var h,u;for(let b of s)if(u=b.field,h=(b.direction==="desc"?-1:1)*$e(a(u,c),a(u,d)),h)return h;return 0}:null}prepareSearch(t,e){const s={};var r=Object.assign({},e);if(ot(r,"sort"),ot(r,"sort_empty"),r.fields){ot(r,"fields");const n=[];r.fields.forEach(o=>{typeof o=="string"&&(o={field:o,weight:1}),n.push(o),s[o.field]="weight"in o?o.weight:1}),r.fields=n}return{options:r,query:t.toLowerCase().trim(),tokens:this.tokenize(t,r.respect_word_boundaries,s),total:0,items:[],weights:s,getAttrFn:r.nesting?Fe:Re}}search(t,e){var s=this,r,n;n=this.prepareSearch(t,e),e=n.options,t=n.query;const o=e.score||s._getScoreFunction(n);t.length?W(s.items,(l,c)=>{r=o(l),(e.filter===!1||r>0)&&n.items.push({score:r,id:c})}):W(s.items,(l,c)=>{n.items.push({score:1,id:c})});const a=s._getSortFunction(n);return a&&n.items.sort(a),n.total=n.items.length,typeof e.limit=="number"&&(n.items=n.items.slice(0,e.limit)),n}}const $=i=>typeof i>"u"||i===null?null:X(i),X=i=>typeof i=="boolean"?i?"1":"0":i+"",at=i=>(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),De=(i,t)=>t>0?window.setTimeout(i,t):(i.call(null),null),Pe=(i,t)=>{var e;return function(s,r){var n=this;e&&(n.loading=Math.max(n.loading-1,0),clearTimeout(e)),e=setTimeout(function(){e=null,n.loadedSearches[s]=!0,i.call(n,s,r)},t)}},mt=(i,t,e)=>{var s,r=i.trigger,n={};i.trigger=function(){var o=arguments[0];if(t.indexOf(o)!==-1)n[o]=arguments;else return r.apply(i,arguments)},e.apply(i,[]),i.trigger=r;for(s of t)s in n&&r.apply(i,n[s])},Be=i=>({start:i.selectionStart||0,length:(i.selectionEnd||0)-(i.selectionStart||0)}),T=(i,t=!1)=>{i&&(i.preventDefault(),t&&i.stopPropagation())},I=(i,t,e,s)=>{i.addEventListener(t,e,s)},N=(i,t)=>{if(!t||!t[i])return!1;var e=(t.altKey?1:0)+(t.ctrlKey?1:0)+(t.shiftKey?1:0)+(t.metaKey?1:0);return e===1},lt=(i,t)=>{const e=i.getAttribute("id");return e||(i.setAttribute("id",t),t)},vt=i=>i.replace(/[\\"']/g,"\\$&"),V=(i,t)=>{t&&i.append(t)},O=(i,t)=>{if(Array.isArray(i))i.forEach(t);else for(var e in i)i.hasOwnProperty(e)&&t(i[e],e)},P=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(kt(i)){var t=document.createElement("template");return t.innerHTML=i.trim(),t.content.firstChild}return document.querySelector(i)},kt=i=>typeof i=="string"&&i.indexOf("<")>-1,He=i=>i.replace(/['"\\]/g,"\\$&"),ct=(i,t)=>{var e=document.createEvent("HTMLEvents");e.initEvent(t,!0,!1),i.dispatchEvent(e)},q=(i,t)=>{Object.assign(i.style,t)},R=(i,...t)=>{var e=Dt(t);i=Pt(i),i.map(s=>{e.map(r=>{s.classList.add(r)})})},B=(i,...t)=>{var e=Dt(t);i=Pt(i),i.map(s=>{e.map(r=>{s.classList.remove(r)})})},Dt=i=>{var t=[];return O(i,e=>{typeof e=="string"&&(e=e.trim().split(/[\t\n\f\r\s]/)),Array.isArray(e)&&(t=t.concat(e))}),t.filter(Boolean)},Pt=i=>(Array.isArray(i)||(i=[i]),i),dt=(i,t,e)=>{if(!(e&&!e.contains(i)))for(;i&&i.matches;){if(i.matches(t))return i;i=i.parentNode}},wt=(i,t=0)=>t>0?i[i.length-1]:i[0],Ne=i=>Object.keys(i).length===0,yt=(i,t)=>{if(!i)return-1;t=t||i.nodeName;for(var e=0;i=i.previousElementSibling;)i.matches(t)&&e++;return e},S=(i,t)=>{O(t,(e,s)=>{e==null?i.removeAttribute(s):i.setAttribute(s,""+e)})},ht=(i,t)=>{i.parentNode&&i.parentNode.replaceChild(t,i)},Ve=(i,t)=>{if(t===null)return;if(typeof t=="string"){if(!t.length)return;t=new RegExp(t,"i")}const e=n=>{var o=n.data.match(t);if(o&&n.data.length>0){var a=document.createElement("span");a.className="highlight";var l=n.splitText(o.index);l.splitText(o[0].length);var c=l.cloneNode(!0);return a.appendChild(c),ht(l,a),1}return 0},s=n=>{n.nodeType===1&&n.childNodes&&!/(script|style)/i.test(n.tagName)&&(n.className!=="highlight"||n.tagName!=="SPAN")&&Array.from(n.childNodes).forEach(o=>{r(o)})},r=n=>n.nodeType===3?e(n):(s(n),0);r(i)},Ge=i=>{var t=i.querySelectorAll("span.highlight");Array.prototype.forEach.call(t,function(e){var s=e.parentNode;s.replaceChild(e.firstChild,e),s.normalize()})},ze=65,Ke=13,Ue=27,je=37,Qe=38,Ye=39,We=40,xt=8,qe=46,bt=9,Ze=typeof navigator>"u"?!1:/Mac/.test(navigator.userAgent),Z=Ze?"metaKey":"ctrlKey",At={options:[],optgroups:[],plugins:[],delimiter:",",splitOn:null,persist:!0,diacritics:!0,create:null,createOnBlur:!1,createFilter:null,highlight:!0,openOnFocus:!0,shouldOpen:null,maxOptions:50,maxItems:null,hideSelected:null,duplicates:!1,addPrecedence:!1,selectOnTab:!1,preload:null,allowEmptyOption:!1,refreshThrottle:300,loadThrottle:300,loadingClass:"loading",dataAttr:null,optgroupField:"optgroup",valueField:"value",labelField:"text",disabledField:"disabled",optgroupLabelField:"label",optgroupValueField:"value",lockOptgroupOrder:!1,sortField:"$order",searchField:["text"],searchConjunction:"and",mode:null,wrapperClass:"ts-wrapper",controlClass:"ts-control",dropdownClass:"ts-dropdown",dropdownContentClass:"ts-dropdown-content",itemClass:"item",optionClass:"option",dropdownParent:null,controlInput:'<input type="text" autocomplete="off" size="1" />',copyClassesToDropdown:!1,placeholder:null,hidePlaceholder:null,shouldLoad:function(i){return i.length>0},render:{}};function Ct(i,t){var e=Object.assign({},At,t),s=e.dataAttr,r=e.labelField,n=e.valueField,o=e.disabledField,a=e.optgroupField,l=e.optgroupLabelField,c=e.optgroupValueField,d=i.tagName.toLowerCase(),h=i.getAttribute("placeholder")||i.getAttribute("data-placeholder");if(!h&&!e.allowEmptyOption){let m=i.querySelector('option[value=""]');m&&(h=m.textContent)}var u={placeholder:h,options:[],optgroups:[],items:[],maxItems:null},b=()=>{var m,w=u.options,v={},f=1;let E=0;var M=y=>{var A=Object.assign({},y.dataset),x=s&&A[s];return typeof x=="string"&&x.length&&(A=Object.assign(A,JSON.parse(x))),A},k=(y,A)=>{var x=$(y.value);if(x!=null&&!(!x&&!e.allowEmptyOption)){if(v.hasOwnProperty(x)){if(A){var _=v[x][a];_?Array.isArray(_)?_.push(A):v[x][a]=[_,A]:v[x][a]=A}}else{var C=M(y);C[r]=C[r]||y.textContent,C[n]=C[n]||x,C[o]=C[o]||y.disabled,C[a]=C[a]||A,C.$option=y,C.$order=C.$order||++E,v[x]=C,w.push(C)}y.selected&&u.items.push(x)}},D=y=>{var A,x;x=M(y),x[l]=x[l]||y.getAttribute("label")||"",x[c]=x[c]||f++,x[o]=x[o]||y.disabled,x.$order=x.$order||++E,u.optgroups.push(x),A=x[c],O(y.children,_=>{k(_,A)})};u.maxItems=i.hasAttribute("multiple")?null:1,O(i.children,y=>{m=y.tagName.toLowerCase(),m==="optgroup"?D(y):m==="option"&&k(y)})},p=()=>{const m=i.getAttribute(s);if(m)u.options=JSON.parse(m),O(u.options,v=>{u.items.push(v[n])});else{var w=i.value.trim()||"";if(!e.allowEmptyOption&&!w.length)return;const v=w.split(e.delimiter);O(v,f=>{const E={};E[r]=f,E[n]=f,u.options.push(E)}),u.items=v}};return d==="select"?b():p(),Object.assign({},At,u,t)}var Et=0;class L extends ge(fe){constructor(t,e){super(),this.order=0,this.isOpen=!1,this.isDisabled=!1,this.isReadOnly=!1,this.isInvalid=!1,this.isValid=!0,this.isLocked=!1,this.isFocused=!1,this.isInputHidden=!1,this.isSetup=!1,this.ignoreFocus=!1,this.ignoreHover=!1,this.hasOptions=!1,this.lastValue="",this.caretPos=0,this.loading=0,this.loadedSearches={},this.activeOption=null,this.activeItems=[],this.optgroups={},this.options={},this.userOptions={},this.items=[],this.refreshTimeout=null,Et++;var s,r=P(t);if(r.tomselect)throw new Error("Tom Select already initialized on this element");r.tomselect=this;var n=window.getComputedStyle&&window.getComputedStyle(r,null);s=n.getPropertyValue("direction");const o=Ct(r,e);this.settings=o,this.input=r,this.tabIndex=r.tabIndex||0,this.is_select_tag=r.tagName.toLowerCase()==="select",this.rtl=/rtl/i.test(s),this.inputId=lt(r,"tomselect-"+Et),this.isRequired=r.required,this.sifter=new ke(this.options,{diacritics:o.diacritics}),o.mode=o.mode||(o.maxItems===1?"single":"multi"),typeof o.hideSelected!="boolean"&&(o.hideSelected=o.mode==="multi"),typeof o.hidePlaceholder!="boolean"&&(o.hidePlaceholder=o.mode!=="multi");var a=o.createFilter;typeof a!="function"&&(typeof a=="string"&&(a=new RegExp(a)),a instanceof RegExp?o.createFilter=w=>a.test(w):o.createFilter=w=>this.settings.duplicates||!this.options[w]),this.initializePlugins(o.plugins),this.setupCallbacks(),this.setupTemplates();const l=P("<div>"),c=P("<div>"),d=this._render("dropdown"),h=P('<div role="listbox" tabindex="-1">'),u=this.input.getAttribute("class")||"",b=o.mode;var p;if(R(l,o.wrapperClass,u,b),R(c,o.controlClass),V(l,c),R(d,o.dropdownClass,b),o.copyClassesToDropdown&&R(d,u),R(h,o.dropdownContentClass),V(d,h),P(o.dropdownParent||l).appendChild(d),kt(o.controlInput)){p=P(o.controlInput);var m=["autocorrect","autocapitalize","autocomplete","spellcheck"];O(m,w=>{r.getAttribute(w)&&S(p,{[w]:r.getAttribute(w)})}),p.tabIndex=-1,c.appendChild(p),this.focus_node=p}else o.controlInput?(p=P(o.controlInput),this.focus_node=p):(p=P("<input/>"),this.focus_node=c);this.wrapper=l,this.dropdown=d,this.dropdown_content=h,this.control=c,this.control_input=p,this.setup()}setup(){const t=this,e=t.settings,s=t.control_input,r=t.dropdown,n=t.dropdown_content,o=t.wrapper,a=t.control,l=t.input,c=t.focus_node,d={passive:!0},h=t.inputId+"-ts-dropdown";S(n,{id:h}),S(c,{role:"combobox","aria-haspopup":"listbox","aria-expanded":"false","aria-controls":h});const u=lt(c,t.inputId+"-ts-control"),b="label[for='"+He(t.inputId)+"']",p=document.querySelector(b),m=t.focus.bind(t);if(p){I(p,"click",m),S(p,{for:u});const f=lt(p,t.inputId+"-ts-label");S(c,{"aria-labelledby":f}),S(n,{"aria-labelledby":f})}if(o.style.width=l.style.width,t.plugins.names.length){const f="plugin-"+t.plugins.names.join(" plugin-");R([o,r],f)}(e.maxItems===null||e.maxItems>1)&&t.is_select_tag&&S(l,{multiple:"multiple"}),e.placeholder&&S(s,{placeholder:e.placeholder}),!e.splitOn&&e.delimiter&&(e.splitOn=new RegExp("\\s*"+z(e.delimiter)+"+\\s*")),e.load&&e.loadThrottle&&(e.load=Pe(e.load,e.loadThrottle)),I(r,"mousemove",()=>{t.ignoreHover=!1}),I(r,"mouseenter",f=>{var E=dt(f.target,"[data-selectable]",r);E&&t.onOptionHover(f,E)},{capture:!0}),I(r,"click",f=>{const E=dt(f.target,"[data-selectable]");E&&(t.onOptionSelect(f,E),T(f,!0))}),I(a,"click",f=>{var E=dt(f.target,"[data-ts-item]",a);if(E&&t.onItemSelect(f,E)){T(f,!0);return}s.value==""&&(t.onClick(),T(f,!0))}),I(c,"keydown",f=>t.onKeyDown(f)),I(s,"keypress",f=>t.onKeyPress(f)),I(s,"input",f=>t.onInput(f)),I(c,"blur",f=>t.onBlur(f)),I(c,"focus",f=>t.onFocus(f)),I(s,"paste",f=>t.onPaste(f));const w=f=>{const E=f.composedPath()[0];if(!o.contains(E)&&!r.contains(E)){t.isFocused&&t.blur(),t.inputState();return}E==s&&t.isOpen?f.stopPropagation():T(f,!0)},v=()=>{t.isOpen&&t.positionDropdown()};I(document,"mousedown",w),I(window,"scroll",v,d),I(window,"resize",v,d),this._destroy=()=>{document.removeEventListener("mousedown",w),window.removeEventListener("scroll",v),window.removeEventListener("resize",v),p&&p.removeEventListener("click",m)},this.revertSettings={innerHTML:l.innerHTML,tabIndex:l.tabIndex},l.tabIndex=-1,l.insertAdjacentElement("afterend",t.wrapper),t.sync(!1),e.items=[],delete e.optgroups,delete e.options,I(l,"invalid",()=>{t.isValid&&(t.isValid=!1,t.isInvalid=!0,t.refreshState())}),t.updateOriginalInput(),t.refreshItems(),t.close(!1),t.inputState(),t.isSetup=!0,l.disabled?t.disable():l.readOnly?t.setReadOnly(!0):t.enable(),t.on("change",this.onChange),R(l,"tomselected","ts-hidden-accessible"),t.trigger("initialize"),e.preload===!0&&t.preload()}setupOptions(t=[],e=[]){this.addOptions(t),O(e,s=>{this.registerOptionGroup(s)})}setupTemplates(){var t=this,e=t.settings.labelField,s=t.settings.optgroupLabelField,r={optgroup:n=>{let o=document.createElement("div");return o.className="optgroup",o.appendChild(n.options),o},optgroup_header:(n,o)=>'<div class="optgroup-header">'+o(n[s])+"</div>",option:(n,o)=>"<div>"+o(n[e])+"</div>",item:(n,o)=>"<div>"+o(n[e])+"</div>",option_create:(n,o)=>'<div class="create">Add <strong>'+o(n.input)+"</strong>&hellip;</div>",no_results:()=>'<div class="no-results">No results found</div>',loading:()=>'<div class="spinner"></div>',not_loading:()=>{},dropdown:()=>"<div></div>"};t.settings.render=Object.assign({},r,t.settings.render)}setupCallbacks(){var t,e,s={initialize:"onInitialize",change:"onChange",item_add:"onItemAdd",item_remove:"onItemRemove",item_select:"onItemSelect",clear:"onClear",option_add:"onOptionAdd",option_remove:"onOptionRemove",option_clear:"onOptionClear",optgroup_add:"onOptionGroupAdd",optgroup_remove:"onOptionGroupRemove",optgroup_clear:"onOptionGroupClear",dropdown_open:"onDropdownOpen",dropdown_close:"onDropdownClose",type:"onType",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(t in s)e=this.settings[s[t]],e&&this.on(t,e)}sync(t=!0){const e=this,s=t?Ct(e.input,{delimiter:e.settings.delimiter}):e.settings;e.setupOptions(s.options,s.optgroups),e.setValue(s.items||[],!0),e.lastQuery=null}onClick(){var t=this;if(t.activeItems.length>0){t.clearActiveItems(),t.focus();return}t.isFocused&&t.isOpen?t.blur():t.focus()}onMouseDown(){}onChange(){ct(this.input,"input"),ct(this.input,"change")}onPaste(t){var e=this;if(e.isInputHidden||e.isLocked){T(t);return}e.settings.splitOn&&setTimeout(()=>{var s=e.inputValue();if(s.match(e.settings.splitOn)){var r=s.trim().split(e.settings.splitOn);O(r,n=>{$(n)&&(this.options[n]?e.addItem(n):e.createItem(n))})}},0)}onKeyPress(t){var e=this;if(e.isLocked){T(t);return}var s=String.fromCharCode(t.keyCode||t.which);if(e.settings.create&&e.settings.mode==="multi"&&s===e.settings.delimiter){e.createItem(),T(t);return}}onKeyDown(t){var e=this;if(e.ignoreHover=!0,e.isLocked){t.keyCode!==bt&&T(t);return}switch(t.keyCode){case ze:if(N(Z,t)&&e.control_input.value==""){T(t),e.selectAll();return}break;case Ue:e.isOpen&&(T(t,!0),e.close()),e.clearActiveItems();return;case We:if(!e.isOpen&&e.hasOptions)e.open();else if(e.activeOption){let s=e.getAdjacent(e.activeOption,1);s&&e.setActiveOption(s)}T(t);return;case Qe:if(e.activeOption){let s=e.getAdjacent(e.activeOption,-1);s&&e.setActiveOption(s)}T(t);return;case Ke:e.canSelect(e.activeOption)?(e.onOptionSelect(t,e.activeOption),T(t)):(e.settings.create&&e.createItem()||document.activeElement==e.control_input&&e.isOpen)&&T(t);return;case je:e.advanceSelection(-1,t);return;case Ye:e.advanceSelection(1,t);return;case bt:e.settings.selectOnTab&&(e.canSelect(e.activeOption)&&(e.onOptionSelect(t,e.activeOption),T(t)),e.settings.create&&e.createItem()&&T(t));return;case xt:case qe:e.deleteSelection(t);return}e.isInputHidden&&!N(Z,t)&&T(t)}onInput(t){if(this.isLocked)return;const e=this.inputValue();if(this.lastValue!==e){if(this.lastValue=e,e==""){this._onInput();return}this.refreshTimeout&&window.clearTimeout(this.refreshTimeout),this.refreshTimeout=De(()=>{this.refreshTimeout=null,this._onInput()},this.settings.refreshThrottle)}}_onInput(){const t=this.lastValue;this.settings.shouldLoad.call(this,t)&&this.load(t),this.refreshOptions(),this.trigger("type",t)}onOptionHover(t,e){this.ignoreHover||this.setActiveOption(e,!1)}onFocus(t){var e=this,s=e.isFocused;if(e.isDisabled||e.isReadOnly){e.blur(),T(t);return}e.ignoreFocus||(e.isFocused=!0,e.settings.preload==="focus"&&e.preload(),s||e.trigger("focus"),e.activeItems.length||(e.inputState(),e.refreshOptions(!!e.settings.openOnFocus)),e.refreshState())}onBlur(t){if(document.hasFocus()!==!1){var e=this;if(e.isFocused){e.isFocused=!1,e.ignoreFocus=!1;var s=()=>{e.close(),e.setActiveItem(),e.setCaret(e.items.length),e.trigger("blur")};e.settings.create&&e.settings.createOnBlur?e.createItem(null,s):s()}}}onOptionSelect(t,e){var s,r=this;e.parentElement&&e.parentElement.matches("[data-disabled]")||(e.classList.contains("create")?r.createItem(null,()=>{r.settings.closeAfterSelect&&r.close()}):(s=e.dataset.value,typeof s<"u"&&(r.lastQuery=null,r.addItem(s),r.settings.closeAfterSelect&&r.close(),!r.settings.hideSelected&&t.type&&/click/.test(t.type)&&r.setActiveOption(e))))}canSelect(t){return!!(this.isOpen&&t&&this.dropdown_content.contains(t))}onItemSelect(t,e){var s=this;return!s.isLocked&&s.settings.mode==="multi"?(T(t),s.setActiveItem(e,t),!0):!1}canLoad(t){return!(!this.settings.load||this.loadedSearches.hasOwnProperty(t))}load(t){const e=this;if(!e.canLoad(t))return;R(e.wrapper,e.settings.loadingClass),e.loading++;const s=e.loadCallback.bind(e);e.settings.load.call(e,t,s)}loadCallback(t,e){const s=this;s.loading=Math.max(s.loading-1,0),s.lastQuery=null,s.clearActiveOption(),s.setupOptions(t,e),s.refreshOptions(s.isFocused&&!s.isInputHidden),s.loading||B(s.wrapper,s.settings.loadingClass),s.trigger("load",t,e)}preload(){var t=this.wrapper.classList;t.contains("preloaded")||(t.add("preloaded"),this.load(""))}setTextboxValue(t=""){var e=this.control_input,s=e.value!==t;s&&(e.value=t,ct(e,"update"),this.lastValue=t)}getValue(){return this.is_select_tag&&this.input.hasAttribute("multiple")?this.items:this.items.join(this.settings.delimiter)}setValue(t,e){var s=e?[]:["change"];mt(this,s,()=>{this.clear(e),this.addItems(t,e)})}setMaxItems(t){t===0&&(t=null),this.settings.maxItems=t,this.refreshState()}setActiveItem(t,e){var s=this,r,n,o,a,l,c;if(s.settings.mode!=="single"){if(!t){s.clearActiveItems(),s.isFocused&&s.inputState();return}if(r=e&&e.type.toLowerCase(),r==="click"&&N("shiftKey",e)&&s.activeItems.length){for(c=s.getLastActive(),o=Array.prototype.indexOf.call(s.control.children,c),a=Array.prototype.indexOf.call(s.control.children,t),o>a&&(l=o,o=a,a=l),n=o;n<=a;n++)t=s.control.children[n],s.activeItems.indexOf(t)===-1&&s.setActiveItemClass(t);T(e)}else r==="click"&&N(Z,e)||r==="keydown"&&N("shiftKey",e)?t.classList.contains("active")?s.removeActiveItem(t):s.setActiveItemClass(t):(s.clearActiveItems(),s.setActiveItemClass(t));s.inputState(),s.isFocused||s.focus()}}setActiveItemClass(t){const e=this,s=e.control.querySelector(".last-active");s&&B(s,"last-active"),R(t,"active last-active"),e.trigger("item_select",t),e.activeItems.indexOf(t)==-1&&e.activeItems.push(t)}removeActiveItem(t){var e=this.activeItems.indexOf(t);this.activeItems.splice(e,1),B(t,"active")}clearActiveItems(){B(this.activeItems,"active"),this.activeItems=[]}setActiveOption(t,e=!0){t!==this.activeOption&&(this.clearActiveOption(),t&&(this.activeOption=t,S(this.focus_node,{"aria-activedescendant":t.getAttribute("id")}),S(t,{"aria-selected":"true"}),R(t,"active"),e&&this.scrollToOption(t)))}scrollToOption(t,e){if(!t)return;const s=this.dropdown_content,r=s.clientHeight,n=s.scrollTop||0,o=t.offsetHeight,a=t.getBoundingClientRect().top-s.getBoundingClientRect().top+n;a+o>r+n?this.scroll(a-r+o,e):a<n&&this.scroll(a,e)}scroll(t,e){const s=this.dropdown_content;e&&(s.style.scrollBehavior=e),s.scrollTop=t,s.style.scrollBehavior=""}clearActiveOption(){this.activeOption&&(B(this.activeOption,"active"),S(this.activeOption,{"aria-selected":null})),this.activeOption=null,S(this.focus_node,{"aria-activedescendant":null})}selectAll(){const t=this;if(t.settings.mode==="single")return;const e=t.controlChildren();e.length&&(t.inputState(),t.close(),t.activeItems=e,O(e,s=>{t.setActiveItemClass(s)}))}inputState(){var t=this;t.control.contains(t.control_input)&&(S(t.control_input,{placeholder:t.settings.placeholder}),t.activeItems.length>0||!t.isFocused&&t.settings.hidePlaceholder&&t.items.length>0?(t.setTextboxValue(),t.isInputHidden=!0):(t.settings.hidePlaceholder&&t.items.length>0&&S(t.control_input,{placeholder:""}),t.isInputHidden=!1),t.wrapper.classList.toggle("input-hidden",t.isInputHidden))}inputValue(){return this.control_input.value.trim()}focus(){var t=this;t.isDisabled||t.isReadOnly||(t.ignoreFocus=!0,t.control_input.offsetWidth?t.control_input.focus():t.focus_node.focus(),setTimeout(()=>{t.ignoreFocus=!1,t.onFocus()},0))}blur(){this.focus_node.blur(),this.onBlur()}getScoreFunction(t){return this.sifter.getScoreFunction(t,this.getSearchOptions())}getSearchOptions(){var t=this.settings,e=t.sortField;return typeof t.sortField=="string"&&(e=[{field:t.sortField}]),{fields:t.searchField,conjunction:t.searchConjunction,sort:e,nesting:t.nesting}}search(t){var e,s,r=this,n=this.getSearchOptions();if(r.settings.score&&(s=r.settings.score.call(r,t),typeof s!="function"))throw new Error('Tom Select "score" setting must be a function that returns a function');return t!==r.lastQuery?(r.lastQuery=t,e=r.sifter.search(t,Object.assign(n,{score:s})),r.currentResults=e):e=Object.assign({},r.currentResults),r.settings.hideSelected&&(e.items=e.items.filter(o=>{let a=$(o.id);return!(a&&r.items.indexOf(a)!==-1)})),e}refreshOptions(t=!0){var e,s,r,n,o,a,l,c,d,h;const u={},b=[];var p=this,m=p.inputValue();const w=m===p.lastQuery||m==""&&p.lastQuery==null;var v=p.search(m),f=null,E=p.settings.shouldOpen||!1,M=p.dropdown_content;w&&(f=p.activeOption,f&&(d=f.closest("[data-group]"))),n=v.items.length,typeof p.settings.maxOptions=="number"&&(n=Math.min(n,p.settings.maxOptions)),n>0&&(E=!0);const k=(y,A)=>{let x=u[y];if(x!==void 0){let C=b[x];if(C!==void 0)return[x,C.fragment]}let _=document.createDocumentFragment();return x=b.length,b.push({fragment:_,order:A,optgroup:y}),[x,_]};for(e=0;e<n;e++){let y=v.items[e];if(!y)continue;let A=y.id,x=p.options[A];if(x===void 0)continue;let _=X(A),C=p.getOption(_,!0);for(p.settings.hideSelected||C.classList.toggle("selected",p.items.includes(_)),o=x[p.settings.optgroupField]||"",a=Array.isArray(o)?o:[o],s=0,r=a&&a.length;s<r;s++){o=a[s];let j=x.$order,Q=p.optgroups[o];Q===void 0?o="":j=Q.$order;const[Bt,Ht]=k(o,j);s>0&&(C=C.cloneNode(!0),S(C,{id:x.$id+"-clone-"+s,"aria-selected":null}),C.classList.add("ts-cloned"),B(C,"active"),p.activeOption&&p.activeOption.dataset.value==A&&d&&d.dataset.group===o.toString()&&(f=C)),Ht.appendChild(C),o!=""&&(u[o]=Bt)}}p.settings.lockOptgroupOrder&&b.sort((y,A)=>y.order-A.order),l=document.createDocumentFragment(),O(b,y=>{let A=y.fragment,x=y.optgroup;if(!A||!A.children.length)return;let _=p.optgroups[x];if(_!==void 0){let C=document.createDocumentFragment(),j=p.render("optgroup_header",_);V(C,j),V(C,A);let Q=p.render("optgroup",{group:_,options:C});V(l,Q)}else V(l,A)}),M.innerHTML="",V(M,l),p.settings.highlight&&(Ge(M),v.query.length&&v.tokens.length&&O(v.tokens,y=>{Ve(M,y.regex)}));var D=y=>{let A=p.render(y,{input:m});return A&&(E=!0,M.insertBefore(A,M.firstChild)),A};if(p.loading?D("loading"):p.settings.shouldLoad.call(p,m)?v.items.length===0&&D("no_results"):D("not_loading"),c=p.canCreate(m),c&&(h=D("option_create")),p.hasOptions=v.items.length>0||c,E){if(v.items.length>0){if(!f&&p.settings.mode==="single"&&p.items[0]!=null&&(f=p.getOption(p.items[0])),!M.contains(f)){let y=0;h&&!p.settings.addPrecedence&&(y=1),f=p.selectable()[y]}}else h&&(f=h);t&&!p.isOpen&&(p.open(),p.scrollToOption(f,"auto")),p.setActiveOption(f)}else p.clearActiveOption(),t&&p.isOpen&&p.close(!1)}selectable(){return this.dropdown_content.querySelectorAll("[data-selectable]")}addOption(t,e=!1){const s=this;if(Array.isArray(t))return s.addOptions(t,e),!1;const r=$(t[s.settings.valueField]);return r===null||s.options.hasOwnProperty(r)?!1:(t.$order=t.$order||++s.order,t.$id=s.inputId+"-opt-"+t.$order,s.options[r]=t,s.lastQuery=null,e&&(s.userOptions[r]=e,s.trigger("option_add",r,t)),r)}addOptions(t,e=!1){O(t,s=>{this.addOption(s,e)})}registerOption(t){return this.addOption(t)}registerOptionGroup(t){var e=$(t[this.settings.optgroupValueField]);return e===null?!1:(t.$order=t.$order||++this.order,this.optgroups[e]=t,e)}addOptionGroup(t,e){var s;e[this.settings.optgroupValueField]=t,(s=this.registerOptionGroup(e))&&this.trigger("optgroup_add",s,e)}removeOptionGroup(t){this.optgroups.hasOwnProperty(t)&&(delete this.optgroups[t],this.clearCache(),this.trigger("optgroup_remove",t))}clearOptionGroups(){this.optgroups={},this.clearCache(),this.trigger("optgroup_clear")}updateOption(t,e){const s=this;var r,n;const o=$(t),a=$(e[s.settings.valueField]);if(o===null)return;const l=s.options[o];if(l==null)return;if(typeof a!="string")throw new Error("Value must be set in option data");const c=s.getOption(o),d=s.getItem(o);if(e.$order=e.$order||l.$order,delete s.options[o],s.uncacheValue(a),s.options[a]=e,c){if(s.dropdown_content.contains(c)){const h=s._render("option",e);ht(c,h),s.activeOption===c&&s.setActiveOption(h)}c.remove()}d&&(n=s.items.indexOf(o),n!==-1&&s.items.splice(n,1,a),r=s._render("item",e),d.classList.contains("active")&&R(r,"active"),ht(d,r)),s.lastQuery=null}removeOption(t,e){const s=this;t=X(t),s.uncacheValue(t),delete s.userOptions[t],delete s.options[t],s.lastQuery=null,s.trigger("option_remove",t),s.removeItem(t,e)}clearOptions(t){const e=(t||this.clearFilter).bind(this);this.loadedSearches={},this.userOptions={},this.clearCache();const s={};O(this.options,(r,n)=>{e(r,n)&&(s[n]=r)}),this.options=this.sifter.items=s,this.lastQuery=null,this.trigger("option_clear")}clearFilter(t,e){return this.items.indexOf(e)>=0}getOption(t,e=!1){const s=$(t);if(s===null)return null;const r=this.options[s];if(r!=null){if(r.$div)return r.$div;if(e)return this._render("option",r)}return null}getAdjacent(t,e,s="option"){var r=this,n;if(!t)return null;s=="item"?n=r.controlChildren():n=r.dropdown_content.querySelectorAll("[data-selectable]");for(let o=0;o<n.length;o++)if(n[o]==t)return e>0?n[o+1]:n[o-1];return null}getItem(t){if(typeof t=="object")return t;var e=$(t);return e!==null?this.control.querySelector(`[data-value="${vt(e)}"]`):null}addItems(t,e){var s=this,r=Array.isArray(t)?t:[t];r=r.filter(o=>s.items.indexOf(o)===-1);const n=r[r.length-1];r.forEach(o=>{s.isPending=o!==n,s.addItem(o,e)})}addItem(t,e){var s=e?[]:["change","dropdown_close"];mt(this,s,()=>{var r,n;const o=this,a=o.settings.mode,l=$(t);if(!(l&&o.items.indexOf(l)!==-1&&(a==="single"&&o.close(),a==="single"||!o.settings.duplicates))&&!(l===null||!o.options.hasOwnProperty(l))&&(a==="single"&&o.clear(e),!(a==="multi"&&o.isFull()))){if(r=o._render("item",o.options[l]),o.control.contains(r)&&(r=r.cloneNode(!0)),n=o.isFull(),o.items.splice(o.caretPos,0,l),o.insertAtCaret(r),o.isSetup){if(!o.isPending&&o.settings.hideSelected){let c=o.getOption(l),d=o.getAdjacent(c,1);d&&o.setActiveOption(d)}!o.isPending&&!o.settings.closeAfterSelect&&o.refreshOptions(o.isFocused&&a!=="single"),o.settings.closeAfterSelect!=!1&&o.isFull()?o.close():o.isPending||o.positionDropdown(),o.trigger("item_add",l,r),o.isPending||o.updateOriginalInput({silent:e})}(!o.isPending||!n&&o.isFull())&&(o.inputState(),o.refreshState())}})}removeItem(t=null,e){const s=this;if(t=s.getItem(t),!t)return;var r,n;const o=t.dataset.value;r=yt(t),t.remove(),t.classList.contains("active")&&(n=s.activeItems.indexOf(t),s.activeItems.splice(n,1),B(t,"active")),s.items.splice(r,1),s.lastQuery=null,!s.settings.persist&&s.userOptions.hasOwnProperty(o)&&s.removeOption(o,e),r<s.caretPos&&s.setCaret(s.caretPos-1),s.updateOriginalInput({silent:e}),s.refreshState(),s.positionDropdown(),s.trigger("item_remove",o,t)}createItem(t=null,e=()=>{}){arguments.length===3&&(e=arguments[2]),typeof e!="function"&&(e=()=>{});var s=this,r=s.caretPos,n;if(t=t||s.inputValue(),!s.canCreate(t))return e(),!1;s.lock();var o=!1,a=l=>{if(s.unlock(),!l||typeof l!="object")return e();var c=$(l[s.settings.valueField]);if(typeof c!="string")return e();s.setTextboxValue(),s.addOption(l,!0),s.setCaret(r),s.addItem(c),e(l),o=!0};return typeof s.settings.create=="function"?n=s.settings.create.call(this,t,a):n={[s.settings.labelField]:t,[s.settings.valueField]:t},o||a(n),!0}refreshItems(){var t=this;t.lastQuery=null,t.isSetup&&t.addItems(t.items),t.updateOriginalInput(),t.refreshState()}refreshState(){const t=this;t.refreshValidityState();const e=t.isFull(),s=t.isLocked;t.wrapper.classList.toggle("rtl",t.rtl);const r=t.wrapper.classList;r.toggle("focus",t.isFocused),r.toggle("disabled",t.isDisabled),r.toggle("readonly",t.isReadOnly),r.toggle("required",t.isRequired),r.toggle("invalid",!t.isValid),r.toggle("locked",s),r.toggle("full",e),r.toggle("input-active",t.isFocused&&!t.isInputHidden),r.toggle("dropdown-active",t.isOpen),r.toggle("has-options",Ne(t.options)),r.toggle("has-items",t.items.length>0)}refreshValidityState(){var t=this;t.input.validity&&(t.isValid=t.input.validity.valid,t.isInvalid=!t.isValid)}isFull(){return this.settings.maxItems!==null&&this.items.length>=this.settings.maxItems}updateOriginalInput(t={}){const e=this;var s,r;const n=e.input.querySelector('option[value=""]');if(e.is_select_tag){let c=function(d,h,u){return d||(d=P('<option value="'+at(h)+'">'+at(u)+"</option>")),d!=n&&e.input.append(d),a.push(d),(d!=n||l>0)&&(d.selected=!0),d};var o=c;const a=[],l=e.input.querySelectorAll("option:checked").length;e.input.querySelectorAll("option:checked").forEach(d=>{d.selected=!1}),e.items.length==0&&e.settings.mode=="single"?c(n,"",""):e.items.forEach(d=>{if(s=e.options[d],r=s[e.settings.labelField]||"",a.includes(s.$option)){const h=e.input.querySelector(`option[value="${vt(d)}"]:not(:checked)`);c(h,d,r)}else s.$option=c(s.$option,d,r)})}else e.input.value=e.getValue();e.isSetup&&(t.silent||e.trigger("change",e.getValue()))}open(){var t=this;t.isLocked||t.isOpen||t.settings.mode==="multi"&&t.isFull()||(t.isOpen=!0,S(t.focus_node,{"aria-expanded":"true"}),t.refreshState(),q(t.dropdown,{visibility:"hidden",display:"block"}),t.positionDropdown(),q(t.dropdown,{visibility:"visible",display:"block"}),t.focus(),t.trigger("dropdown_open",t.dropdown))}close(t=!0){var e=this,s=e.isOpen;t&&(e.setTextboxValue(),e.settings.mode==="single"&&e.items.length&&e.inputState()),e.isOpen=!1,S(e.focus_node,{"aria-expanded":"false"}),q(e.dropdown,{display:"none"}),e.settings.hideSelected&&e.clearActiveOption(),e.refreshState(),s&&e.trigger("dropdown_close",e.dropdown)}positionDropdown(){if(this.settings.dropdownParent==="body"){var t=this.control,e=t.getBoundingClientRect(),s=t.offsetHeight+e.top+window.scrollY,r=e.left+window.scrollX;q(this.dropdown,{width:e.width+"px",top:s+"px",left:r+"px"})}}clear(t){var e=this;if(e.items.length){var s=e.controlChildren();O(s,r=>{e.removeItem(r,!0)}),e.inputState(),t||e.updateOriginalInput(),e.trigger("clear")}}insertAtCaret(t){const e=this,s=e.caretPos,r=e.control;r.insertBefore(t,r.children[s]||null),e.setCaret(s+1)}deleteSelection(t){var e,s,r,n,o=this;e=t&&t.keyCode===xt?-1:1,s=Be(o.control_input);const a=[];if(o.activeItems.length)n=wt(o.activeItems,e),r=yt(n),e>0&&r++,O(o.activeItems,l=>a.push(l));else if((o.isFocused||o.settings.mode==="single")&&o.items.length){const l=o.controlChildren();let c;e<0&&s.start===0&&s.length===0?c=l[o.caretPos-1]:e>0&&s.start===o.inputValue().length&&(c=l[o.caretPos]),c!==void 0&&a.push(c)}if(!o.shouldDelete(a,t))return!1;for(T(t,!0),typeof r<"u"&&o.setCaret(r);a.length;)o.removeItem(a.pop());return o.inputState(),o.positionDropdown(),o.refreshOptions(!1),!0}shouldDelete(t,e){const s=t.map(r=>r.dataset.value);return!(!s.length||typeof this.settings.onDelete=="function"&&this.settings.onDelete(s,e)===!1)}advanceSelection(t,e){var s,r,n=this;n.rtl&&(t*=-1),!n.inputValue().length&&(N(Z,e)||N("shiftKey",e)?(s=n.getLastActive(t),s?s.classList.contains("active")?r=n.getAdjacent(s,t,"item"):r=s:t>0?r=n.control_input.nextElementSibling:r=n.control_input.previousElementSibling,r&&(r.classList.contains("active")&&n.removeActiveItem(s),n.setActiveItemClass(r))):n.moveCaret(t))}moveCaret(t){}getLastActive(t){let e=this.control.querySelector(".last-active");if(e)return e;var s=this.control.querySelectorAll(".active");if(s)return wt(s,t)}setCaret(t){this.caretPos=this.items.length}controlChildren(){return Array.from(this.control.querySelectorAll("[data-ts-item]"))}lock(){this.setLocked(!0)}unlock(){this.setLocked(!1)}setLocked(t=this.isReadOnly||this.isDisabled){this.isLocked=t,this.refreshState()}disable(){this.setDisabled(!0),this.close()}enable(){this.setDisabled(!1)}setDisabled(t){this.focus_node.tabIndex=t?-1:this.tabIndex,this.isDisabled=t,this.input.disabled=t,this.control_input.disabled=t,this.setLocked()}setReadOnly(t){this.isReadOnly=t,this.input.readOnly=t,this.control_input.readOnly=t,this.setLocked()}destroy(){var t=this,e=t.revertSettings;t.trigger("destroy"),t.off(),t.wrapper.remove(),t.dropdown.remove(),t.input.innerHTML=e.innerHTML,t.input.tabIndex=e.tabIndex,B(t.input,"tomselected","ts-hidden-accessible"),t._destroy(),delete t.input.tomselect}render(t,e){var s,r;const n=this;if(typeof this.settings.render[t]!="function"||(r=n.settings.render[t].call(this,e,at),!r))return null;if(r=P(r),t==="option"||t==="option_create"?e[n.settings.disabledField]?S(r,{"aria-disabled":"true"}):S(r,{"data-selectable":""}):t==="optgroup"&&(s=e.group[n.settings.optgroupValueField],S(r,{"data-group":s}),e.group[n.settings.disabledField]&&S(r,{"data-disabled":""})),t==="option"||t==="item"){const o=X(e[n.settings.valueField]);S(r,{"data-value":o}),t==="item"?(R(r,n.settings.itemClass),S(r,{"data-ts-item":""})):(R(r,n.settings.optionClass),S(r,{role:"option",id:e.$id}),e.$div=r,n.options[o]=e)}return r}_render(t,e){const s=this.render(t,e);if(s==null)throw"HTMLElement expected";return s}clearCache(){O(this.options,t=>{t.$div&&(t.$div.remove(),delete t.$div)})}uncacheValue(t){const e=this.getOption(t);e&&e.remove()}canCreate(t){return this.settings.create&&t.length>0&&this.settings.createFilter.call(this,t)}hook(t,e,s){var r=this,n=r[e];r[e]=function(){var o,a;return t==="after"&&(o=n.apply(r,arguments)),a=s.apply(r,arguments),t==="instead"?a:(t==="before"&&(o=n.apply(r,arguments)),o)}}}const Je=(i,t,e,s)=>{i.addEventListener(t,e,s)};function Xe(){Je(this.input,"change",()=>{this.sync()})}const ts=i=>typeof i>"u"||i===null?null:es(i),es=i=>typeof i=="boolean"?i?"1":"0":i+"",St=(i,t=!1)=>{i&&(i.preventDefault(),t&&i.stopPropagation())},ss=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(is(i)){var t=document.createElement("template");return t.innerHTML=i.trim(),t.content.firstChild}return document.querySelector(i)},is=i=>typeof i=="string"&&i.indexOf("<")>-1;function rs(i){var t=this,e=t.onOptionSelect;t.settings.hideSelected=!1;const s=Object.assign({className:"tomselect-checkbox",checkedClassNames:void 0,uncheckedClassNames:void 0},i);var r=function(a,l){l?(a.checked=!0,s.uncheckedClassNames&&a.classList.remove(...s.uncheckedClassNames),s.checkedClassNames&&a.classList.add(...s.checkedClassNames)):(a.checked=!1,s.checkedClassNames&&a.classList.remove(...s.checkedClassNames),s.uncheckedClassNames&&a.classList.add(...s.uncheckedClassNames))},n=function(a){setTimeout(()=>{var l=a.querySelector("input."+s.className);l instanceof HTMLInputElement&&r(l,a.classList.contains("selected"))},1)};t.hook("after","setupTemplates",()=>{var o=t.settings.render.option;t.settings.render.option=(a,l)=>{var c=ss(o.call(t,a,l)),d=document.createElement("input");s.className&&d.classList.add(s.className),d.addEventListener("click",function(u){St(u)}),d.type="checkbox";const h=ts(a[t.settings.valueField]);return r(d,!!(h&&t.items.indexOf(h)>-1)),c.prepend(d),c}}),t.on("item_remove",o=>{var a=t.getOption(o);a&&(a.classList.remove("selected"),n(a))}),t.on("item_add",o=>{var a=t.getOption(o);a&&n(a)}),t.hook("instead","onOptionSelect",(o,a)=>{if(a.classList.contains("selected")){a.classList.remove("selected"),t.removeItem(a.dataset.value),t.refreshOptions(),St(o,!0);return}e.call(t,o,a),n(a)})}const ns=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(os(i)){var t=document.createElement("template");return t.innerHTML=i.trim(),t.content.firstChild}return document.querySelector(i)},os=i=>typeof i=="string"&&i.indexOf("<")>-1;function as(i){const t=this,e=Object.assign({className:"clear-button",title:"Clear All",html:s=>`<div class="${s.className}" title="${s.title}">&#10799;</div>`},i);t.on("initialize",()=>{var s=ns(e.html(e));s.addEventListener("click",r=>{t.isLocked||(t.clear(),t.settings.mode==="single"&&t.settings.allowEmptyOption&&t.addItem(""),r.preventDefault(),r.stopPropagation())}),t.control.appendChild(s)})}const ls=(i,t=!1)=>{i&&(i.preventDefault(),t&&i.stopPropagation())},G=(i,t,e,s)=>{i.addEventListener(t,e,s)},cs=(i,t)=>{if(Array.isArray(i))i.forEach(t);else for(var e in i)i.hasOwnProperty(e)&&t(i[e],e)},ds=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(hs(i)){var t=document.createElement("template");return t.innerHTML=i.trim(),t.content.firstChild}return document.querySelector(i)},hs=i=>typeof i=="string"&&i.indexOf("<")>-1,us=(i,t)=>{cs(t,(e,s)=>{e==null?i.removeAttribute(s):i.setAttribute(s,""+e)})},ps=(i,t)=>{var e;(e=i.parentNode)==null||e.insertBefore(t,i.nextSibling)},fs=(i,t)=>{var e;(e=i.parentNode)==null||e.insertBefore(t,i)},gs=(i,t)=>{do{var e;if(t=(e=t)==null?void 0:e.previousElementSibling,i==t)return!0}while(t&&t.previousElementSibling);return!1};function ms(){var i=this;if(i.settings.mode!=="multi")return;var t=i.lock,e=i.unlock;let s=!0,r;i.hook("after","setupTemplates",()=>{var n=i.settings.render.item;i.settings.render.item=(o,a)=>{const l=ds(n.call(i,o,a));us(l,{draggable:"true"});const c=m=>{s||ls(m),m.stopPropagation()},d=m=>{r=l,setTimeout(()=>{l.classList.add("ts-dragging")},0)},h=m=>{m.preventDefault(),l.classList.add("ts-drag-over"),b(l,r)},u=()=>{l.classList.remove("ts-drag-over")},b=(m,w)=>{w!==void 0&&(gs(w,l)?ps(m,w):fs(m,w))},p=()=>{var m;document.querySelectorAll(".ts-drag-over").forEach(v=>v.classList.remove("ts-drag-over")),(m=r)==null||m.classList.remove("ts-dragging"),r=void 0;var w=[];i.control.querySelectorAll("[data-value]").forEach(v=>{if(v.dataset.value){let f=v.dataset.value;f&&w.push(f)}}),i.setValue(w)};return G(l,"mousedown",c),G(l,"dragstart",d),G(l,"dragenter",h),G(l,"dragover",h),G(l,"dragleave",u),G(l,"dragend",p),l}}),i.hook("instead","lock",()=>(s=!1,t.call(i))),i.hook("instead","unlock",()=>(s=!0,e.call(i)))}const vs=(i,t=!1)=>{i&&(i.preventDefault(),t&&i.stopPropagation())},ws=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(ys(i)){var t=document.createElement("template");return t.innerHTML=i.trim(),t.content.firstChild}return document.querySelector(i)},ys=i=>typeof i=="string"&&i.indexOf("<")>-1;function xs(i){const t=this,e=Object.assign({title:"Untitled",headerClass:"dropdown-header",titleRowClass:"dropdown-header-title",labelClass:"dropdown-header-label",closeClass:"dropdown-header-close",html:s=>'<div class="'+s.headerClass+'"><div class="'+s.titleRowClass+'"><span class="'+s.labelClass+'">'+s.title+'</span><a class="'+s.closeClass+'">&times;</a></div></div>'},i);t.on("initialize",()=>{var s=ws(e.html(e)),r=s.querySelector("."+e.closeClass);r&&r.addEventListener("click",n=>{vs(n,!0),t.close()}),t.dropdown.insertBefore(s,t.dropdown.firstChild)})}const bs=(i,t)=>{if(Array.isArray(i))i.forEach(t);else for(var e in i)i.hasOwnProperty(e)&&t(i[e],e)},As=(i,...t)=>{var e=Cs(t);i=Es(i),i.map(s=>{e.map(r=>{s.classList.remove(r)})})},Cs=i=>{var t=[];return bs(i,e=>{typeof e=="string"&&(e=e.trim().split(/[\t\n\f\r\s]/)),Array.isArray(e)&&(t=t.concat(e))}),t.filter(Boolean)},Es=i=>(Array.isArray(i)||(i=[i]),i),Ss=(i,t)=>{if(!i)return-1;t=t||i.nodeName;for(var e=0;i=i.previousElementSibling;)i.matches(t)&&e++;return e};function Ts(){var i=this;i.hook("instead","setCaret",t=>{i.settings.mode==="single"||!i.control.contains(i.control_input)?t=i.items.length:(t=Math.max(0,Math.min(i.items.length,t)),t!=i.caretPos&&!i.isPending&&i.controlChildren().forEach((e,s)=>{s<t?i.control_input.insertAdjacentElement("beforebegin",e):i.control.appendChild(e)})),i.caretPos=t}),i.hook("instead","moveCaret",t=>{if(!i.isFocused)return;const e=i.getLastActive(t);if(e){const s=Ss(e);i.setCaret(t>0?s+1:s),i.setActiveItem(),As(e,"last-active")}else i.setCaret(i.caretPos+t)})}const Os=27,_s=9,Is=(i,t=!1)=>{i&&(i.preventDefault(),t&&i.stopPropagation())},Ls=(i,t,e,s)=>{i.addEventListener(t,e,s)},Ms=(i,t)=>{if(Array.isArray(i))i.forEach(t);else for(var e in i)i.hasOwnProperty(e)&&t(i[e],e)},Tt=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(Rs(i)){var t=document.createElement("template");return t.innerHTML=i.trim(),t.content.firstChild}return document.querySelector(i)},Rs=i=>typeof i=="string"&&i.indexOf("<")>-1,Fs=(i,...t)=>{var e=$s(t);i=ks(i),i.map(s=>{e.map(r=>{s.classList.add(r)})})},$s=i=>{var t=[];return Ms(i,e=>{typeof e=="string"&&(e=e.trim().split(/[\t\n\f\r\s]/)),Array.isArray(e)&&(t=t.concat(e))}),t.filter(Boolean)},ks=i=>(Array.isArray(i)||(i=[i]),i);function Ds(){const i=this;i.settings.shouldOpen=!0,i.hook("before","setup",()=>{i.focus_node=i.control,Fs(i.control_input,"dropdown-input");const t=Tt('<div class="dropdown-input-wrap">');t.append(i.control_input),i.dropdown.insertBefore(t,i.dropdown.firstChild);const e=Tt('<input class="items-placeholder" tabindex="-1" />');e.placeholder=i.settings.placeholder||"",i.control.append(e)}),i.on("initialize",()=>{i.control_input.addEventListener("keydown",e=>{switch(e.keyCode){case Os:i.isOpen&&(Is(e,!0),i.close()),i.clearActiveItems();return;case _s:i.focus_node.tabIndex=-1;break}return i.onKeyDown.call(i,e)}),i.on("blur",()=>{i.focus_node.tabIndex=i.isDisabled?-1:i.tabIndex}),i.on("dropdown_open",()=>{i.control_input.focus()});const t=i.onBlur;i.hook("instead","onBlur",e=>{if(!(e&&e.relatedTarget==i.control_input))return t.call(i)}),Ls(i.control_input,"blur",()=>i.onBlur()),i.hook("before","close",()=>{i.isOpen&&i.focus_node.focus({preventScroll:!0})})})}const J=(i,t,e,s)=>{i.addEventListener(t,e,s)};function Ps(){var i=this;i.on("initialize",()=>{var t=document.createElement("span"),e=i.control_input;t.style.cssText="position:absolute; top:-99999px; left:-99999px; width:auto; padding:0; white-space:pre; ",i.wrapper.appendChild(t);var s=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"];for(const n of s)t.style[n]=e.style[n];var r=()=>{t.textContent=e.value,e.style.width=t.clientWidth+"px"};r(),i.on("update item_add item_remove",r),J(e,"input",r),J(e,"keyup",r),J(e,"blur",r),J(e,"update",r)})}function Bs(){var i=this,t=i.deleteSelection;this.hook("instead","deleteSelection",e=>i.activeItems.length?t.call(i,e):!1)}function Hs(){this.hook("instead","setActiveItem",()=>{}),this.hook("instead","selectAll",()=>{})}const Ot=37,Ns=39,Vs=(i,t,e)=>{for(;i&&i.matches;){if(i.matches(t))return i;i=i.parentNode}},Gs=(i,t)=>{if(!i)return-1;t=t||i.nodeName;for(var e=0;i=i.previousElementSibling;)i.matches(t)&&e++;return e};function zs(){var i=this,t=i.onKeyDown;i.hook("instead","onKeyDown",e=>{var s,r,n,o;if(!i.isOpen||!(e.keyCode===Ot||e.keyCode===Ns))return t.call(i,e);i.ignoreHover=!0,o=Vs(i.activeOption,"[data-group]"),s=Gs(i.activeOption,"[data-selectable]"),o&&(e.keyCode===Ot?o=o.previousSibling:o=o.nextSibling,o&&(n=o.querySelectorAll("[data-selectable]"),r=n[Math.min(n.length-1,s)],r&&i.setActiveOption(r)))})}const Ks=i=>(i+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),_t=(i,t=!1)=>{i&&(i.preventDefault(),t&&i.stopPropagation())},It=(i,t,e,s)=>{i.addEventListener(t,e,s)},Lt=i=>{if(i.jquery)return i[0];if(i instanceof HTMLElement)return i;if(Us(i)){var t=document.createElement("template");return t.innerHTML=i.trim(),t.content.firstChild}return document.querySelector(i)},Us=i=>typeof i=="string"&&i.indexOf("<")>-1;function js(i){const t=Object.assign({label:"&times;",title:"Remove",className:"remove",append:!0},i);var e=this;if(t.append){var s='<a href="javascript:void(0)" class="'+t.className+'" tabindex="-1" title="'+Ks(t.title)+'">'+t.label+"</a>";e.hook("after","setupTemplates",()=>{var r=e.settings.render.item;e.settings.render.item=(n,o)=>{var a=Lt(r.call(e,n,o)),l=Lt(s);return a.appendChild(l),It(l,"mousedown",c=>{_t(c,!0)}),It(l,"click",c=>{e.isLocked||(_t(c,!0),!e.isLocked&&e.shouldDelete([a],c)&&(e.removeItem(a),e.refreshOptions(!1),e.inputState()))}),a}})}}function Qs(i){const t=this,e=Object.assign({text:s=>s[t.settings.labelField]},i);t.on("item_remove",function(s){if(t.isFocused&&t.control_input.value.trim()===""){var r=t.options[s];r&&t.setTextboxValue(e.text.call(t,r))}})}const Ys=(i,t)=>{if(Array.isArray(i))i.forEach(t);else for(var e in i)i.hasOwnProperty(e)&&t(i[e],e)},Ws=(i,...t)=>{var e=qs(t);i=Zs(i),i.map(s=>{e.map(r=>{s.classList.add(r)})})},qs=i=>{var t=[];return Ys(i,e=>{typeof e=="string"&&(e=e.trim().split(/[\t\n\f\r\s]/)),Array.isArray(e)&&(t=t.concat(e))}),t.filter(Boolean)},Zs=i=>(Array.isArray(i)||(i=[i]),i);function Js(){const i=this,t=i.canLoad,e=i.clearActiveOption,s=i.loadCallback;var r={},n,o=!1,a,l=[];if(i.settings.shouldLoadMore||(i.settings.shouldLoadMore=()=>{if(n.clientHeight/(n.scrollHeight-n.scrollTop)>.9)return!0;if(i.activeOption){var u=i.selectable(),b=Array.from(u).indexOf(i.activeOption);if(b>=u.length-2)return!0}return!1}),!i.settings.firstUrl)throw"virtual_scroll plugin requires a firstUrl() method";i.settings.sortField=[{field:"$order"},{field:"$score"}];const c=h=>typeof i.settings.maxOptions=="number"&&n.children.length>=i.settings.maxOptions?!1:!!(h in r&&r[h]),d=(h,u)=>i.items.indexOf(u)>=0||l.indexOf(u)>=0;i.setNextUrl=(h,u)=>{r[h]=u},i.getUrl=h=>{if(h in r){const u=r[h];return r[h]=!1,u}return i.clearPagination(),i.settings.firstUrl.call(i,h)},i.clearPagination=()=>{r={}},i.hook("instead","clearActiveOption",()=>{if(!o)return e.call(i)}),i.hook("instead","canLoad",h=>h in r?c(h):t.call(i,h)),i.hook("instead","loadCallback",(h,u)=>{if(!o)i.clearOptions(d);else if(a){const b=h[0];b!==void 0&&(a.dataset.value=b[i.settings.valueField])}s.call(i,h,u),o=!1}),i.hook("after","refreshOptions",()=>{const h=i.lastValue;var u;c(h)?(u=i.render("loading_more",{query:h}),u&&(u.setAttribute("data-selectable",""),a=u)):h in r&&!n.querySelector(".no-results")&&(u=i.render("no_more_results",{query:h})),u&&(Ws(u,i.settings.optionClass),n.append(u))}),i.on("initialize",()=>{l=Object.keys(i.options),n=i.dropdown_content,i.settings.render=Object.assign({},{loading_more:()=>'<div class="loading-more-results">Loading more results ... </div>',no_more_results:()=>'<div class="no-more-results">No more results</div>'},i.settings.render),n.addEventListener("scroll",()=>{i.settings.shouldLoadMore.call(i)&&c(i.lastValue)&&(o||(o=!0,i.load.call(i,i.lastValue)))})})}L.define("change_listener",Xe);L.define("checkbox_options",rs);L.define("clear_button",as);L.define("drag_drop",ms);L.define("dropdown_header",xs);L.define("caret_position",Ts);L.define("dropdown_input",Ds);L.define("input_autogrow",Ps);L.define("no_backspace_delete",Bs);L.define("no_active_items",Hs);L.define("optgroup_columns",zs);L.define("remove_button",js);L.define("restore_on_backspace",Qs);L.define("virtual_scroll",Js);window.TomSelect=L;document.addEventListener("DOMContentLoaded",()=>{new pe});
