(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();let w=null;const p={init:h=>{w=h},sortEntity:h=>[...h].sort((t,e)=>t.zIndex-e.zIndex||t.y-e.y),createImage:(h,t=[])=>{const e=new Image;return e.src=h,e.sprites=t,e},drawSprite:(h,t,e,s,i,a)=>{let o=h.sprites[t];w.ctx.drawImage(h,o.x,o.y,i,a,e-o.w/2,s-o.h/2,o.w,o.h)},drawAnimatedSprite:(h,t,e,s,i,a,o)=>{let r=h.sprites[t];w.ctx.drawImage(h,r.frames[parseInt(e)],r.y,a,o,s-r.w/2,i-r.h/2,r.w,r.h)},playAudio:h=>{if(w.stat("soundEnabled")){const t=new Audio(h);t.volume=.3,t.play().catch(()=>{})}}},x="/tower-defense/assets/laser-DtsNZ3_M.png",E="data:audio/mpeg;base64,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",n={playerLifes:10,coins:180,game:{soundEnabled:!0,showNormalDamage:!0},towers:{laser:{costs:80,color:"#ffff03",size:20,fireRange:110,damage:{from:3,to:4},coolDownTime:.6,baseCritRate:5,baseCritDamage:1.5,images:p.createImage(x,[{x:0,y:0,w:80,h:80},{x:0,y:160,w:80,h:80},{x:0,y:320,w:80,h:80},{x:0,y:480,w:80,h:80},{x:0,y:640,w:80,h:80},{x:0,y:800,w:80,h:80}]),audio:E,upgrades:[{cost:70,fireRange:120,damage:{from:6,to:8},color:"#2CE85B",critRate:2,critDamage:.1},{cost:180,fireRange:130,damage:{from:10,to:14},color:"#2CE8B9",critRate:3,critDamage:.2},{cost:250,fireRange:140,damage:{from:18,to:25},color:"#2A62DB",critRate:5,critDamage:.2}]}},mapGrid:80,leveling:{wavesPerLevel:10,healthFactor:1.4,speedFactor:1.05,rewardFactor:1.2,waveGeneration:{minThreat:15,maxThreat:100,threatFactor:1.2}},enemyTypes:{wisp:{graphic:"wisp",baseHealth:24,baseSpeed:50,baseReward:5,baseCritResistance:5,levelFactors:{health:1.6,speed:1.1,critResistanceFactor:1.1}},bug:{graphic:"bug",baseHealth:18,baseSpeed:90,baseReward:4,baseCritResistance:2,levelFactors:{health:1.5,speed:1.2,critResistanceFactor:1.1}},slime:{color:"#8A2BE2",baseHealth:100,baseSpeed:30,baseReward:10,baseCritResistance:0,levelFactors:{health:1.8,speed:1,critResistanceFactor:1.05}},scout:{color:"#FFD700",baseHealth:10,baseSpeed:160,baseReward:3,baseCritResistance:10,levelFactors:{health:1.3,speed:1.05,critResistanceFactor:1.2}},boss:{graphic:"wisp",color:"black",baseHealth:400,baseSpeed:40,baseReward:100,baseCritResistance:50,levelFactors:{health:2.5,speed:1.1,critResistanceFactor:1.4}}},waveFragments:{line_of_wisps:{threat:15,details:{enemyType:"wisp",count:5,spacing:2,countFactor:1}},lone_slime:{threat:15,details:{enemyType:"slime",count:1,spacing:2,countFactor:1}},rush_of_bugs:{threat:25,details:{enemyType:"bug",count:4,spacing:2.5,countFactor:1.2}},pair_of_slimes:{threat:20,details:{enemyType:"slime",count:2,spacing:3,countFactor:1.2}},scout_rush:{threat:30,details:{enemyType:"scout",count:6,spacing:2,countFactor:2}},mixed_pair:{threat:45,details:[{enemyType:"wisp",count:5,spacing:2,countFactor:1.5},{enemyType:"bug",count:5,spacing:3,countFactor:1.5}]}},fillUpFragments:{fill_up_wisps:{threat:4,details:{enemyType:"wisp",count:2,spacing:2,countFactor:1.1}},fill_up_bugs:{threat:5,details:{enemyType:"bug",count:2,spacing:2.5,countFactor:1.2}},fill_up_scouts:{threat:6,details:{enemyType:"scout",count:3,spacing:3,countFactor:1.6}}},bossWaveTemplate:[{enemyType:"boss",count:1,spacing:0}]};class b{constructor(t){this.game=t,this.panel=null}init(){this.panel=document.createElement("div"),this.panel.style.position="absolute",this.panel.style.top="10px",this.panel.style.right="10px",this.panel.style.width="300px",this.panel.style.maxHeight="90vh",this.panel.style.overflowY="auto",this.panel.style.background="rgba(0,0,0,0.75)",this.panel.style.color="white",this.panel.style.padding="10px",this.panel.style.fontFamily="monospace",this.panel.style.fontSize="12px",this.panel.style.zIndex="1000",document.body.appendChild(this.panel),this.game.on("update",()=>this.update())}update(){if(!this.panel)return;const t=Object.values(this.game.mapEntities.list).filter(r=>r.type==="tower"),e=this.game.enemies.enemiesList,s=t.map(r=>`<li>LvL ${r.level+1} ${r.bullet} (${r.stats.kills} kills, ${r.stats.crits} crits)</li>`).join(""),i=e.map(r=>`<li>LvL ${r.level} ${r.enemyType} | HP: ${Math.round(r.health)}/${Math.round(r.maxHealth)}</li>`).join(""),o=(this.game.lastWaveTemplate||[]).map(r=>`<li>${r.name} - ${r.count}x Lvl ${r.level} ${r.enemyType} (${r.threat})</li>`).join("");this.panel.innerHTML=`
            <h3>Debug Info</h3>
            <p><strong>Game Mode:</strong> ${this.game.stat("mode")||"normal"}</p>
            <p><strong>Wave:</strong> ${this.game.stat("wave")}</p>
            <p><strong>Game Level:</strong> ${Math.floor(((this.game.waveCounter||1)-1)/n.leveling.wavesPerLevel)+1}</p>
            <p><strong>Wave Threat:</strong> ${Math.round(this.game.lastWaveCurrentThreat||0)} / ${Math.round(this.game.lastWaveMaxThreat||0)}</p>
            <hr>
            <h4>Towers (${t.length})</h4>
            <ul>${s||"<li>None</li>"}</ul>
            <hr>
            <h4>Enemies (${e.length})</h4>
            <ul>${i||"<li>None</li>"}</ul>
            <hr>
            <h4>Last Wave Composition</h4>
            <ul>${o||"<li>N/A</li>"}</ul>
        `}}const C="/tower-defense/assets/backlayer-CBCCWrSs.png",T="/tower-defense/assets/frontlayer-BiJAsHOn.png";class M{constructor(t,e){this.game=t,this.mapEntities=e,this.waypoints=[{x:0,y:120},{x:120,y:120},{x:120,y:360},{x:360,y:360},{x:360,y:200},{x:520,y:200},{x:520,y:520},{x:680,y:520},{x:680,y:280},{x:800,y:280},{x:920,y:280},{x:920,y:200},{x:1200,y:200}],this.images={background:p.createImage(C),frontLayer:p.createImage(T)},this.game.on("update",()=>this.update()),this.game.on("beforeDraw",()=>this.beforeDraw()),this.game.on("afterDraw",()=>this.afterDraw())}update(){}beforeDraw(){this.game.ctx.drawImage(this.images.background,0,0,this.game.canvas.width,this.game.canvas.height),this.grid(n.mapGrid)}afterDraw(){this.game.ctx.drawImage(this.images.frontLayer,0,0,this.game.canvas.width,this.game.canvas.height)}isValidTowerPlace(t,e){const s=this.distanceToPath(t,e);return s<=n.mapGrid/2||this.isTowerAtPosition(t,e)?!1:s<=Math.sqrt(2)*n.mapGrid}distanceToPath(t,e){let s=1/0;for(let i=0;i<this.waypoints.length-1;i++){const a=this.waypoints[i].x,o=this.waypoints[i].y,r=this.waypoints[i+1].x,m=this.waypoints[i+1].y,g=r-a,c=m-o,d=g*g+c*c;let l;if(d===0)l=this.game.distance(t,e,a,o);else{let u=((t-a)*g+(e-o)*c)/d;u=Math.max(0,Math.min(1,u));const y=a+u*g,f=o+u*c;l=this.game.distance(t,e,y,f)}s=Math.min(s,l)}return s}isTowerAtPosition(t,e){for(let s in this.mapEntities.list){let i=this.mapEntities.list[s];if(i.type==="tower"&&i.x===t&&i.y===e)return!0}return!1}grid(t){this.game.ctx.beginPath(),this.game.ctx.strokeStyle="#ffffff22",this.game.ctx.lineWidth=1;for(let e=t;e<this.game.canvas.height;e+=t)this.game.ctx.moveTo(0,e),this.game.ctx.lineTo(this.game.canvas.width,e);for(let e=t;e<this.game.canvas.width;e+=t)this.game.ctx.moveTo(e,0),this.game.ctx.lineTo(e,this.game.canvas.height);this.game.ctx.stroke()}}class I{constructor(t){this.game=t,this.list={},this.idCounter=0,this.game.on("update",e=>this.update(e)),this.game.on("beforeDraw",()=>this.draw())}add(t){const e=++this.idCounter;return t.id=e,this.list[e]=t,t}remove(t){this.list[t]&&delete this.list[t]}update(t){const e=Object.keys(this.list);for(const s of e){const i=this.list[s];i&&i.update(t)}}draw(){for(const t in this.list)this.game.drawList.push(this.list[t])}}class L{constructor(t){this.game=t,this.x=0,this.y=0,this.clicked=!1,this.game.canvas.addEventListener("mousemove",e=>this.onMove(e)),this.game.canvas.addEventListener("click",e=>this.onClick(e))}update(){this.clicked=!1}onMove(t){this.x=t.offsetX,this.y=t.offsetY}onClick(t){this.clicked=!0}isMouseOver(t,e,s){return Math.round(Math.sqrt(Math.pow(this.x-t,2)+Math.pow(this.y-e,2)))<=s}}class A{constructor(t,e,s,i,a){this.game=t,this.type="entity",this.x=e,this.y=s,this.r=i,this.color=a,this.zIndex=0}update(t){}draw(){this.game.drawCircle(this.x,this.y,this.r,this.color,!0)}remove(){this.game.mapEntities.remove(this.id)}}class B extends A{constructor(t,e){super(e,0,0,0,"transparent"),this.target=t,this.type="healthbar",this.zIndex=15}update(){if(this.target.deleted){this.game.mapEntities.remove(this.id);return}this.x=this.target.x,this.y=this.target.y}draw(){const t=this.target.health/this.target.maxHealth;if(t<1){const e={x:this.x-this.target.r,y:this.y-this.target.r-8,width:this.target.r*2,height:4};this.game.ctx.fillStyle="black",this.game.ctx.fillRect(e.x,e.y,e.width,e.height),this.game.ctx.fillStyle="green",this.game.ctx.fillRect(e.x,e.y,e.width*t,e.height)}}}class F extends A{constructor(t,e,s,i,a,o){super(o,e,s,0,"transparent"),this.text=t,this.isCrit=i,this.floatDirection=a||-1,this.type="damagenumber",this.zIndex=20,this.lifetime=1,this.opacity=1,this.verticalSpeed=30}update(t){if(this.lifetime-=t,this.lifetime<=0){this.game.mapEntities.remove(this.id);return}this.y+=this.verticalSpeed*this.floatDirection*t,this.opacity=this.lifetime}draw(){const t=this.game.ctx;t.save(),t.font=this.isCrit?"bold 18px sans-serif":"normal 14px sans-serif",t.textAlign="center",t.strokeStyle=`rgba(0, 0, 0, ${this.opacity})`,t.lineWidth=3,t.strokeText(this.text,this.x,this.y),t.fillStyle=this.isCrit?`rgba(255, 0, 0, ${this.opacity})`:`rgba(255, 255, 255, ${this.opacity})`,t.fillText(this.text,this.x,this.y),t.restore()}}const S="/tower-defense/assets/wisp-DEJtt0a3.png",O="/tower-defense/assets/bug-C3HbAPzA.png";class R extends A{constructor(t,e,s,i){var u,y,f,v;const a=n.enemyTypes[t];if(!a){console.error(`Enemy type "${t}" not found in settings.enemyTypes`);return}const o=a.color||"red";super(i.game,0,0,10,o),this.enemiesController=i,this.type="enemy",this.enemyType=t;const r=e>0?e-1:0,m=((u=a.levelFactors)==null?void 0:u.health)??n.leveling.healthFactor,g=((y=a.levelFactors)==null?void 0:y.speed)??n.leveling.speedFactor,c=((f=a.levelFactors)==null?void 0:f.reward)??n.leveling.rewardFactor,d=((v=a.levelFactors)==null?void 0:v.critResistanceFactor)??1.1;this.health=a.baseHealth*Math.pow(m,r),this.maxHealth=this.health,this.speed=a.baseSpeed*Math.pow(g,r),this.reward=Math.round(a.baseReward*Math.pow(c,r)),this.critResistance=a.baseCritResistance*Math.pow(d,r),this.graphicType=a.graphic,this.level=e,this.wave=s;const l=Math.round(Math.random()*40)-10;this.waypointIndex=0,this.waypoint={},this.shift=l,this.velocity={x:0,y:0},this.direction=0,this.frame=0,this.deleted=!1,this.zIndex=5,this.enemiesController.mapEntities.add(this),this.enemiesController.mapEntities.add(new B(this,this.enemiesController.game)),this.nextWaypoint()}nextWaypoint(){const t=this.enemiesController.map;this.waypoint.x||(this.waypoint={...t.waypoints[this.waypointIndex]},this.waypoint.x+=this.shift,this.waypoint.y+=this.shift,this.x=this.waypoint.x,this.y=this.waypoint.y);let e=this.waypoint.x,s=this.waypoint.y;return this.waypointIndex++,t.waypoints[this.waypointIndex]?(this.waypoint={...t.waypoints[this.waypointIndex]},this.waypoint.x+=this.shift,this.waypoint.y+=this.shift,this.velocity.x=this.x<this.waypoint.x?this.speed:-this.speed,e===this.waypoint.x&&(this.velocity.x=0),this.velocity.y=this.y<this.waypoint.y?this.speed:-this.speed,s===this.waypoint.y&&(this.velocity.y=0),this.velocity.y<0?this.direction=0:this.velocity.x>0?this.direction=1:this.velocity.y>0?this.direction=2:this.velocity.x<0&&(this.direction=3),!0):(this.done(),!1)}waypointReached(){return this.velocity.x>0&&this.x>=this.waypoint.x||this.velocity.x<0&&this.x<=this.waypoint.x||this.velocity.y>0&&this.y>=this.waypoint.y||this.velocity.y<0&&this.y<=this.waypoint.y}update(t){if(!this.deleted&&(this.waypointReached()?this.nextWaypoint():(this.x+=this.velocity.x*t,this.y+=this.velocity.y*t),this.graphicType)){const e=this.enemiesController.images[this.graphicType].sprites[this.direction];e.frames&&(this.frame=(this.frame+6*t)%e.frames.length)}}draw(){this.graphicType?p.drawAnimatedSprite(this.enemiesController.images[this.graphicType],this.direction,this.frame,Math.round(this.x),Math.round(this.y),40,40):this.enemiesController.game.drawCircle(this.x,this.y,this.r,this.color,!0)}damage(t,e=!1){if(!this.deleted){if(e||this.enemiesController.game.stat("showNormalDamage")){const s=this.velocity.y<0?1:-1;this.enemiesController.mapEntities.add(new F(t,this.x,this.y-this.r,e,s,this.enemiesController.game))}this.health-=t,this.health<=0&&this.die()}}die(){this.deleted||(this.health=0,this.deleted=!0,this.game.stat("coins",this.game.stat("coins")+this.reward,!0),this.enemiesController.remove(this))}done(){if(this.deleted)return;this.deleted=!0;let t=this.game.stat("life")-1;t<=0?this.game.setGameOver():this.game.stat("life",t,!0),this.enemiesController.remove(this)}}class k{constructor(t,e,s){this.game=t,this.map=e,this.mapEntities=s,this.images={wisp:p.createImage(S,[{x:0,y:0,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:40,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:80,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:120,w:20,h:20,frames:[0,40,80,120,160,200]}]),bug:p.createImage(O,[{x:0,y:0,w:20,h:20,frames:[0]},{x:40,y:0,w:20,h:20,frames:[40]},{x:80,y:0,w:20,h:20,frames:[80]},{x:120,y:0,w:20,h:20,frames:[120]}])},this.enemiesList=[]}create(t,e,s){const i=new R(t,e,s,this);return this.enemiesList.push(i),i}remove(t){if(!t)return;const e=this.enemiesList.indexOf(t);e>-1&&this.enemiesList.splice(e,1),this.mapEntities.remove(t.id)}}class D extends A{constructor(t,e,s,i){const a=n.towers[s];super(i.game,t,e,a.size,a.color),this.towersController=i,this.type="tower",this.bullet=s,this.fireRange=a.fireRange,this.damage=a.damage,this.cooldownTime=a.coolDownTime,this.level=0,this.audio=a.audio,this.critRate=a.baseCritRate,this.critDamage=a.baseCritDamage,this.stats={shoots:0,dmg:0,kills:0,crits:0},this.cooldownCounter=0,this.closestEnemy=!1,this.towersController.mapEntities.add(this)}upgrade(){const t=this.towersController.game,e=t.stat("coins"),s=n.towers[this.bullet].upgrades[this.level];s&&e>=s.cost&&(t.stat("coins",e-s.cost,!0),this.damage=s.damage,this.fireRange=s.fireRange,this.critRate+=s.critRate,this.critDamage+=s.critDamage,this.level++,this.color=s.color,t.modal.close())}update(t){const{game:e,mouse:s}=this.towersController;this.cooldownCounter+=t,this.closestEnemy&&(e.distance(this.x,this.y,this.closestEnemy.x,this.closestEnemy.y)>=this.fireRange+this.closestEnemy.r||this.closestEnemy.health<=0)&&(this.closestEnemy=!1),this.closestEnemy||(this.closestEnemy=this.findClosestEnemy()),this.closestEnemy&&this.cooldownCounter>=this.cooldownTime&&(this.shoot(this.closestEnemy),p.playAudio(this.audio),this.cooldownCounter=0),this.zIndex=s.isMouseOver(this.x,this.y,this.r)?20:10,e.stat("mode")!=="dropTower"&&s.clicked&&s.isMouseOver(this.x,this.y,this.r)&&this.towersController.openOptions(this)}findClosestEnemy(){const{game:t,enemies:e}=this.towersController;let s=null,i=-1,a=1/0;for(const o of e.enemiesList)if(t.distance(this.x,this.y,o.x,o.y)<=this.fireRange+o.r){if(o.waypointIndex>i)i=o.waypointIndex,s=o,a=o.waypoint?t.distance(o.x,o.y,o.waypoint.x,o.waypoint.y):1/0;else if(o.waypointIndex===i&&o.waypoint){const m=t.distance(o.x,o.y,o.waypoint.x,o.waypoint.y);m<a&&(s=o,a=m)}}return s}shoot(t){let e=Math.floor(Math.random()*(this.damage.to-this.damage.from+1))+this.damage.from,s=!1;const i=(this.critRate-t.critResistance)/100,a=Math.max(.05,Math.min(i,.75));Math.random()<a&&(e*=this.critDamage,this.stats.crits++,s=!0),e=Math.round(e),this.stats.shoots++,this.stats.dmg+=e,t.damage(e,s),t.deleted&&this.stats.kills++,this.cooldownCounter=this.cooldownTime,this.shootingAt=t,setTimeout(()=>{this.shootingAt=null},100)}draw(){const{game:t,mouse:e}=this.towersController;e.isMouseOver(this.x,this.y,this.r)&&t.stat("mode")!=="dropTower"&&t.drawCircle(this.x,this.y,this.fireRange,"rgba(0,0,255,0.2)",!0),p.drawSprite(n.towers[this.bullet].images,this.level,this.x,this.y-20,160,160),this.shootingAt&&(t.ctx.save(),t.ctx.beginPath(),t.ctx.strokeStyle=this.color,t.ctx.lineWidth=2,t.ctx.moveTo(this.x,this.y-50),t.ctx.lineTo(this.shootingAt.x,this.shootingAt.y),t.ctx.stroke(),t.ctx.restore())}}class N{constructor(t,e,s,i,a){this.game=t,this.map=e,this.mouse=s,this.mapEntities=i,this.enemies=a,this.game.on("update",()=>this.update()),this.game.on("beforeDraw",()=>this.draw())}update(){const t=this.gridPosition(),e=this.game.stat("selectedTowerType");this.game.stat("mode")==="dropTower"&&this.map.isValidTowerPlace(t.x,t.y)&&this.mouse.clicked&&(this.game.stat("mode",""),this.game.stat("coins",this.game.stat("coins")-n.towers[e].costs,!0),this.create(t.x,t.y,e))}draw(){if(this.game.stat("mode")==="dropTower"){const t=this.gridPosition(),e=this.game.stat("selectedTowerType"),s=this.map.isValidTowerPlace(t.x,t.y),i=this.map.isTowerAtPosition(t.x,t.y);s?(this.game.drawCircle(t.x,t.y,n.towers[e].fireRange,"rgba(0,0,255,0.2)",!0),p.drawSprite(n.towers[e].images,0,t.x,t.y-20,160,160)):i||(this.game.ctx.save(),this.game.ctx.filter="grayscale(100%)",p.drawSprite(n.towers[e].images,0,t.x,t.y-20,160,160),this.game.ctx.restore())}}create(t,e,s){return new D(t,e,s,this)}gridPosition(){const t=Math.floor(this.mouse.x/n.mapGrid)*n.mapGrid+n.mapGrid/2,e=Math.floor(this.mouse.y/n.mapGrid)*n.mapGrid+n.mapGrid/2;return{x:t,y:e}}openOptions(t){let e=`
            <div id="tower-stats-container">
                <h4>Current Stats (Level ${t.level+1})</h4>
                <table class="tower-stats">
                    <tr><td>Schaden:</td><td>${t.damage.from} - ${t.damage.to}</td></tr>
                    <tr><td>Reichweite:</td><td>${t.fireRange}</td></tr>
                    <tr><td>Feuerrate:</td><td>${t.cooldownTime}s</td></tr>
                    <tr><td>Crit Chance:</td><td>${t.critRate.toFixed(0)}%</td></tr>
                    <tr><td>Crit Schaden:</td><td>${t.critDamage*100}%</td></tr>
                </table>
                <h4>Lifetime Stats</h4>
                <table class="tower-stats">
                    <tr><td>Sch√ºsse:</td><td>${t.stats.shoots}</td></tr>
                    <tr><td>Crits:</td><td>${t.stats.crits} (${((t.stats.crits/t.stats.shoots||0)*100).toFixed(2)}%)</td></tr>
                    <tr><td>Kills:</td><td>${t.stats.kills}</td></tr>
                    <tr><td>Schaden:</td><td>${t.stats.dmg}</td></tr>
                </table>
            </div>
            <div id="tower-upgrade-container">
        `;const s=n.towers[t.bullet].upgrades[t.level];if(s?e+=`
                <h4>Upgrade auf Level ${t.level+2}</h4>
                <table class="tower-stats">
                    <tr><td>Kosten:</td><td>${s.cost} Coins</td></tr>
                    <tr><td>Schaden:</td><td>${s.damage.from} - ${s.damage.to}</td></tr>
                    <tr><td>Reichweite:</td><td>${s.fireRange}</td></tr>
                    <tr><td>Crit Chance:</td><td>+${s.critRate}%</td></tr>
                    <tr><td>Crit Schaden:</td><td>+${s.critDamage*100}%</td></tr>
                </table>
                <button id="tower-buy-upgrade-btn" class="btn">Upgrade Kaufen</button>
            `:e+="<h4>Max Level</h4>",e+="</div>",this.game.modal.open("Tower Options",e),s){const i=document.getElementById("tower-buy-upgrade-btn");if(i){i.onclick=()=>t.upgrade();const a=()=>{i.disabled=s.cost>this.game.stat("coins")};a();const o=()=>a();this.game.on("stat:coins",o),this.game.modal.onClose(()=>{this.game.off("stat:coins",o)})}}}}const G="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%3e%3cpath%20fill='%23ffffff'%20d='m2.344%2015.271l2%203.46a1%201%200%200%200%201.366.365l1.396-.806c.58.457%201.221.832%201.895%201.112V21a1%201%200%200%200%201%201h4a1%201%200%200%200%201-1v-1.598a8%208%200%200%200%201.895-1.112l1.396.806c.477.275%201.091.11%201.366-.365l2-3.46a1.004%201.004%200%200%200-.365-1.366l-1.372-.793a7.7%207.7%200%200%200-.002-2.224l1.372-.793c.476-.275.641-.89.365-1.366l-2-3.46a1%201%200%200%200-1.366-.365l-1.396.806A8%208%200%200%200%2015%204.598V3a1%201%200%200%200-1-1h-4a1%201%200%200%200-1%201v1.598A8%208%200%200%200%207.105%205.71L5.71%204.904a1%201%200%200%200-1.366.365l-2%203.46a1.004%201.004%200%200%200%20.365%201.366l1.372.793a7.7%207.7%200%200%200%200%202.224l-1.372.793c-.476.275-.641.89-.365%201.366M12%208c2.206%200%204%201.794%204%204s-1.794%204-4%204s-4-1.794-4-4s1.794-4%204-4'/%3e%3c/svg%3e";class P{constructor(){this.modalElement=null,this.titleElement=null,this.contentElement=null,this.closeButton=null,this.isOpen=!1,this.cleanupCallbacks=[],this.init()}init(){var t,e,s,i;if(this.modalElement=document.querySelector(".modal"),this.titleElement=(t=this.modalElement)==null?void 0:t.querySelector(".modal-title"),this.contentElement=(e=this.modalElement)==null?void 0:e.querySelector(".modal-content"),this.closeButton=(s=this.modalElement)==null?void 0:s.querySelector(".modal-close"),!this.modalElement){console.error("Modal element not found in DOM");return}(i=this.closeButton)==null||i.addEventListener("click",()=>this.close()),document.addEventListener("keydown",a=>{a.key==="Escape"&&this.isOpen&&this.close()}),this.handleOutsideClick=this.handleOutsideClick.bind(this)}handleOutsideClick(t){t.target.closest(".modal")||(t.stopPropagation(),this.close())}open(t,e){this.modalElement&&(this.isOpen||(this.setTitle(t),this.setContent(e),this.modalElement.classList.add("is--open"),this.isOpen=!0,requestAnimationFrame(()=>{document.addEventListener("click",this.handleOutsideClick)})))}close(){this.modalElement&&(this.modalElement.classList.remove("is--open"),this.isOpen=!1,document.removeEventListener("click",this.handleOutsideClick),this.cleanupCallbacks.forEach(t=>t()),this.cleanupCallbacks=[],this.setContent(""))}onClose(t){typeof t=="function"&&this.cleanupCallbacks.push(t)}setTitle(t){this.titleElement&&(this.titleElement.innerHTML=t)}setContent(t){this.contentElement&&(typeof t=="string"?this.contentElement.innerHTML=t:t instanceof HTMLElement&&(this.contentElement.innerHTML="",this.contentElement.appendChild(t)))}}class W{constructor(){p.init(this),this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.drawList=[],this.stats={},this._outputCache={},this.waveCounter=0,this.gameOver=!1,this.eventsList={},this.lastFrameTime=0,this.lastWaveTemplate=[],this.optionsIconImage=new Image,this.optionsIconImage.src=G,this.optionsIconPos={x:this.canvas.width-40,y:10,width:30,height:30},this.mapEntities=new I(this),this.map=new M(this,this.mapEntities),this.mouse=new L(this),this.enemies=new k(this,this.map,this.mapEntities),this.towers=new N(this,this.map,this.mouse,this.mapEntities,this.enemies),this.debug=new b(this),this.modal=new P,this.stat("soundEnabled",n.game.soundEnabled),this.stat("showNormalDamage",n.game.showNormalDamage),this.loadSettings(),document.addEventListener("click",t=>{if(this.gameOver){this.resetGame();return}t.target.matches("#buy-tower")&&(t.preventDefault(),this.buyTower("laser")),t.target.matches("#next-wave")&&(t.preventDefault(),this.nextWave())},!1),this.canvas.addEventListener("click",t=>{const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;s>=this.optionsIconPos.x&&s<=this.optionsIconPos.x+this.optionsIconPos.width&&i>=this.optionsIconPos.y&&i<=this.optionsIconPos.y+this.optionsIconPos.height&&this.openSettingsModal()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.stat("mode")==="dropTower"&&this.stat("mode","")}),this.output("#towerCosts",n.towers.laser.costs),this.output("#app-version","v0.0.2alpha"),this.resetGame(),window.requestAnimationFrame(this.draw.bind(this))}loadSettings(){const t=JSON.parse(localStorage.getItem("gameSettings"))||{};this.stat("soundEnabled",t.soundEnabled??n.game.soundEnabled),this.stat("showNormalDamage",t.showNormalDamage??n.game.showNormalDamage)}saveSettings(){const t={soundEnabled:this.stat("soundEnabled"),showNormalDamage:this.stat("showNormalDamage")};localStorage.setItem("gameSettings",JSON.stringify(t))}openSettingsModal(){const t=`
            <div>
                <label>
                    <input type="checkbox" id="setting-sound-enabled" ${this.stat("soundEnabled")?"checked":""}>
                    Sound aktivieren
                </label>
            </div>
            <div>
                <label>
                    <input type="checkbox" id="setting-show-normal-damage" ${this.stat("showNormalDamage")?"checked":""}>
                    Normale Schadenszahlen anzeigen (Crits immer anzeigen)
                </label>
            </div>
        `;this.modal.open("Settings",t),document.getElementById("setting-sound-enabled").addEventListener("change",e=>{this.stat("soundEnabled",e.target.checked),this.saveSettings()}),document.getElementById("setting-show-normal-damage").addEventListener("change",e=>{this.stat("showNormalDamage",e.target.checked),this.saveSettings()})}resetGame(){this.gameOver=!1,this.waveCounter=0,this.mapEntities.list={},this.enemies.enemiesList=[],this.stat("life",n.playerLifes,!0),this.stat("coins",n.coins,!0),this.stat("wave",0,!0),this.stat("mode","")}buyTower(t){this.stat("mode")!=="dropTower"&&this.stat("coins")>=n.towers[t].costs&&(this.stat("mode","dropTower"),this.stat("selectedTowerType",t))}update(t){if(this.gameOver){this.mouse.update();return}this.trigger("update",t),this.mouse.update()}draw(t){t||(t=0);const e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,window.requestAnimationFrame(this.draw.bind(this)),this.update(e),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.trigger("beforeDraw"),this.drawList=p.sortEntity(this.drawList);for(const s of this.drawList)s.draw();this.drawList=[],this.trigger("afterDraw"),this.optionsIconImage.complete&&this.ctx.drawImage(this.optionsIconImage,this.optionsIconPos.x,this.optionsIconPos.y,this.optionsIconPos.width,this.optionsIconPos.height),this.gameOver&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.font="48px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("Game Over",this.canvas.width/2,this.canvas.height/2-40),this.ctx.font="24px sans-serif",this.ctx.fillText("Klicken zum Neustarten",this.canvas.width/2,this.canvas.height/2+20))}setGameOver(){this.gameOver=!0}stat(t,e,s){if(e===void 0)return this.stats[t]||!1;const i=this.stats[t];return this.stats[t]=e,s!==void 0&&this.output(`#${t}`,e),i!==e&&this.trigger(`stat:${t}`,e),this}output(t,e){this._outputCache[t]||(this._outputCache[t]=document.querySelectorAll(t)),this._outputCache[t]&&this._outputCache[t].forEach(s=>{s.innerHTML=e})}distance(t,e,s,i){let a=t-s,o=e-i;return Math.sqrt(a*a+o*o)}intersectRect(t,e){return!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)}drawCircle(t,e,s,i,a=!0){this.ctx.beginPath(),this.ctx.arc(t,e,s,0,2*Math.PI),a===!0?(this.ctx.fillStyle=i,this.ctx.fill()):(this.ctx.strokeStyle=i,this.ctx.stroke())}nextWave(){if(Object.keys(this.mapEntities.list).length===0)return this;this.waveCounter++,this.stat("wave",this.waveCounter,!0);const t=Math.floor((this.waveCounter-1)/n.leveling.wavesPerLevel)+1,e=this.isBossWave()?this.generateBossWave(t):this.generateNormalWave(t);return this.lastWaveTemplate=e,this.spawnEnemiesFromTemplate(e),this}isBossWave(){return this.waveCounter>0&&this.waveCounter%n.leveling.wavesPerLevel===0}generateBossWave(t){return n.bossWaveTemplate.map(e=>({...e,level:t}))}generateNormalWave(t){const e=(this.waveCounter-1)%n.leveling.wavesPerLevel,s=Math.pow(e/(n.leveling.wavesPerLevel-1),1.7),{minThreat:i,maxThreat:a,threatFactor:o}=n.leveling.waveGeneration,r=Math.pow(o,t-1),m=i*r,g=a*r,c=m+(g-m)*s;let d=[],l=this.collectFragments(n.waveFragments,c,0,t,d);return l=this.collectFragments(n.fillUpFragments,c,l,t,d),this.lastWaveMaxThreat=c,this.lastWaveCurrentThreat=l,d}collectFragments(t,e,s,i,a){let o=0;const r=Object.keys(t);for(;o<100;){const m=r.filter(l=>t[l].threat<=e-s);if(m.length===0)break;const g=m[Math.floor(Math.random()*m.length)],c=t[g];let d=c.details;Array.isArray(d)||(d=[d]),d.forEach(l=>{a.push({...l,name:g,level:i,count:l.count+(i-1)*(l.countFactor||0),threat:c.threat})}),s+=c.threat,o++}return s}spawnEnemiesFromTemplate(t){let e=0;const s=20;t.forEach(i=>{var d;const a=n.enemyTypes[i.enemyType],o=((d=a.levelFactors)==null?void 0:d.speed)??n.leveling.speedFactor,r=i.level>0?i.level-1:0,m=a.baseSpeed*Math.pow(o,r),c=(i.spacing||1)*s/m*1e3;setTimeout(()=>{for(let l=0;l<i.count;l++)setTimeout(()=>{this.enemies.create(i.enemyType,i.level,this.waveCounter)},l*c)},e),e+=i.count*c})}on(t,e){return this.eventsList[t]||(this.eventsList[t]=[]),this.eventsList[t].push(e),this}off(t,e){if(!this.eventsList[t])return this;if(e){const s=this.eventsList[t].indexOf(e);s!==-1&&this.eventsList[t].splice(s,1)}else delete this.eventsList[t];return this}trigger(t,e){if(!this.eventsList[t])return this;for(let s=0;s<this.eventsList[t].length;s++)this.eventsList[t][s](e);return this}}document.addEventListener("DOMContentLoaded",()=>{new W});
