(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();let x=null;const c={init:n=>{x=n},sortEntity:n=>[...n].sort((t,e)=>t.zIndex-e.zIndex||t.y-e.y),createImage:(n,t=[])=>{const e=new Image;return e.src=n,e.sprites=t,e},drawSprite:(n,t,e,s,i,a)=>{let o=n.sprites[t];x.ctx.drawImage(n,o.x,o.y,i,a,e-o.w/2,s-o.h/2,o.w,o.h)},drawAnimatedSprite:(n,t,e,s,i,a,o)=>{let r=n.sprites[t];x.ctx.drawImage(n,r.frames[parseInt(e)],r.y,a,o,s-r.w/2,i-r.h/2,r.w,r.h)}},C="/tower-defense/assets/laser-DtsNZ3_M.png",b="data:audio/mpeg;base64,//OEZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAQAAALKAACAgICAgIUFBQUFBQ1NTU1NTVQUFBQUFBgYGBgYGBgd3d3d3d3iIiIiIiImpqampqarKysrKysrL29vb29vc3Nzc3Nzd3d3d3d3evr6+vr6+v7+/v7+/v9/f39/f3///////8AAAA5TEFNRTMuOTlyAm4AAAAALhcAABRGJAQ4TgAARgAACyjcZAMBAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAKAAAAAAA0gBQAAAABBy//OERAMJxhMTf8CcARKELhyngVAACBAIBGIAHIAGAoAH1pVkhv9r/9/+/0//+Y399re3///6MQ//+2/40IENv/////6f7q7qTG4o///////wkGhY8blyBY4SGQwmUIAGEAAAAce//////////5mg8b//M2///+uSZ3///4qEhJZnYzf/////+yz7EhUbiLCp///7N///gWCILHiLJiQsRCwqEgti4WAQCpOqB0B2CICEBjBS0HI5HA4HAzmPO7kB//O0ZBUcsdttj8PQgRoa+t8fgjoidigsGQP5BETcuIm/pvLiDoHv6ajTTTTTy4tNjM3dnrdI0TdaaDTTvukTBOEMJxhyzMrkaGRxOYXMDZHGNNBkFm7oMwlMiY8Dlk0TyJfOjoHgkCPHGLPHe4Awwdp8QEf01M2ggbrcmDQniirSEIQsrAYDjoRE9iUgbEAKBBrkmFpgrgNjgARMEhxogbvQpoIbJnjctuf1HC9/gFKAMoiA1B4BQwBhCADRwG24GIJAbzQB6lAH4RAZs2H4BuwMidAzIEDAgRQQdJ2Y3Q2udOs/4hB4B5CJCHCGBm/WQgEAQZAyKEGz3G3YOblCx57meagkEj0ZP7HzJZz1OIGDjGAIFoSALF99DOyun607P8wxl/s21m1P1PJjhB1PH/1fn+lf+7oyNcyYr1e6TFv4kmiUNCJh/A/Y5O+/0XeH//OkZAIWwMVvfu1wAQ0owuMRymAAhb9/CAAgaimc2Cfl8sbZ0Giwa9DWS3xEtNaTUAFQKFxmVZrTYCLveFBhnmxthxpbYmOMclEx+DTAwaCAKYNF5mM2jrOMTXE9uPz79DNrO4x6LTRgcNNj8zcSjMJrM7GozOGTQotMtBUzeiBwCl2ENgoFRGDDBYEMHiYwWCzFAPqO9SynCajNI1qBpTGZbhKpTZyy3S0tnHLLL8u///lulltLS2QWBoGqwaK4mDv89//1ChCYkACTSYmcAf/9Uqep7oAoAwBUBsC8ac04Wo0R+4PgHwQBMGgVhQLyaSUI/MiQeSPUkyTOoOq1rMJJVwp7Fe5yYpaaXI8K8MLFxE9HTGJr4aApQxMaLIrK//N0ZCIPeKNY92zDkg2AUtLeA8QSQDJhONEbkEwA12VVmBKXSmDG2QStLXrKqa8eZNme1aC5zYNYayZtONfPr1AgfAi24EbBxqjWAgkDgc2oCFCmnjgnB0XvQFE4b3Ee99ZF3qh4OnXHmiv+hv+0IVUMa05LZKLvJMn+XNYjhmF9FjHIvl9PYTET4ceImz3E2rgX/kw8n/AbFlr2M/9P+x/p//+qhBAC//OUZAMQ1RtNF2WCXg4oMr5eBhgGxACWy+rbaWv8LAKCA4AtQTTEGZnFgKliWKwS1i0TmVz9ZqtXN0aeaXXWzel8nL3cymdM06ZpVtHEIAHwZCCYE76rXWlvfVbVpc8yg7vyEUWE1ixB5gooGxUOJR/8vUoUpSlKWrXBPBY86hodCS9S2oZ6nEzOkKHg0zDUIenqA6xY9ktArQCjzjklAApUbzGdp7JHHFpnEIwEeeRO8sPGBnpe+Tn2CYJ52SlTqgaug+h9B9AMioVDLfIw12rqwAGOSQEGbl+WCCBhigAWIicnuHFmHevAqOhsImz+//N0ZB4MoNVRO2DDOg6I8ppewERUCgoTwtvBkGACSfMlOesAQFY3Sju5nUjl/mR/Yaw117apZ2HrP/scSz2+z9whVQqDQ4OiFeRLDwndrcFQ13JlioKr1u/9NpXUgW52yRD/Aa3ACmBNVZLIHKtCEEtZhOss38h/zOGAje6oRGIEWRY/1u6R3/9/5R6kUlyjbsKu1f/0VTgAAbSoy2XiMlcH8JrVx1dn//OEZBEQUK82O2smHg2hZrZeakTGALJn+hmSRa3nN77jT5Z0bN0N2TBBLLVTT7SVBXViTvQ9S3q2UAiD68Jw7HAwMRgBJORUDBTJd/3ja3/93kpMGNkiGVplQVcEwmLHkLcSEvFDRFpVQVUwWArtgNQVUHR508DX5YGndwieJTpU6RER78FaCwLrRJsP+AsyAdjpuvf/73OsD6MShYmRInUv//XqUpW/7shf9gZIEKcK7//6n+kcWkdS9buPDIC1//OEZAMOvUseBnRipo3BGjwQ0YRUQqB5hGmZr3GxrKGJjQQ5iIDwQDbs7jaqjE0cXQWM/W2VO2oDAj/O0oE/UHqZP3AmETjU7hT37FrG4+ywyxotjrNGU3EUCIzi5symG2at/Y6hgQMSGsM885aStY3KwNzLX63QwZ0LUtWthhSlIb//6kSGGrDHYGNaKMr1MO6Eha4KOHScmo1TZJTkWc1EGSEmVOwdnmdgwEBAT/oqM/09SoKB1+aCgl//W14I//N0ZAEKqIsUG3UjRg3QghgI5swIrJNxnJgoPhyFrB4syJlsAJgYE5g8C6YLBonBytzrPwzYS+ChMmzk60ZJrSCx9CgEylrS/nr+pVc1KdPaiZ6lOvYv/b6bP//0dzPT6K/9f19lLtOGysSMEC04edz4yo0ZNAwgTAbBXhhWsEzAocdTEtfP6o1FkpET4a+qz30f//R/VR///9P6NH//uqpMLfBQFZgT//N0ZAcLjB0IGXusAgsIKhAA5gAEF4GcaouejAUYmh6YgA+klKF3hONg5ND4HXA1Pg8F1ok6LWOsa0h3rMaNK+NySVEZ5tjGb1QudJVK91rb2gZ6x1S5FjV12ta3j6A7PJ9Z5LyCWcUUwaKgAwcRjpgaAZEMoffndk6SmLvr+hWr6On7F/qV7E7P9/r/u1+ncx9uv0/+mjAQPjMLdD4cuQp3MFEM2BLy//N0ZBELIBsEAHdJAg1IHhWK0wIAJjsQAwTuiKkQEsBiwkCYTO4pfU+qFUJe/RyWzbvIKQ5rmKoYSbLvS6kXtKLpHstMpxJFWNo65BusmpceNidUxeQiRpHX2pHIAngbj3tNzqNsYBcRYDYhrX1139dPv6/ra2nt9tn1erd8JWXu7OiNf9nuyjNqiN+t9O5f/VRVAGvAAzIuHk5xnakBx1+RcQLBB9jF//NkZBUHZBEMum8iABIYGggAy8YAc1v0r4/M6uz9Hp7NUf0+jf9ze1VlvYuGnWT/e7rdYtO3+ggiqaUsQ5EZWHNeMla+ijpPJehh9q3W1QAaYYoPoFkN3rmBzr6KW3LewYzOWvkNVNDAvaOFBDkgZqkNr0i456dqYu/FkWGp8GeBRX6lGIk85KLIoEFKgmmo//N0ZAwJiHkCAW8DAA8AOgwMwEYARBaOb5hwZBr4CEEyCSLQy/q51nKqft3L8EBXJCQVjB4S0FQEs80RT1bXnVuuhq6Gklr5KItGu+z/p//3/Xnf+0IzEpAwb/hCSnNzMICAnCxoESAfMoEdMq4rhNyFH6nrUBTyuwrKvh3Gd318r6Kv1W6Oe066Xf//orur+pUwUKVMQU1FMy45OS41VVVVVVVVVVVV//MUZBYAMAMkAARDAIBAAjQAEMABVVVV//MUZBYAAAB+AAAAAAAAAAAAAAAAVVVV",h={playerLifes:10,coins:180,towers:{laser:{costs:80,color:"#ffff03",size:20,fireRange:110,damage:{from:3,to:4},coolDownTime:.6,images:c.createImage(C,[{x:0,y:0,w:80,h:80},{x:0,y:160,w:80,h:80},{x:0,y:320,w:80,h:80},{x:0,y:480,w:80,h:80},{x:0,y:640,w:80,h:80},{x:0,y:800,w:80,h:80}]),audio:b,upgrades:[{cost:70,fireRange:120,damage:{from:6,to:8},color:"#2CE85B"},{cost:180,fireRange:130,damage:{from:10,to:14},color:"#2CE8B9"},{cost:250,fireRange:140,damage:{from:18,to:25},color:"#2A62DB"}]}},mapGrid:80,leveling:{wavesPerLevel:10,healthFactor:1.4,speedFactor:1.05,rewardFactor:1.2,waveGeneration:{minThreat:15,maxThreat:100,threatFactor:1.2}},enemyTypes:{wisp:{graphic:"wisp",baseHealth:24,baseSpeed:50,baseReward:5,levelFactors:{health:1.6,speed:1.1}},bug:{graphic:"bug",baseHealth:18,baseSpeed:90,baseReward:5,levelFactors:{health:1.5,speed:1.2}},slime:{color:"#8A2BE2",baseHealth:100,baseSpeed:30,baseReward:10,levelFactors:{health:1.8,speed:1}},scout:{color:"#FFD700",baseHealth:10,baseSpeed:160,baseReward:8,levelFactors:{health:1.3,speed:1.05}},boss:{graphic:"wisp",color:"black",baseHealth:400,baseSpeed:40,baseReward:100,levelFactors:{health:2.5,speed:1.3}}},waveFragments:{line_of_wisps:{threat:15,details:{enemyType:"wisp",count:5,coolDown:800,countFactor:1,delay:600}},lone_slime:{threat:15,details:{enemyType:"slime",count:1,coolDown:400,countFactor:1,delay:1500}},rush_of_bugs:{threat:25,details:{enemyType:"bug",count:4,coolDown:300,countFactor:1.2,delay:400}},pair_of_slimes:{threat:20,details:{enemyType:"slime",count:2,coolDown:2200,countFactor:1.2,delay:1500}},scout_rush:{threat:30,details:{enemyType:"scout",count:5,coolDown:200,countFactor:2,delay:400}},mixed_pair:{threat:40,details:[{enemyType:"wisp",count:5,coolDown:800,countFactor:1.5,delay:500},{enemyType:"bug",count:4,coolDown:500,countFactor:1.5,delay:500}]}},bossWaveTemplate:[{enemyType:"boss",count:1,coolDown:0}]};class L{constructor(t){this.game=t,this.panel=null}init(){this.panel=document.createElement("div"),this.panel.style.position="absolute",this.panel.style.top="10px",this.panel.style.right="10px",this.panel.style.width="300px",this.panel.style.maxHeight="90vh",this.panel.style.overflowY="auto",this.panel.style.background="rgba(0,0,0,0.75)",this.panel.style.color="white",this.panel.style.padding="10px",this.panel.style.fontFamily="monospace",this.panel.style.fontSize="12px",this.panel.style.zIndex="1000",document.body.appendChild(this.panel),this.game.on("update",()=>this.update())}update(){if(!this.panel)return;const t=Object.values(this.game.mapEntities.list).filter(r=>r.type==="tower"),e=this.game.enemies.enemiesList,s=t.map(r=>`<li>LvL ${r.level+1} ${r.bullet} (${r.stats.kills} kills)</li>`).join(""),i=e.map(r=>`<li>LvL ${r.level} ${r.enemyType} | HP: ${Math.round(r.health)}/${Math.round(r.maxHealth)}</li>`).join(""),o=(this.game.lastWaveTemplate||[]).map(r=>`<li>${r.count}x Lvl ${r.level} ${r.enemyType} (${r.threat})</li>`).join("");this.panel.innerHTML=`
            <h3>Debug Info</h3>
            <p><strong>Game Mode:</strong> ${this.game.stat("mode")||"normal"}</p>
            <p><strong>Wave:</strong> ${this.game.stat("wave")}</p>
            <p><strong>Game Level:</strong> ${Math.floor(((this.game.waveCounter||1)-1)/h.leveling.wavesPerLevel)+1}</p>
            <p><strong>Wave Threat:</strong> ${Math.round(this.game.lastWaveCurrentThreat||0)} / ${Math.round(this.game.lastWaveMaxThreat||0)}</p>
            <hr>
            <h4>Towers (${t.length})</h4>
            <ul>${s||"<li>None</li>"}</ul>
            <hr>
            <h4>Enemies (${e.length})</h4>
            <ul>${i||"<li>None</li>"}</ul>
            <hr>
            <h4>Last Wave Composition</h4>
            <ul>${o||"<li>N/A</li>"}</ul>
        `}}const B="/tower-defense/assets/background-C4SR3P4r.png";class I{constructor(t,e){this.game=t,this.mapEntities=e,this.waypoints=[{x:0,y:120},{x:120,y:120},{x:120,y:360},{x:360,y:360},{x:360,y:200},{x:520,y:200},{x:520,y:520},{x:680,y:520},{x:680,y:280},{x:800,y:280},{x:920,y:280},{x:920,y:200},{x:1200,y:200}],this.images={background:c.createImage(B)},this.game.on("update",()=>this.update()),this.game.on("beforeDraw",()=>this.draw())}update(){}draw(){this.game.ctx.drawImage(this.images.background,0,0,this.game.canvas.width,this.game.canvas.height),this.grid(h.mapGrid)}isValidTowerPlace(t,e,s){const i={left:t-h.towers[s].size,top:e-h.towers[s].size,right:t+h.towers[s].size,bottom:e+h.towers[s].size};for(let a=0;a<this.waypoints.length-1;a++){let o=Math.min(this.waypoints[a+1].x,this.waypoints[a].x),r=Math.min(this.waypoints[a+1].y,this.waypoints[a].y),l=Math.max(this.waypoints[a+1].x,this.waypoints[a].x),d=Math.max(this.waypoints[a+1].y,this.waypoints[a].y),p=l-o+80,u=d-r+80;o-=40,r-=40,l=o+p,d=r+u;let m={left:o,top:r,right:l,bottom:d};if(this.game.intersectRect(i,m))return!1}for(let a in this.mapEntities.list){let o=this.mapEntities.list[a];if(o.type==="tower"&&this.game.distance(o.x,o.y,t,e)<=h.towers[s].size*2)return!1}return!0}grid(t){this.game.ctx.beginPath(),this.game.ctx.strokeStyle="#ffffff22",this.game.ctx.lineWidth=1;for(let e=t;e<this.game.canvas.height;e+=t)this.game.ctx.moveTo(0,e),this.game.ctx.lineTo(this.game.canvas.width,e);for(let e=t;e<this.game.canvas.width;e+=t)this.game.ctx.moveTo(e,0),this.game.ctx.lineTo(e,this.game.canvas.height);this.game.ctx.stroke()}}class F{constructor(t){this.game=t,this.list={},this.idCounter=0,this.game.on("update",e=>this.update(e)),this.game.on("beforeDraw",()=>this.draw())}add(t){const e=++this.idCounter;return t.id=e,this.list[e]=t,t}remove(t){this.list[t]&&delete this.list[t]}update(t){const e=Object.keys(this.list);for(const s of e){const i=this.list[s];i&&i.update(t)}}draw(){for(const t in this.list)this.game.drawList.push(this.list[t])}}class O{constructor(t){this.game=t,this.x=0,this.y=0,this.clicked=!1,this.game.canvas.addEventListener("mousemove",e=>this.onMove(e)),this.game.canvas.addEventListener("click",e=>this.onClick(e))}update(){this.clicked=!1}onMove(t){this.x=t.offsetX,this.y=t.offsetY}onClick(t){this.clicked=!0}isMouseOver(t,e,s){return Math.round(Math.sqrt(Math.pow(this.x-t,2)+Math.pow(this.y-e,2)))<=s}}class E{constructor(t,e,s,i,a){this.game=t,this.type="entity",this.x=e,this.y=s,this.r=i,this.color=a,this.zIndex=0}update(t){}draw(){this.game.drawCircle(this.x,this.y,this.r,this.color,!0)}remove(){this.game.mapEntities.remove(this.id)}}const G="/tower-defense/assets/wisp-DEJtt0a3.png",k="/tower-defense/assets/bug-C3HbAPzA.png";class S extends E{constructor(t,e,s,i){var m,g,y;const a=h.enemyTypes[t];if(!a){console.error(`Enemy type "${t}" not found in settings.enemyTypes`);return}const o=a.color||"red";super(i.game,0,0,10,o),this.enemiesController=i,this.type="enemy",this.enemyType=t;const r=e>0?e-1:0,l=((m=a.levelFactors)==null?void 0:m.health)??h.leveling.healthFactor,d=((g=a.levelFactors)==null?void 0:g.speed)??h.leveling.speedFactor,p=((y=a.levelFactors)==null?void 0:y.reward)??h.leveling.rewardFactor;this.health=a.baseHealth*Math.pow(l,r),this.maxHealth=this.health,this.speed=a.baseSpeed*Math.pow(d,r),this.reward=Math.round(a.baseReward*Math.pow(p,r)),this.graphicType=a.graphic,this.level=e,this.wave=s;const u=Math.round(Math.random()*40)-10;this.waypointIndex=0,this.waypoint={},this.shift=u,this.velocity={x:0,y:0},this.direction=0,this.frame=0,this.deleted=!1,this.zIndex=5,this.enemiesController.mapEntities.add(this),this.nextWaypoint()}nextWaypoint(){const t=this.enemiesController.map;this.waypoint.x||(this.waypoint={...t.waypoints[this.waypointIndex]},this.waypoint.x+=this.shift,this.waypoint.y+=this.shift,this.x=this.waypoint.x,this.y=this.waypoint.y);let e=this.waypoint.x,s=this.waypoint.y;return this.waypointIndex++,t.waypoints[this.waypointIndex]?(this.waypoint={...t.waypoints[this.waypointIndex]},this.waypoint.x+=this.shift,this.waypoint.y+=this.shift,this.velocity.x=this.x<this.waypoint.x?this.speed:-this.speed,e===this.waypoint.x&&(this.velocity.x=0),this.velocity.y=this.y<this.waypoint.y?this.speed:-this.speed,s===this.waypoint.y&&(this.velocity.y=0),this.velocity.y<0?this.direction=0:this.velocity.x>0?this.direction=1:this.velocity.y>0?this.direction=2:this.velocity.x<0&&(this.direction=3),!0):(this.done(),!1)}waypointReached(){return this.velocity.x>0&&this.x>=this.waypoint.x||this.velocity.x<0&&this.x<=this.waypoint.x||this.velocity.y>0&&this.y>=this.waypoint.y||this.velocity.y<0&&this.y<=this.waypoint.y}update(t){if(!this.deleted&&(this.waypointReached()?this.nextWaypoint():(this.x+=this.velocity.x*t,this.y+=this.velocity.y*t),this.graphicType)){const e=this.enemiesController.images[this.graphicType].sprites[this.direction];e.frames&&(this.frame=(this.frame+6*t)%e.frames.length)}}draw(){this.graphicType?c.drawAnimatedSprite(this.enemiesController.images[this.graphicType],this.direction,this.frame,Math.round(this.x),Math.round(this.y),40,40):this.game.drawCircle(this.x,this.y,this.r,this.color,!0);const t=this.health/this.maxHealth;if(t<1){const e={x:this.x-this.r,y:this.y-this.r-5,width:this.r*2,height:3};this.game.ctx.fillStyle="black",this.game.ctx.fillRect(e.x,e.y,e.width,e.height),this.game.ctx.fillStyle="green",this.game.ctx.fillRect(e.x,e.y,e.width*t,e.height)}}damage(t){this.deleted||(this.health-=t,this.health<=0&&this.die())}die(){this.deleted||(this.health=0,this.deleted=!0,this.game.stat("coins",this.game.stat("coins")+this.reward,!0),this.enemiesController.remove(this))}done(){if(this.deleted)return;this.deleted=!0;let t=this.game.stat("life")-1;t<=0?this.game.setGameOver():this.game.stat("life",t,!0),this.enemiesController.remove(this)}}class R{constructor(t,e,s){this.game=t,this.map=e,this.mapEntities=s,this.images={wisp:c.createImage(G,[{x:0,y:0,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:40,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:80,w:20,h:20,frames:[0,40,80,120,160,200]},{x:0,y:120,w:20,h:20,frames:[0,40,80,120,160,200]}]),bug:c.createImage(k,[{x:0,y:0,w:20,h:20,frames:[0]},{x:40,y:0,w:20,h:20,frames:[0]},{x:80,y:0,w:20,h:20,frames:[0]},{x:120,y:0,w:20,h:20,frames:[0]}])},this.enemiesList=[]}create(t,e,s){const i=new S(t,e,s,this);return this.enemiesList.push(i),i}remove(t){if(!t)return;const e=this.enemiesList.indexOf(t);e>-1&&this.enemiesList.splice(e,1),this.mapEntities.remove(t.id)}}class N extends E{constructor(t,e,s,i){const a=h.towers[s];super(i.game,t,e,a.size,a.color),this.towersController=i,this.type="tower",this.bullet=s,this.fireRange=a.fireRange,this.damage=a.damage,this.cooldownTime=a.coolDownTime,this.level=0,this.audio=new Audio(a.audio),this.audio.volume=.3,this.stats={shoots:0,dmg:0,kills:0},this.cooldownCounter=0,this.closestEnemy=!1,this.towersController.mapEntities.add(this)}upgrade(){const t=this.towersController.game,e=t.stat("coins"),s=h.towers[this.bullet].upgrades[this.level];s&&e>=s.cost&&(t.stat("coins",e-s.cost,!0),this.damage=s.damage,this.fireRange=s.fireRange,this.level++,this.color=s.color,this.towersController.closeOptions())}update(t){const{game:e,mouse:s}=this.towersController;this.cooldownCounter+=t,this.closestEnemy&&(e.distance(this.x,this.y,this.closestEnemy.x,this.closestEnemy.y)>=this.fireRange+this.closestEnemy.r||this.closestEnemy.health<=0)&&(this.closestEnemy=!1),this.closestEnemy||(this.closestEnemy=this.findClosestEnemy()),this.closestEnemy&&this.cooldownCounter>=this.cooldownTime&&(this.shoot(this.closestEnemy),this.audio.play().catch(()=>{}),this.cooldownCounter=0),this.zIndex=s.isMouseOver(this.x,this.y,this.r)?20:10,e.stat("mode")!=="dropTower"&&s.clicked&&s.isMouseOver(this.x,this.y,this.r)&&this.towersController.openOptions(this)}findClosestEnemy(){const{game:t,enemies:e}=this.towersController;let s=null,i=-1,a=1/0;for(const o of e.enemiesList)if(t.distance(this.x,this.y,o.x,o.y)<=this.fireRange+o.r){if(o.waypointIndex>i)i=o.waypointIndex,s=o,a=o.waypoint?t.distance(o.x,o.y,o.waypoint.x,o.waypoint.y):1/0;else if(o.waypointIndex===i&&o.waypoint){const l=t.distance(o.x,o.y,o.waypoint.x,o.waypoint.y);l<a&&(s=o,a=l)}}return s}shoot(t){const e=Math.floor(Math.random()*(this.damage.to-this.damage.from+1))+this.damage.from;this.stats.shoots++,this.stats.dmg+=e,t.damage(e),t.deleted&&this.stats.kills++,this.cooldownCounter=this.cooldownTime,this.shootingAt=t,setTimeout(()=>{this.shootingAt=null},100)}draw(){const{game:t,mouse:e}=this.towersController;e.isMouseOver(this.x,this.y,this.r)&&t.stat("mode")!=="dropTower"&&t.drawCircle(this.x,this.y,this.fireRange,"rgba(0,0,255,0.2)",!0),c.drawSprite(h.towers[this.bullet].images,this.level,this.x,this.y-20,160,160),this.shootingAt&&(t.ctx.save(),t.ctx.beginPath(),t.ctx.strokeStyle=this.color,t.ctx.lineWidth=2,t.ctx.moveTo(this.x,this.y-50),t.ctx.lineTo(this.shootingAt.x,this.shootingAt.y),t.ctx.stroke(),t.ctx.restore())}}class D{constructor(t,e,s,i,a){this.game=t,this.map=e,this.mouse=s,this.mapEntities=i,this.enemies=a,this.optionsModal=null,this.optionsModal=document.querySelector(".modal-options"),this.game.on("update",()=>this.update()),this.game.on("afterDraw",()=>this.draw())}update(){const t=this.gridPosition(),e=this.game.stat("selectedTowerType");this.game.stat("mode")==="dropTower"&&this.map.isValidTowerPlace(t.x,t.y,e)&&this.mouse.clicked&&(this.game.stat("mode",""),this.game.stat("coins",this.game.stat("coins")-h.towers[e].costs,!0),this.create(t.x,t.y,e))}draw(){if(this.game.stat("mode")==="dropTower"){const t=this.gridPosition(),e=this.game.stat("selectedTowerType");this.map.isValidTowerPlace(t.x,t.y,e)?(this.game.drawCircle(t.x,t.y,h.towers[e].fireRange,"rgba(0,0,255,0.2)",!0),c.drawSprite(h.towers[e].images,0,t.x,t.y-20,160,160)):(this.game.ctx.save(),this.game.ctx.filter="grayscale(100%)",c.drawSprite(h.towers[e].images,0,t.x,t.y-20,160,160),this.game.ctx.restore())}}create(t,e,s){return new N(t,e,s,this)}gridPosition(){const t=Math.floor(this.mouse.x/h.mapGrid)*h.mapGrid+h.mapGrid/2,e=Math.floor(this.mouse.y/h.mapGrid)*h.mapGrid+h.mapGrid/2;return{x:t,y:e}}openOptions(t){this.game.output("#tower-position-x",t.x),this.game.output("#tower-position-y",t.y),this.game.output("#tower-level",t.level+1),this.game.output("#tower-fire-range",t.fireRange),this.game.output("#tower-cooldown-time",t.cooldownTime),this.game.output("#tower-damage-from",t.damage.from),this.game.output("#tower-damage-to",t.damage.to),this.game.output("#tower-stats-shoots",t.stats.shoots),this.game.output("#tower-stats-damage",t.stats.dmg),this.game.output("#tower-stats-kills",t.stats.kills);const e=h.towers[t.bullet].upgrades[t.level],s=this.optionsModal.querySelector(".tower-upgrade");if(e){s.classList.remove("is--hidden"),this.game.output(".tower-upgrade-level",t.level+2),this.game.output("#tower-upgrade-cost",e.cost),this.game.output("#tower-upgrade-fire-range",e.fireRange),this.game.output("#tower-upgrade-damage-from",e.damage.from),this.game.output("#tower-upgrade-damage-to",e.damage.to);const i=this.optionsModal.querySelector(".tower-buy-upgrade");i.onclick=()=>t.upgrade(),i.disabled=e.cost>this.game.stat("coins")}else s.classList.add("is--hidden");this.optionsModal.classList.add("is--open")}closeOptions(){this.optionsModal.classList.remove("is--open")}}class Q{constructor(){c.init(this),this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.drawList=[],this.stats={},this._outputCache={},this.waveCounter=0,this.gameOver=!1,this.eventsList={},this.lastFrameTime=0,this.lastWaveTemplate=[],this.mapEntities=new F(this),this.map=new I(this,this.mapEntities),this.mouse=new O(this),this.enemies=new R(this,this.map,this.mapEntities),this.towers=new D(this,this.map,this.mouse,this.mapEntities,this.enemies),this.debug=new L(this),document.addEventListener("click",t=>{if(this.gameOver){this.resetGame();return}t.target.matches("#buy-tower")&&(t.preventDefault(),this.buyTower("laser")),t.target.matches("#next-wave")&&(t.preventDefault(),this.nextWave()),t.target.matches(".modal-close")&&(t.preventDefault(),this.towers.closeOptions())},!1),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.stat("mode")==="dropTower"&&this.stat("mode","")}),this.output("#towerCosts",h.towers.laser.costs),this.output("#app-version","v0.0.2alpha"),this.resetGame(),window.requestAnimationFrame(this.draw.bind(this))}resetGame(){this.gameOver=!1,this.waveCounter=0,this.mapEntities.list={},this.enemies.enemiesList=[],this.stat("life",h.playerLifes,!0),this.stat("coins",h.coins,!0),this.stat("wave",0,!0),this.stat("mode","")}buyTower(t){this.stat("mode")!=="dropTower"&&this.stat("coins")>=h.towers[t].costs&&(this.stat("mode","dropTower"),this.stat("selectedTowerType",t))}update(t){if(this.gameOver){this.mouse.update();return}this.trigger("update",t),this.mouse.update()}draw(t){t||(t=0);const e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,window.requestAnimationFrame(this.draw.bind(this)),this.update(e),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.trigger("beforeDraw"),this.drawList=c.sortEntity(this.drawList);for(const s of this.drawList)s.draw();this.drawList=[],this.trigger("afterDraw"),this.gameOver&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.font="48px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("Game Over",this.canvas.width/2,this.canvas.height/2-40),this.ctx.font="24px sans-serif",this.ctx.fillText("Klicken zum Neustarten",this.canvas.width/2,this.canvas.height/2+20))}setGameOver(){this.gameOver=!0}stat(t,e,s){return e===void 0?this.stats[t]||!1:(this.stats[t]=e,s!==void 0&&this.output(`#${t}`,e),this)}output(t,e){this._outputCache[t]||(this._outputCache[t]=document.querySelectorAll(t)),this._outputCache[t]&&this._outputCache[t].forEach(s=>{s.innerHTML=e})}distance(t,e,s,i){let a=t-s,o=e-i;return Math.sqrt(a*a+o*o)}intersectRect(t,e){return!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)}drawCircle(t,e,s,i,a=!0){this.ctx.beginPath(),this.ctx.arc(t,e,s,0,2*Math.PI),a===!0?(this.ctx.fillStyle=i,this.ctx.fill()):(this.ctx.strokeStyle=i,this.ctx.stroke())}nextWave(){if(Object.keys(this.mapEntities.list).length===0)return this;this.waveCounter++,this.stat("wave",this.waveCounter,!0);const t=Math.floor((this.waveCounter-1)/h.leveling.wavesPerLevel)+1;let e=[];if(this.waveCounter>0&&this.waveCounter%h.leveling.wavesPerLevel===0)e=h.bossWaveTemplate.map(i=>({...i,level:t}));else{const i=(this.waveCounter-1)%h.leveling.wavesPerLevel,a=Math.pow(i/(h.leveling.wavesPerLevel-1),1.3),{minThreat:o,maxThreat:r,threatFactor:l}=h.leveling.waveGeneration,d=Math.pow(l,t-1),p=o*d,u=r*d,m=p+(u-p)*a;let g=0,y=0;const T=Object.keys(h.waveFragments);for(;y<100;){const f=T.filter(v=>h.waveFragments[v].threat<=m-g);if(f.length===0)break;const M=f[Math.floor(Math.random()*f.length)],A=h.waveFragments[M];let w=A.details;w.threat=A.threat,Array.isArray(w)||(w=[w]),w.forEach(v=>{e.push({...v,level:t})}),g+=A.threat,y++}this.lastWaveMaxThreat=m,this.lastWaveCurrentThreat=g}this.lastWaveTemplate=e;let s=0;return e.forEach(i=>{const a=i.count+(t-1)*(i.countFactor||0);setTimeout(()=>{for(let o=0;o<a;o++)setTimeout(()=>{this.enemies.create(i.enemyType,i.level,this.waveCounter)},o*(i.coolDown||500))},s),s+=i.delay||500}),this}on(t,e){return this.eventsList[t]||(this.eventsList[t]=[]),this.eventsList[t].push(e),this}off(t,e){if(!this.eventsList[t])return this;if(e){const s=this.eventsList[t].indexOf(e);s!==-1&&this.eventsList[t].splice(s,1)}else delete this.eventsList[t];return this}trigger(t,e){if(!this.eventsList[t])return this;for(let s=0;s<this.eventsList[t].length;s++)this.eventsList[t][s](e);return this}}document.addEventListener("DOMContentLoaded",()=>{new Q});
